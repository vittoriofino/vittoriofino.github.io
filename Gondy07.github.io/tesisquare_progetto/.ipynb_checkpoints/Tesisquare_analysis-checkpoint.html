<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ANALYSIS DATASET FROM TESISQUARE</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="Tesisquare_analysis_files/libs/clipboard/clipboard.min.js"></script>
<script src="Tesisquare_analysis_files/libs/quarto-html/quarto.js"></script>
<script src="Tesisquare_analysis_files/libs/quarto-html/popper.min.js"></script>
<script src="Tesisquare_analysis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Tesisquare_analysis_files/libs/quarto-html/anchor.min.js"></script>
<link href="Tesisquare_analysis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Tesisquare_analysis_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Tesisquare_analysis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Tesisquare_analysis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Tesisquare_analysis_files/libs/bootstrap/bootstrap-f758803aef84f450eeed3112be2e0b7f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ANALYSIS DATASET FROM TESISQUARE</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>first of all we are going to import every library that we’ll need during the project</p>
<div id="0ee3b7c4-934f-41c6-b21e-c5ad903be1bc" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">'''</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">Libraries versions</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">pandas: 2.2.3</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">numpy: 2.2.2</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">seaborn 0.13.2</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">matplotlib: 3.10.0</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">scikit-learn: 1.6.1</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">geopy: 2.4.1</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">tqdm: 4.67.1</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">requests: 2.32.3</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">folium: 0.19.4</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">'''</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder, StandardScaler</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score, classification_report</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, TransformerMixin</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> GradientBoostingRegressor</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geopy.geocoders <span class="im">import</span> Nominatim</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional, Tuple</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mpu</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geopy.distance <span class="im">import</span> geodesic</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="reading-and-checking-information-about-the-file" class="level2">
<h2 class="anchored" data-anchor-id="reading-and-checking-information-about-the-file">Reading and checking information about the file</h2>
<div id="b2d15bf1-f8b2-4d3d-be65-bc9c14a5e764" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Loading the dataset from a CSV file</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(<span class="st">"./delivery_data.csv"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Displaying dataset information (column types, non-null values, etc.)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>data.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 14554 entries, 0 to 14553
Data columns (total 15 columns):
 #   Column                Non-Null Count  Dtype  
---  ------                --------------  -----  
 0   Unnamed: 0            14554 non-null  int64  
 1   SERVICETYPE           14340 non-null  object 
 2   VEHICLETYPE           14331 non-null  object 
 3   DEPARTURE_COUNTRY     14554 non-null  object 
 4   DEPARTURE_ZIPCODE     14548 non-null  float64
 5   ARRIVAL_COUNTRY       14554 non-null  object 
 6   ARRIVAL_ZIPCODE       14554 non-null  int64  
 7   SHIPPING_DATE         14554 non-null  object 
 8   GROSS_WEIGHT_KG       14554 non-null  float64
 9   NET_WEIGHT_KG         14554 non-null  float64
 10  VOLUME_M3             14554 non-null  float64
 11  DECLARED_DISTANCE_KM  11577 non-null  float64
 12  ACTUAL_DELIVERY_DATE  14554 non-null  object 
 13  DELIVERY_TIME_HH      14554 non-null  int64  
 14  WDAY                  14554 non-null  int64  
dtypes: float64(5), int64(4), object(6)
memory usage: 1.7+ MB</code></pre>
</div>
</div>
<p>First let’s see how many rows and columns our dataset is made up of. Next we look at what kind of features there are and check if there are columns with missing data.</p>
<div id="25c43dac-b978-4a5c-9cd1-d27f98caedf7" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Displaying summary statistics of the dataset</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>data.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Unnamed: 0</th>
<th data-quarto-table-cell-role="th">DEPARTURE_ZIPCODE</th>
<th data-quarto-table-cell-role="th">ARRIVAL_ZIPCODE</th>
<th data-quarto-table-cell-role="th">GROSS_WEIGHT_KG</th>
<th data-quarto-table-cell-role="th">NET_WEIGHT_KG</th>
<th data-quarto-table-cell-role="th">VOLUME_M3</th>
<th data-quarto-table-cell-role="th">DECLARED_DISTANCE_KM</th>
<th data-quarto-table-cell-role="th">DELIVERY_TIME_HH</th>
<th data-quarto-table-cell-role="th">WDAY</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>14554.000000</td>
<td>14548.000000</td>
<td>14554.000000</td>
<td>14554.000000</td>
<td>14554.000000</td>
<td>14554.000000</td>
<td>11577.000000</td>
<td>14554.000000</td>
<td>14554.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>7277.500000</td>
<td>53013.321694</td>
<td>41699.581352</td>
<td>9.744264</td>
<td>8.002172</td>
<td>0.188305</td>
<td>352.646287</td>
<td>75.783633</td>
<td>1.730177</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>4201.522244</td>
<td>22512.124864</td>
<td>30222.758997</td>
<td>34.946037</td>
<td>31.718243</td>
<td>0.983377</td>
<td>166.566613</td>
<td>79.110044</td>
<td>1.507748</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>12.000000</td>
<td>10.000000</td>
<td>0.020000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.640000</td>
<td>-1344.000000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>3639.250000</td>
<td>56122.750000</td>
<td>17031.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.010000</td>
<td>223.850000</td>
<td>37.000000</td>
<td>0.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>7277.500000</td>
<td>63076.000000</td>
<td>35042.000000</td>
<td>1.370000</td>
<td>0.000000</td>
<td>0.010000</td>
<td>353.190000</td>
<td>71.000000</td>
<td>1.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>10915.750000</td>
<td>63076.000000</td>
<td>66020.000000</td>
<td>3.160000</td>
<td>2.280000</td>
<td>0.110000</td>
<td>468.690000</td>
<td>108.000000</td>
<td>3.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>14554.000000</td>
<td>99208.000000</td>
<td>99518.000000</td>
<td>1039.820000</td>
<td>948.840000</td>
<td>105.000000</td>
<td>1090.610000</td>
<td>1920.000000</td>
<td>6.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We check the file values and see what average value they have</p>
</section>
<section id="division-of-the-dataset-by-service-type" class="level2">
<h2 class="anchored" data-anchor-id="division-of-the-dataset-by-service-type">Division of the dataset by service type</h2>
<p>Looking at the dataset, we decided to split the dataset into different csv files to work with them individually</p>
<div id="439ff878-1f19-43c5-87ac-7c5937a7c86a" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the original CSV file</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'delivery_data.csv'</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Count rows with NaN in SERVICETYPE before removing them</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>nan_count <span class="op">=</span> df[<span class="st">'SERVICETYPE'</span>].isna().<span class="bu">sum</span>()</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove rows with NaN in SERVICETYPE</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">'SERVICETYPE'</span>])</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Count IT-US shipments before removing them</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>it_us_count <span class="op">=</span> (</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    ((df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>)) <span class="op">|</span> </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    ((df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>))</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>).<span class="bu">sum</span>()</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove shipments between IT and US in both directions</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>mask_it_us <span class="op">=</span> <span class="op">~</span>(</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    ((df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>)) <span class="op">|</span> </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    ((df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>))</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[mask_it_us]</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create three separate DataFrames based on SERVICETYPE</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Express Couriers</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>couriers_df <span class="op">=</span> df[df[<span class="st">'SERVICETYPE'</span>].isin([<span class="st">'Corriere espresso'</span>, <span class="st">'Corriere espresso resi'</span>])]</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Road Transport</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>road_df <span class="op">=</span> df[df[<span class="st">'SERVICETYPE'</span>] <span class="op">==</span> <span class="st">'Via gomma'</span>]</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. E-commerce</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>ecommerce_df <span class="op">=</span> df[df[<span class="st">'SERVICETYPE'</span>].isin([<span class="st">'E-commerce'</span>, <span class="st">'E-commerce Resi'</span>])]</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the DataFrames to separate CSV files</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>couriers_df.to_csv(<span class="st">'corrieri_data.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>road_df.to_csv(<span class="st">'gomma_data.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>ecommerce_df.to_csv(<span class="st">'ecommerce_data.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Print detailed statistics</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Statistics of the generated files:"</span>)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Rows in corrieri file: </span><span class="sc">{</span><span class="bu">len</span>(couriers_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rows in gomma transport file: </span><span class="sc">{</span><span class="bu">len</span>(road_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rows in e-commerce file: </span><span class="sc">{</span><span class="bu">len</span>(ecommerce_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Print removed rows count</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Rows removed due to NaN in SERVICETYPE: </span><span class="sc">{</span>nan_count<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rows removed due to IT-US shipments: </span><span class="sc">{</span>it_us_count<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Statistics of the generated files:

Rows in corrieri file: 2875
Rows in gomma transport file: 1863
Rows in e-commerce file: 9028

Rows removed due to NaN in SERVICETYPE: 214
Rows removed due to IT-US shipments: 574</code></pre>
</div>
</div>
</section>
<section id="lets-calculate-the-missing-values-for-the-distance-in-km" class="level2">
<h2 class="anchored" data-anchor-id="lets-calculate-the-missing-values-for-the-distance-in-km">Let’s calculate the missing values for the distance in km</h2>
<div id="fee524dc-e104-4167-a552-662ab21b75c5" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_osrm_distance(coord1, coord2):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Retrieves the driving distance (in km) and duration (in seconds) </span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">    between two coordinates using the OSRM API.</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> <span class="ss">f"http://router.project-osrm.org/route/v1/driving/</span><span class="sc">{</span>coord1[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>coord1[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">;</span><span class="sc">{</span>coord2[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>coord2[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(url)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> response.json()</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'routes'</span> <span class="kw">in</span> data <span class="kw">and</span> <span class="bu">len</span>(data[<span class="st">'routes'</span>]) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        distance_km <span class="op">=</span> data[<span class="st">'routes'</span>][<span class="dv">0</span>][<span class="st">'distance'</span>] <span class="op">/</span> <span class="dv">1000</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        duration_seconds <span class="op">=</span> data[<span class="st">'routes'</span>][<span class="dv">0</span>][<span class="st">'duration'</span>]</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">round</span>(distance_km, <span class="dv">2</span>), duration_seconds</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_zipcode_coordinates(zipcode: <span class="bu">str</span>, country) <span class="op">-&gt;</span> Optional[Tuple[<span class="bu">float</span>, <span class="bu">float</span>]]:</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns the latitude and longitude of a given ZIP code and country using the Nominatim geocoding API.</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        geolocator <span class="op">=</span> Nominatim(user_agent<span class="op">=</span><span class="st">"my_distance_calculator"</span>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        location <span class="op">=</span> geolocator.geocode(<span class="ss">f"</span><span class="sc">{</span>zipcode<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>country<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> location:</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (location.latitude, location.longitude)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_statistics(file_name, processed_rows, successful_lookups, failed_lookups):</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="co">    Prints statistics on the processed dataset.</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> successful_lookups <span class="op">+</span> failed_lookups</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    success_rate <span class="op">=</span> (successful_lookups <span class="op">/</span> total <span class="op">*</span> <span class="dv">100</span>) <span class="cf">if</span> total <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    failure_rate <span class="op">=</span> (failed_lookups <span class="op">/</span> total <span class="op">*</span> <span class="dv">100</span>) <span class="cf">if</span> total <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Statistics for </span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss"> after </span><span class="sc">{</span>processed_rows<span class="sc">}</span><span class="ss"> processed rows ---"</span>)</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Successful lookups: </span><span class="sc">{</span>successful_lookups<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>success_rate<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Failed lookups: </span><span class="sc">{</span>failed_lookups<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>failure_rate<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"------------------------------------------------</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_dataset(filename: <span class="bu">str</span>):</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a><span class="co">    Processes the dataset, calculates missing distances, and updates the CSV file.</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Processing </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the dataset</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> pd.read_csv(filename)</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter the DataFrame for rows where distance needs to be calculated</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>    filtered_data <span class="op">=</span> data[</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>        (data[<span class="st">'DECLARED_DISTANCE_KM'</span>].isna() <span class="op">|</span> (data[<span class="st">'DECLARED_DISTANCE_KM'</span>] <span class="op">==</span> <span class="dv">0</span>))</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Counters for statistics</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>    processed_rows <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    successful_lookups <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    failed_lookups <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterate through the filtered dataset</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index, row <span class="kw">in</span> tqdm(filtered_data.iterrows(), total<span class="op">=</span>filtered_data.shape[<span class="dv">0</span>], </span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>                          desc<span class="op">=</span><span class="ss">f"Processing </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span>):</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>        processed_rows <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>        departure_country <span class="op">=</span> row[<span class="st">'DEPARTURE_COUNTRY'</span>]</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>        departure_zipcode <span class="op">=</span> row[<span class="st">'DEPARTURE_ZIPCODE'</span>]</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>        arrival_zipcode <span class="op">=</span> row[<span class="st">'ARRIVAL_ZIPCODE'</span>]</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> departure_country <span class="kw">in</span> [<span class="st">"IT"</span>, <span class="st">"US"</span>]:</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>            departure_coords <span class="op">=</span> get_zipcode_coordinates(departure_zipcode, departure_country)</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>            arrival_coords <span class="op">=</span> get_zipcode_coordinates(arrival_zipcode, departure_country)</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>            failed_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> departure_coords <span class="kw">and</span> arrival_coords:</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>            distance <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>            error_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> error_count <span class="op">&lt;</span> <span class="dv">5</span>:</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>                distance, _ <span class="op">=</span> get_osrm_distance(departure_coords, arrival_coords)</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> distance <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Update the DataFrame and immediately save it to the same file</span></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>                    data.at[index, <span class="st">'DECLARED_DISTANCE_KM'</span>] <span class="op">=</span> distance</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>                    data.to_csv(filename, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>                    successful_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>                error_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>                time.sleep(<span class="dv">1</span>)  <span class="co"># Add a delay to avoid too many requests</span></span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> error_count <span class="op">==</span> <span class="dv">5</span>:</span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"Unable to find distance for row </span><span class="sc">{</span>index<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>                    failed_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>            failed_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print statistics every 100 rows</span></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> processed_rows <span class="op">%</span> <span class="dv">100</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>            print_statistics(filename, processed_rows, successful_lookups, failed_lookups)</span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print final statistics</span></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>    print_statistics(filename, processed_rows, successful_lookups, failed_lookups)</span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> processed_rows, successful_lookups, failed_lookups</span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a><span class="co">    Main function to process multiple dataset files and calculate distances.</span></span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of files to process</span></span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> [</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>        <span class="st">"gomma_data.csv"</span>,</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>        <span class="st">"corrieri_data.csv"</span>,</span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ecommerce_data.csv"</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>    total_stats <span class="op">=</span> {</span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>        <span class="st">"processed"</span>: <span class="dv">0</span>,</span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>        <span class="st">"successful"</span>: <span class="dv">0</span>,</span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>        <span class="st">"failed"</span>: <span class="dv">0</span></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each file</span></span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> filename <span class="kw">in</span> files:</span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>            processed, successful, failed <span class="op">=</span> process_dataset(filename)</span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>            total_stats[<span class="st">"processed"</span>] <span class="op">+=</span> processed</span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>            total_stats[<span class="st">"successful"</span>] <span class="op">+=</span> successful</span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>            total_stats[<span class="st">"failed"</span>] <span class="op">+=</span> failed</span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Processing completed for </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"File not found: </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error processing </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print total statistics</span></span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Total Statistics ==="</span>)</span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total processed rows: </span><span class="sc">{</span>total_stats[<span class="st">'processed'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total successful lookups: </span><span class="sc">{</span>total_stats[<span class="st">'successful'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total failed lookups: </span><span class="sc">{</span>total_stats[<span class="st">'failed'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"========================="</span>)</span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Processing gomma_data.csv...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing gomma_data.csv: 0it [00:00, ?it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Statistics for gomma_data.csv after 0 processed rows ---
Successful lookups: 0 (0.00%)
Failed lookups: 0 (0.00%)
------------------------------------------------

Processing completed for gomma_data.csv

Processing corrieri_data.csv...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing corrieri_data.csv: 0it [00:00, ?it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Statistics for corrieri_data.csv after 0 processed rows ---
Successful lookups: 0 (0.00%)
Failed lookups: 0 (0.00%)
------------------------------------------------

Processing completed for corrieri_data.csv

Processing ecommerce_data.csv...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   0%|          | 1/305 [00:06&lt;34:42,  6.85s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 28</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   1%|          | 2/305 [00:14&lt;35:51,  7.10s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 84</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   1%|          | 3/305 [00:21&lt;35:15,  7.00s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 91</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   1%|▏         | 4/305 [00:28&lt;35:13,  7.02s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 314</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   2%|▏         | 5/305 [00:34&lt;34:55,  6.98s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 341</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   2%|▏         | 6/305 [00:42&lt;34:59,  7.02s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 357</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   2%|▏         | 7/305 [00:49&lt;34:53,  7.02s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 358</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   3%|▎         | 9/305 [00:59&lt;31:03,  6.30s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 477</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   3%|▎         | 10/305 [01:06&lt;31:51,  6.48s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 478</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   4%|▎         | 11/305 [01:13&lt;32:36,  6.66s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 479</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   4%|▍         | 12/305 [01:20&lt;33:12,  6.80s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 515</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   4%|▍         | 13/305 [01:27&lt;33:09,  6.81s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 525</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   5%|▍         | 14/305 [01:34&lt;33:48,  6.97s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 540</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   5%|▍         | 15/305 [01:42&lt;35:31,  7.35s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 544</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   5%|▌         | 16/305 [01:49&lt;34:37,  7.19s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 1055</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   6%|▌         | 17/305 [01:56&lt;33:56,  7.07s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 1219</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   6%|▌         | 18/305 [02:03&lt;33:31,  7.01s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 1706</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   6%|▌         | 19/305 [02:11&lt;35:00,  7.34s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 1747</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   7%|▋         | 20/305 [02:18&lt;34:23,  7.24s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 2279</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   7%|▋         | 21/305 [02:25&lt;34:48,  7.35s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 2322</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   7%|▋         | 22/305 [02:32&lt;34:06,  7.23s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 2429</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   8%|▊         | 23/305 [02:40&lt;33:52,  7.21s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 2486</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   8%|▊         | 24/305 [02:46&lt;33:13,  7.10s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 3220</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   8%|▊         | 25/305 [02:53&lt;32:52,  7.04s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 3238</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   9%|▊         | 26/305 [03:00&lt;32:47,  7.05s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 3265</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   9%|▉         | 27/305 [03:07&lt;32:35,  7.03s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 3270</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:   9%|▉         | 28/305 [03:15&lt;33:37,  7.28s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 3709</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  10%|▉         | 29/305 [03:22&lt;33:02,  7.18s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 3720</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  10%|▉         | 30/305 [03:29&lt;32:26,  7.08s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 3785</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  10%|█         | 31/305 [03:36&lt;32:16,  7.07s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 3791</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  10%|█         | 32/305 [03:43&lt;31:54,  7.01s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 4066</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  11%|█         | 33/305 [03:50&lt;31:29,  6.95s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 4117</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  11%|█         | 34/305 [03:57&lt;31:26,  6.96s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 4121</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  11%|█▏        | 35/305 [04:04&lt;31:29,  7.00s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 4144</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  12%|█▏        | 36/305 [04:11&lt;31:08,  6.95s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 4163</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  12%|█▏        | 37/305 [04:18&lt;31:13,  6.99s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 4593</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  12%|█▏        | 38/305 [04:25&lt;31:09,  7.00s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 4636</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  13%|█▎        | 39/305 [04:32&lt;30:48,  6.95s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 5060</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  13%|█▎        | 40/305 [04:38&lt;30:27,  6.90s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 5083</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  13%|█▎        | 41/305 [04:45&lt;30:11,  6.86s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 5103</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  14%|█▍        | 42/305 [04:52&lt;30:00,  6.85s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 5133</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  14%|█▍        | 43/305 [04:59&lt;30:18,  6.94s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 5212</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  14%|█▍        | 44/305 [05:06&lt;30:10,  6.94s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 5618</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  15%|█▍        | 45/305 [05:13&lt;29:59,  6.92s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 5630</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  15%|█▌        | 46/305 [05:20&lt;30:03,  6.96s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 5654</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  15%|█▌        | 47/305 [05:27&lt;30:14,  7.03s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 5668</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  16%|█▌        | 48/305 [05:34&lt;30:01,  7.01s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 5942</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  16%|█▌        | 49/305 [05:41&lt;29:43,  6.97s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 6181</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  16%|█▋        | 50/305 [05:48&lt;29:24,  6.92s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 6237</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  17%|█▋        | 51/305 [05:55&lt;29:15,  6.91s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 6243</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  17%|█▋        | 52/305 [06:02&lt;29:12,  6.93s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 6504</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  17%|█▋        | 53/305 [06:09&lt;29:15,  6.96s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 6524</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  18%|█▊        | 54/305 [06:16&lt;29:20,  7.01s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 6539</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  18%|█▊        | 55/305 [06:23&lt;29:04,  6.98s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 6546</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  18%|█▊        | 56/305 [06:30&lt;28:58,  6.98s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 6549</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  19%|█▊        | 57/305 [06:37&lt;29:19,  7.09s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 6609</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  19%|█▉        | 58/305 [06:44&lt;28:51,  7.01s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 6651</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  19%|█▉        | 59/305 [06:51&lt;28:56,  7.06s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 6652</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  20%|█▉        | 60/305 [06:58&lt;28:43,  7.03s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 6654</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  20%|██        | 61/305 [07:05&lt;28:27,  7.00s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 6981</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  20%|██        | 62/305 [07:12&lt;28:20,  7.00s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7030</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  21%|██        | 63/305 [07:19&lt;28:07,  6.97s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7064</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  21%|██        | 64/305 [07:26&lt;27:53,  6.94s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7103</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  21%|██▏       | 65/305 [07:33&lt;27:52,  6.97s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7151</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  22%|██▏       | 66/305 [07:40&lt;27:39,  6.94s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7188</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  22%|██▏       | 67/305 [07:47&lt;27:40,  6.98s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7512</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  22%|██▏       | 68/305 [07:54&lt;27:31,  6.97s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7702</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  23%|██▎       | 69/305 [08:01&lt;27:35,  7.01s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7747</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  23%|██▎       | 70/305 [08:08&lt;27:26,  7.01s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7749</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  23%|██▎       | 71/305 [08:15&lt;27:12,  6.98s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7769</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  24%|██▎       | 72/305 [08:23&lt;28:36,  7.37s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7771</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  24%|██▍       | 73/305 [08:30&lt;27:56,  7.23s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7782</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  24%|██▍       | 74/305 [08:37&lt;27:20,  7.10s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7940</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  25%|██▍       | 75/305 [08:44&lt;27:00,  7.04s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7943</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  25%|██▍       | 76/305 [08:50&lt;26:36,  6.97s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 7965</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  25%|██▌       | 77/305 [08:57&lt;26:17,  6.92s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 8184</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  26%|██▌       | 78/305 [09:04&lt;26:06,  6.90s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 8206</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  26%|██▌       | 79/305 [09:11&lt;25:51,  6.86s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 8211</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  26%|██▌       | 80/305 [09:18&lt;25:40,  6.85s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 8269</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  27%|██▋       | 81/305 [09:24&lt;25:30,  6.83s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 8543</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  27%|██▋       | 82/305 [09:32&lt;26:30,  7.13s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 8559</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  33%|███▎      | 100/305 [10:09&lt;06:52,  2.01s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Statistics for ecommerce_data.csv after 100 processed rows ---
Successful lookups: 18 (18.00%)
Failed lookups: 82 (82.00%)
------------------------------------------------
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  33%|███▎      | 102/305 [10:18&lt;11:58,  3.54s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 8621</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  37%|███▋      | 113/305 [10:46&lt;11:34,  3.62s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 8634</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  41%|████▏     | 126/305 [11:17&lt;10:42,  3.59s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 8648</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  59%|█████▉    | 180/305 [13:13&lt;07:30,  3.60s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 8710</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  66%|██████▌   | 200/305 [13:54&lt;03:30,  2.00s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Statistics for ecommerce_data.csv after 200 processed rows ---
Successful lookups: 114 (57.00%)
Failed lookups: 86 (43.00%)
------------------------------------------------
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  77%|███████▋  | 235/305 [15:11&lt;04:09,  3.56s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 8768</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  90%|████████▉ | 274/305 [16:36&lt;01:50,  3.58s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 8988</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  95%|█████████▍| 289/305 [17:11&lt;00:58,  3.68s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 9008</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  98%|█████████▊| 299/305 [17:36&lt;00:21,  3.57s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Unable to find distance for row 9019</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv:  98%|█████████▊| 300/305 [17:38&lt;00:15,  3.00s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Statistics for ecommerce_data.csv after 300 processed rows ---
Successful lookups: 210 (70.00%)
Failed lookups: 90 (30.00%)
------------------------------------------------
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing ecommerce_data.csv: 100%|██████████| 305/305 [17:48&lt;00:00,  3.50s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Statistics for ecommerce_data.csv after 305 processed rows ---
Successful lookups: 215 (70.49%)
Failed lookups: 90 (29.51%)
------------------------------------------------

Processing completed for ecommerce_data.csv

=== Total Statistics ===
Total processed rows: 305
Total successful lookups: 215
Total failed lookups: 90
=========================</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
</section>
<section id="merging-the-csv-files" class="level2">
<h2 class="anchored" data-anchor-id="merging-the-csv-files">Merging the csv files</h2>
<p>We merge the 3 csv files created based on the service, keeping the blank rows that were in the initial dataset</p>
<div id="63167876-a0c2-4041-bcff-b4638216e808" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_delivery_data(main_file, additional_files):</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Data cleaning and integration procedure for delivery data</span></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a><span class="co">    main_file (str): Path to the main CSV file</span></span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a><span class="co">    additional_files (list): List of paths to additional CSV files</span></span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame: DataFrame with integrated kilometers and corrected times</span></span>
<span id="cb200-12"><a href="#cb200-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb200-13"><a href="#cb200-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Load the main dataset</span></span>
<span id="cb200-14"><a href="#cb200-14" aria-hidden="true" tabindex="-1"></a>    delivery_df <span class="op">=</span> pd.read_csv(main_file)</span>
<span id="cb200-15"><a href="#cb200-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-16"><a href="#cb200-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Create a copy of the dataset</span></span>
<span id="cb200-17"><a href="#cb200-17" aria-hidden="true" tabindex="-1"></a>    integrated_km_df <span class="op">=</span> delivery_df.copy()</span>
<span id="cb200-18"><a href="#cb200-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-19"><a href="#cb200-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Try to fill in missing kilometers from other datasets</span></span>
<span id="cb200-20"><a href="#cb200-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> additional_file <span class="kw">in</span> additional_files:</span>
<span id="cb200-21"><a href="#cb200-21" aria-hidden="true" tabindex="-1"></a>        additional_df <span class="op">=</span> pd.read_csv(additional_file)</span>
<span id="cb200-22"><a href="#cb200-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb200-23"><a href="#cb200-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find rows with missing kilometers</span></span>
<span id="cb200-24"><a href="#cb200-24" aria-hidden="true" tabindex="-1"></a>        missing_km_mask <span class="op">=</span> integrated_km_df[<span class="st">'DECLARED_DISTANCE_KM'</span>].isna()</span>
<span id="cb200-25"><a href="#cb200-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb200-26"><a href="#cb200-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try to integrate kilometers from the other dataset</span></span>
<span id="cb200-27"><a href="#cb200-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> index, row <span class="kw">in</span> integrated_km_df[missing_km_mask].iterrows():</span>
<span id="cb200-28"><a href="#cb200-28" aria-hidden="true" tabindex="-1"></a>            match <span class="op">=</span> additional_df[</span>
<span id="cb200-29"><a href="#cb200-29" aria-hidden="true" tabindex="-1"></a>                (additional_df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> row[<span class="st">'DEPARTURE_COUNTRY'</span>]) <span class="op">&amp;</span> </span>
<span id="cb200-30"><a href="#cb200-30" aria-hidden="true" tabindex="-1"></a>                (additional_df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> row[<span class="st">'ARRIVAL_COUNTRY'</span>])</span>
<span id="cb200-31"><a href="#cb200-31" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb200-32"><a href="#cb200-32" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb200-33"><a href="#cb200-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> match.empty:</span>
<span id="cb200-34"><a href="#cb200-34" aria-hidden="true" tabindex="-1"></a>                mode_value <span class="op">=</span> match[<span class="st">'DECLARED_DISTANCE_KM'</span>].mode()</span>
<span id="cb200-35"><a href="#cb200-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> mode_value.empty:</span>
<span id="cb200-36"><a href="#cb200-36" aria-hidden="true" tabindex="-1"></a>                    integrated_km_df.at[index, <span class="st">'DECLARED_DISTANCE_KM'</span>] <span class="op">=</span> mode_value.iloc[<span class="dv">0</span>]</span>
<span id="cb200-37"><a href="#cb200-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-38"><a href="#cb200-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Handle negative travel times</span></span>
<span id="cb200-39"><a href="#cb200-39" aria-hidden="true" tabindex="-1"></a>    negative_travel_time_mask <span class="op">=</span> integrated_km_df[<span class="st">'DELIVERY_TIME_HH'</span>] <span class="op">&lt;</span> <span class="dv">0</span></span>
<span id="cb200-40"><a href="#cb200-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-41"><a href="#cb200-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert negative times to positive and swap the dates</span></span>
<span id="cb200-42"><a href="#cb200-42" aria-hidden="true" tabindex="-1"></a>    integrated_km_df.loc[negative_travel_time_mask, <span class="st">'DELIVERY_TIME_HH'</span>] <span class="op">=</span> <span class="bu">abs</span>(integrated_km_df.loc[negative_travel_time_mask, <span class="st">'DELIVERY_TIME_HH'</span>])</span>
<span id="cb200-43"><a href="#cb200-43" aria-hidden="true" tabindex="-1"></a>    integrated_km_df.loc[negative_travel_time_mask, [<span class="st">'SHIPPING_DATE'</span>, <span class="st">'ACTUAL_DELIVERY_DATE'</span>]] <span class="op">=</span> <span class="op">\</span></span>
<span id="cb200-44"><a href="#cb200-44" aria-hidden="true" tabindex="-1"></a>        integrated_km_df.loc[negative_travel_time_mask, [<span class="st">'ACTUAL_DELIVERY_DATE'</span>, <span class="st">'SHIPPING_DATE'</span>]].values</span>
<span id="cb200-45"><a href="#cb200-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-46"><a href="#cb200-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> integrated_km_df</span>
<span id="cb200-47"><a href="#cb200-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-48"><a href="#cb200-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage</span></span>
<span id="cb200-49"><a href="#cb200-49" aria-hidden="true" tabindex="-1"></a>main_file <span class="op">=</span> <span class="st">'delivery_data.csv'</span></span>
<span id="cb200-50"><a href="#cb200-50" aria-hidden="true" tabindex="-1"></a>additional_files <span class="op">=</span> [<span class="st">'gomma_data.csv'</span>, <span class="st">'ecommerce_data.csv'</span>, <span class="st">'corrieri_data.csv'</span>]</span>
<span id="cb200-51"><a href="#cb200-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-52"><a href="#cb200-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute the data cleaning</span></span>
<span id="cb200-53"><a href="#cb200-53" aria-hidden="true" tabindex="-1"></a>cleaned_data <span class="op">=</span> clean_delivery_data(main_file, additional_files)</span>
<span id="cb200-54"><a href="#cb200-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-55"><a href="#cb200-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the cleaned dataset</span></span>
<span id="cb200-56"><a href="#cb200-56" aria-hidden="true" tabindex="-1"></a>cleaned_data.to_csv(<span class="st">'delivery_data_clear.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb200-57"><a href="#cb200-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-58"><a href="#cb200-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Data cleaning completed."</span>)</span>
<span id="cb200-59"><a href="#cb200-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cleaned dataset saved as 'delivery_data_clear.csv'"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data cleaning completed.
Cleaned dataset saved as 'delivery_data_clear.csv'</code></pre>
</div>
</div>
</section>
<section id="completed-ordering-the-dataset-in-2-steps" class="level2">
<h2 class="anchored" data-anchor-id="completed-ordering-the-dataset-in-2-steps">Completed ordering the dataset in 2 steps</h2>
<section id="added-missing-distances-km" class="level3">
<h3 class="anchored" data-anchor-id="added-missing-distances-km">1) Added missing distances Km</h3>
<div id="417cd8f7-9763-4d65-8c16-7d8b6f662391" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_osrm_distance(coord1, coord2):</span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Retrieves the driving distance (in km) and duration (in seconds) </span></span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a><span class="co">    between two coordinates using the OSRM API.</span></span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> <span class="ss">f"http://router.project-osrm.org/route/v1/driving/</span><span class="sc">{</span>coord1[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>coord1[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">;</span><span class="sc">{</span>coord2[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>coord2[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(url)</span>
<span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> response.json()</span>
<span id="cb202-10"><a href="#cb202-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb202-11"><a href="#cb202-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'routes'</span> <span class="kw">in</span> data <span class="kw">and</span> <span class="bu">len</span>(data[<span class="st">'routes'</span>]) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb202-12"><a href="#cb202-12" aria-hidden="true" tabindex="-1"></a>        distance_km <span class="op">=</span> data[<span class="st">'routes'</span>][<span class="dv">0</span>][<span class="st">'distance'</span>] <span class="op">/</span> <span class="dv">1000</span></span>
<span id="cb202-13"><a href="#cb202-13" aria-hidden="true" tabindex="-1"></a>        duration_seconds <span class="op">=</span> data[<span class="st">'routes'</span>][<span class="dv">0</span>][<span class="st">'duration'</span>]</span>
<span id="cb202-14"><a href="#cb202-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">round</span>(distance_km, <span class="dv">2</span>), duration_seconds</span>
<span id="cb202-15"><a href="#cb202-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb202-16"><a href="#cb202-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-17"><a href="#cb202-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_zipcode_coordinates(zipcode: <span class="bu">str</span>, country) <span class="op">-&gt;</span> Optional[Tuple[<span class="bu">float</span>, <span class="bu">float</span>]]:</span>
<span id="cb202-18"><a href="#cb202-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb202-19"><a href="#cb202-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns the latitude and longitude of a given ZIP code and country using the Nominatim geocoding API.</span></span>
<span id="cb202-20"><a href="#cb202-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb202-21"><a href="#cb202-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb202-22"><a href="#cb202-22" aria-hidden="true" tabindex="-1"></a>        geolocator <span class="op">=</span> Nominatim(user_agent<span class="op">=</span><span class="st">"my_distance_calculator"</span>)</span>
<span id="cb202-23"><a href="#cb202-23" aria-hidden="true" tabindex="-1"></a>        location <span class="op">=</span> geolocator.geocode(<span class="ss">f"</span><span class="sc">{</span>zipcode<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>country<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb202-24"><a href="#cb202-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb202-25"><a href="#cb202-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> location:</span>
<span id="cb202-26"><a href="#cb202-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (location.latitude, location.longitude)</span>
<span id="cb202-27"><a href="#cb202-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb202-28"><a href="#cb202-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb202-29"><a href="#cb202-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb202-30"><a href="#cb202-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb202-31"><a href="#cb202-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-32"><a href="#cb202-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_statistics(processed_rows, successful_lookups, failed_lookups):</span>
<span id="cb202-33"><a href="#cb202-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb202-34"><a href="#cb202-34" aria-hidden="true" tabindex="-1"></a><span class="co">    Prints statistics on the processed dataset.</span></span>
<span id="cb202-35"><a href="#cb202-35" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb202-36"><a href="#cb202-36" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> successful_lookups <span class="op">+</span> failed_lookups</span>
<span id="cb202-37"><a href="#cb202-37" aria-hidden="true" tabindex="-1"></a>    success_rate <span class="op">=</span> (successful_lookups <span class="op">/</span> total <span class="op">*</span> <span class="dv">100</span>) <span class="cf">if</span> total <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb202-38"><a href="#cb202-38" aria-hidden="true" tabindex="-1"></a>    failure_rate <span class="op">=</span> (failed_lookups <span class="op">/</span> total <span class="op">*</span> <span class="dv">100</span>) <span class="cf">if</span> total <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb202-39"><a href="#cb202-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb202-40"><a href="#cb202-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Processing Statistics ---"</span>)</span>
<span id="cb202-41"><a href="#cb202-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processed rows: </span><span class="sc">{</span>processed_rows<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb202-42"><a href="#cb202-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Successful lookups: </span><span class="sc">{</span>successful_lookups<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>success_rate<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb202-43"><a href="#cb202-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Failed lookups: </span><span class="sc">{</span>failed_lookups<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>failure_rate<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb202-44"><a href="#cb202-44" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"------------------------------------------------</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb202-45"><a href="#cb202-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-46"><a href="#cb202-46" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_dataset():</span>
<span id="cb202-47"><a href="#cb202-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb202-48"><a href="#cb202-48" aria-hidden="true" tabindex="-1"></a><span class="co">    Processes the dataset, calculates missing distances, and updates the CSV file.</span></span>
<span id="cb202-49"><a href="#cb202-49" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb202-50"><a href="#cb202-50" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> <span class="st">"delivery_data_clear.csv"</span></span>
<span id="cb202-51"><a href="#cb202-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Processing </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb202-52"><a href="#cb202-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb202-53"><a href="#cb202-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the dataset</span></span>
<span id="cb202-54"><a href="#cb202-54" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> pd.read_csv(filename)</span>
<span id="cb202-55"><a href="#cb202-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb202-56"><a href="#cb202-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter the DataFrame for rows where distance needs to be calculated</span></span>
<span id="cb202-57"><a href="#cb202-57" aria-hidden="true" tabindex="-1"></a>    filtered_data <span class="op">=</span> data[</span>
<span id="cb202-58"><a href="#cb202-58" aria-hidden="true" tabindex="-1"></a>        (data[<span class="st">'DECLARED_DISTANCE_KM'</span>].isna() <span class="op">|</span> (data[<span class="st">'DECLARED_DISTANCE_KM'</span>] <span class="op">==</span> <span class="dv">0</span>))</span>
<span id="cb202-59"><a href="#cb202-59" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb202-60"><a href="#cb202-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb202-61"><a href="#cb202-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Counters for statistics</span></span>
<span id="cb202-62"><a href="#cb202-62" aria-hidden="true" tabindex="-1"></a>    processed_rows <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb202-63"><a href="#cb202-63" aria-hidden="true" tabindex="-1"></a>    successful_lookups <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb202-64"><a href="#cb202-64" aria-hidden="true" tabindex="-1"></a>    failed_lookups <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb202-65"><a href="#cb202-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb202-66"><a href="#cb202-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterate through the filtered dataset</span></span>
<span id="cb202-67"><a href="#cb202-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index, row <span class="kw">in</span> tqdm(filtered_data.iterrows(), total<span class="op">=</span>filtered_data.shape[<span class="dv">0</span>], </span>
<span id="cb202-68"><a href="#cb202-68" aria-hidden="true" tabindex="-1"></a>                          desc<span class="op">=</span><span class="ss">f"Processing distances"</span>):</span>
<span id="cb202-69"><a href="#cb202-69" aria-hidden="true" tabindex="-1"></a>        processed_rows <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb202-70"><a href="#cb202-70" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb202-71"><a href="#cb202-71" aria-hidden="true" tabindex="-1"></a>        departure_country <span class="op">=</span> row[<span class="st">'DEPARTURE_COUNTRY'</span>]</span>
<span id="cb202-72"><a href="#cb202-72" aria-hidden="true" tabindex="-1"></a>        departure_zipcode <span class="op">=</span> row[<span class="st">'DEPARTURE_ZIPCODE'</span>]</span>
<span id="cb202-73"><a href="#cb202-73" aria-hidden="true" tabindex="-1"></a>        arrival_zipcode <span class="op">=</span> row[<span class="st">'ARRIVAL_ZIPCODE'</span>]</span>
<span id="cb202-74"><a href="#cb202-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb202-75"><a href="#cb202-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> departure_country <span class="kw">in</span> [<span class="st">"IT"</span>, <span class="st">"US"</span>]:</span>
<span id="cb202-76"><a href="#cb202-76" aria-hidden="true" tabindex="-1"></a>            departure_coords <span class="op">=</span> get_zipcode_coordinates(departure_zipcode, departure_country)</span>
<span id="cb202-77"><a href="#cb202-77" aria-hidden="true" tabindex="-1"></a>            arrival_coords <span class="op">=</span> get_zipcode_coordinates(arrival_zipcode, departure_country)</span>
<span id="cb202-78"><a href="#cb202-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb202-79"><a href="#cb202-79" aria-hidden="true" tabindex="-1"></a>            failed_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb202-80"><a href="#cb202-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb202-81"><a href="#cb202-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb202-82"><a href="#cb202-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> departure_coords <span class="kw">and</span> arrival_coords:</span>
<span id="cb202-83"><a href="#cb202-83" aria-hidden="true" tabindex="-1"></a>            distance <span class="op">=</span> <span class="va">None</span></span>
<span id="cb202-84"><a href="#cb202-84" aria-hidden="true" tabindex="-1"></a>            error_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb202-85"><a href="#cb202-85" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb202-86"><a href="#cb202-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> error_count <span class="op">&lt;</span> <span class="dv">5</span>:</span>
<span id="cb202-87"><a href="#cb202-87" aria-hidden="true" tabindex="-1"></a>                distance, _ <span class="op">=</span> get_osrm_distance(departure_coords, arrival_coords)</span>
<span id="cb202-88"><a href="#cb202-88" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> distance <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb202-89"><a href="#cb202-89" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Update the DataFrame and immediately save it to the same file</span></span>
<span id="cb202-90"><a href="#cb202-90" aria-hidden="true" tabindex="-1"></a>                    data.at[index, <span class="st">'DECLARED_DISTANCE_KM'</span>] <span class="op">=</span> distance</span>
<span id="cb202-91"><a href="#cb202-91" aria-hidden="true" tabindex="-1"></a>                    data.to_csv(filename, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb202-92"><a href="#cb202-92" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb202-93"><a href="#cb202-93" aria-hidden="true" tabindex="-1"></a>                    successful_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb202-94"><a href="#cb202-94" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb202-95"><a href="#cb202-95" aria-hidden="true" tabindex="-1"></a>                error_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb202-96"><a href="#cb202-96" aria-hidden="true" tabindex="-1"></a>                time.sleep(<span class="dv">1</span>)  <span class="co"># Add a delay to avoid too many requests</span></span>
<span id="cb202-97"><a href="#cb202-97" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb202-98"><a href="#cb202-98" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> error_count <span class="op">==</span> <span class="dv">5</span>:</span>
<span id="cb202-99"><a href="#cb202-99" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"Unable to find distance for row </span><span class="sc">{</span>index<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb202-100"><a href="#cb202-100" aria-hidden="true" tabindex="-1"></a>                    failed_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb202-101"><a href="#cb202-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb202-102"><a href="#cb202-102" aria-hidden="true" tabindex="-1"></a>            failed_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb202-103"><a href="#cb202-103" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb202-104"><a href="#cb202-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print statistics every 100 rows</span></span>
<span id="cb202-105"><a href="#cb202-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> processed_rows <span class="op">%</span> <span class="dv">100</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb202-106"><a href="#cb202-106" aria-hidden="true" tabindex="-1"></a>            print_statistics(processed_rows, successful_lookups, failed_lookups)</span>
<span id="cb202-107"><a href="#cb202-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb202-108"><a href="#cb202-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print final statistics</span></span>
<span id="cb202-109"><a href="#cb202-109" aria-hidden="true" tabindex="-1"></a>    print_statistics(processed_rows, successful_lookups, failed_lookups)</span>
<span id="cb202-110"><a href="#cb202-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> processed_rows, successful_lookups, failed_lookups</span>
<span id="cb202-111"><a href="#cb202-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-112"><a href="#cb202-112" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb202-113"><a href="#cb202-113" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb202-114"><a href="#cb202-114" aria-hidden="true" tabindex="-1"></a><span class="co">    Main function to process the dataset and calculate distances.</span></span>
<span id="cb202-115"><a href="#cb202-115" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb202-116"><a href="#cb202-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb202-117"><a href="#cb202-117" aria-hidden="true" tabindex="-1"></a>        processed, successful, failed <span class="op">=</span> process_dataset()</span>
<span id="cb202-118"><a href="#cb202-118" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Processing completed."</span>)</span>
<span id="cb202-119"><a href="#cb202-119" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Total processed rows: </span><span class="sc">{</span>processed<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb202-120"><a href="#cb202-120" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Successful lookups: </span><span class="sc">{</span>successful<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb202-121"><a href="#cb202-121" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Failed lookups: </span><span class="sc">{</span>failed<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb202-122"><a href="#cb202-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb202-123"><a href="#cb202-123" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"File delivery_data_clear.csv not found."</span>)</span>
<span id="cb202-124"><a href="#cb202-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb202-125"><a href="#cb202-125" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error processing the file: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb202-126"><a href="#cb202-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-127"><a href="#cb202-127" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb202-128"><a href="#cb202-128" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Processing delivery_data_clear.csv...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing distances:  17%|█▋        | 100/574 [03:26&lt;15:52,  2.01s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Processing Statistics ---
Processed rows: 100
Successful lookups: 100 (100.00%)
Failed lookups: 0 (0.00%)
------------------------------------------------
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing distances:  35%|███▍      | 200/574 [06:52&lt;12:38,  2.03s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Processing Statistics ---
Processed rows: 200
Successful lookups: 200 (100.00%)
Failed lookups: 0 (0.00%)
------------------------------------------------
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing distances:  52%|█████▏    | 300/574 [10:14&lt;09:10,  2.01s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Processing Statistics ---
Processed rows: 300
Successful lookups: 300 (100.00%)
Failed lookups: 0 (0.00%)
------------------------------------------------
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing distances:  70%|██████▉   | 400/574 [13:38&lt;05:50,  2.01s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Processing Statistics ---
Processed rows: 400
Successful lookups: 400 (100.00%)
Failed lookups: 0 (0.00%)
------------------------------------------------
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing distances:  87%|████████▋ | 500/574 [17:01&lt;02:29,  2.02s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Processing Statistics ---
Processed rows: 500
Successful lookups: 500 (100.00%)
Failed lookups: 0 (0.00%)
------------------------------------------------
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing distances: 100%|██████████| 574/574 [19:31&lt;00:00,  2.04s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Processing Statistics ---
Processed rows: 574
Successful lookups: 574 (100.00%)
Failed lookups: 0 (0.00%)
------------------------------------------------


Processing completed.
Total processed rows: 574
Successful lookups: 574
Failed lookups: 0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
</section>
<section id="add-missing-vehicles-and-services" class="level3">
<h3 class="anchored" data-anchor-id="add-missing-vehicles-and-services">2) Add missing vehicles and services</h3>
<div id="20d1949d-79e0-4fc0-9bf9-1bd5373f6f46" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppress specific warnings</span></span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>)</span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>, category<span class="op">=</span><span class="pp">UserWarning</span>)</span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultiColumnLabelEncoder(BaseEstimator, TransformerMixin):</span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, columns<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.columns <span class="op">=</span> columns</span>
<span id="cb217-8"><a href="#cb217-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.encoders <span class="op">=</span> {}</span>
<span id="cb217-9"><a href="#cb217-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-10"><a href="#cb217-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb217-11"><a href="#cb217-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure X is a DataFrame</span></span>
<span id="cb217-12"><a href="#cb217-12" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> pd.DataFrame(X)</span>
<span id="cb217-13"><a href="#cb217-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb217-14"><a href="#cb217-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If no columns specified, use all columns</span></span>
<span id="cb217-15"><a href="#cb217-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.columns <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb217-16"><a href="#cb217-16" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.columns <span class="op">=</span> X.columns</span>
<span id="cb217-17"><a href="#cb217-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-18"><a href="#cb217-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit label encoders for specified columns</span></span>
<span id="cb217-19"><a href="#cb217-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> <span class="va">self</span>.columns:</span>
<span id="cb217-20"><a href="#cb217-20" aria-hidden="true" tabindex="-1"></a>            le <span class="op">=</span> LabelEncoder()</span>
<span id="cb217-21"><a href="#cb217-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Handle mixed type columns by converting to string</span></span>
<span id="cb217-22"><a href="#cb217-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb217-23"><a href="#cb217-23" aria-hidden="true" tabindex="-1"></a>                le.fit(X[col].astype(<span class="bu">str</span>).fillna(<span class="st">'Unknown'</span>))</span>
<span id="cb217-24"><a href="#cb217-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">TypeError</span>:</span>
<span id="cb217-25"><a href="#cb217-25" aria-hidden="true" tabindex="-1"></a>                le.fit(X[col].fillna(<span class="st">'Unknown'</span>).astype(<span class="bu">str</span>))</span>
<span id="cb217-26"><a href="#cb217-26" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.encoders[col] <span class="op">=</span> le</span>
<span id="cb217-27"><a href="#cb217-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb217-28"><a href="#cb217-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb217-29"><a href="#cb217-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-30"><a href="#cb217-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, X):</span>
<span id="cb217-31"><a href="#cb217-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure X is a DataFrame</span></span>
<span id="cb217-32"><a href="#cb217-32" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> pd.DataFrame(X)</span>
<span id="cb217-33"><a href="#cb217-33" aria-hidden="true" tabindex="-1"></a>        X_copy <span class="op">=</span> X.copy()</span>
<span id="cb217-34"><a href="#cb217-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb217-35"><a href="#cb217-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> <span class="va">self</span>.columns:</span>
<span id="cb217-36"><a href="#cb217-36" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if column exists and has an encoder</span></span>
<span id="cb217-37"><a href="#cb217-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> col <span class="kw">in</span> X_copy.columns <span class="kw">and</span> col <span class="kw">in</span> <span class="va">self</span>.encoders:</span>
<span id="cb217-38"><a href="#cb217-38" aria-hidden="true" tabindex="-1"></a>                le <span class="op">=</span> <span class="va">self</span>.encoders[col]</span>
<span id="cb217-39"><a href="#cb217-39" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb217-40"><a href="#cb217-40" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Transform column, handling unseen and NaN values</span></span>
<span id="cb217-41"><a href="#cb217-41" aria-hidden="true" tabindex="-1"></a>                X_copy[col] <span class="op">=</span> X_copy[col].fillna(<span class="st">'Unknown'</span>)</span>
<span id="cb217-42"><a href="#cb217-42" aria-hidden="true" tabindex="-1"></a>                X_copy[col] <span class="op">=</span> X_copy[col].<span class="bu">map</span>(</span>
<span id="cb217-43"><a href="#cb217-43" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">lambda</span> s: le.transform([<span class="bu">str</span>(s)])[<span class="dv">0</span>] </span>
<span id="cb217-44"><a href="#cb217-44" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">str</span>(s) <span class="kw">in</span> le.classes_ </span>
<span id="cb217-45"><a href="#cb217-45" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb217-46"><a href="#cb217-46" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb217-47"><a href="#cb217-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb217-48"><a href="#cb217-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> X_copy</span>
<span id="cb217-49"><a href="#cb217-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-50"><a href="#cb217-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit_transform(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb217-51"><a href="#cb217-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.fit(X).transform(X)</span>
<span id="cb217-52"><a href="#cb217-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-53"><a href="#cb217-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_data_for_ml(df):</span>
<span id="cb217-54"><a href="#cb217-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb217-55"><a href="#cb217-55" aria-hidden="true" tabindex="-1"></a><span class="co">    Prepare the data for training the Machine Learning model</span></span>
<span id="cb217-56"><a href="#cb217-56" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb217-57"><a href="#cb217-57" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb217-58"><a href="#cb217-58" aria-hidden="true" tabindex="-1"></a><span class="co">    df (pd.DataFrame): Original dataset</span></span>
<span id="cb217-59"><a href="#cb217-59" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb217-60"><a href="#cb217-60" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb217-61"><a href="#cb217-61" aria-hidden="true" tabindex="-1"></a><span class="co">    tuple: Features, target for SERVICETYPE and VEHICLETYPE</span></span>
<span id="cb217-62"><a href="#cb217-62" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb217-63"><a href="#cb217-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Select features for prediction</span></span>
<span id="cb217-64"><a href="#cb217-64" aria-hidden="true" tabindex="-1"></a>    features_columns <span class="op">=</span> [</span>
<span id="cb217-65"><a href="#cb217-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DEPARTURE_COUNTRY'</span>, </span>
<span id="cb217-66"><a href="#cb217-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ARRIVAL_COUNTRY'</span>, </span>
<span id="cb217-67"><a href="#cb217-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">'GROSS_WEIGHT_KG'</span>, </span>
<span id="cb217-68"><a href="#cb217-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">'NET_WEIGHT_KG'</span>, </span>
<span id="cb217-69"><a href="#cb217-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">'VOLUME_M3'</span>, </span>
<span id="cb217-70"><a href="#cb217-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DECLARED_DISTANCE_KM'</span>,</span>
<span id="cb217-71"><a href="#cb217-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DELIVERY_TIME_HH'</span>,</span>
<span id="cb217-72"><a href="#cb217-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">'WDAY'</span></span>
<span id="cb217-73"><a href="#cb217-73" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb217-74"><a href="#cb217-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-75"><a href="#cb217-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a copy of the dataset</span></span>
<span id="cb217-76"><a href="#cb217-76" aria-hidden="true" tabindex="-1"></a>    df_prepared <span class="op">=</span> df.copy()</span>
<span id="cb217-77"><a href="#cb217-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-78"><a href="#cb217-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove rows with null target values</span></span>
<span id="cb217-79"><a href="#cb217-79" aria-hidden="true" tabindex="-1"></a>    df_known <span class="op">=</span> df_prepared.dropna(subset<span class="op">=</span>[<span class="st">'SERVICETYPE'</span>, <span class="st">'VEHICLETYPE'</span>])</span>
<span id="cb217-80"><a href="#cb217-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-81"><a href="#cb217-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate that we have enough data for training</span></span>
<span id="cb217-82"><a href="#cb217-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(df_known) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb217-83"><a href="#cb217-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No rows available for training after removing null targets"</span>)</span>
<span id="cb217-84"><a href="#cb217-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-85"><a href="#cb217-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare the features</span></span>
<span id="cb217-86"><a href="#cb217-86" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df_known[features_columns].copy()</span>
<span id="cb217-87"><a href="#cb217-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-88"><a href="#cb217-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare the targets</span></span>
<span id="cb217-89"><a href="#cb217-89" aria-hidden="true" tabindex="-1"></a>    y_service <span class="op">=</span> df_known[<span class="st">'SERVICETYPE'</span>]</span>
<span id="cb217-90"><a href="#cb217-90" aria-hidden="true" tabindex="-1"></a>    y_vehicle <span class="op">=</span> df_known[<span class="st">'VEHICLETYPE'</span>]</span>
<span id="cb217-91"><a href="#cb217-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-92"><a href="#cb217-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X, y_service, y_vehicle</span>
<span id="cb217-93"><a href="#cb217-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-94"><a href="#cb217-94" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_ml_pipeline(is_categorical<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb217-95"><a href="#cb217-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb217-96"><a href="#cb217-96" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a preprocessing and classification pipeline</span></span>
<span id="cb217-97"><a href="#cb217-97" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb217-98"><a href="#cb217-98" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb217-99"><a href="#cb217-99" aria-hidden="true" tabindex="-1"></a><span class="co">    is_categorical (bool): If True, use encoding for categorical columns</span></span>
<span id="cb217-100"><a href="#cb217-100" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb217-101"><a href="#cb217-101" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb217-102"><a href="#cb217-102" aria-hidden="true" tabindex="-1"></a><span class="co">    Pipeline: Preprocessing and classification pipeline</span></span>
<span id="cb217-103"><a href="#cb217-103" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb217-104"><a href="#cb217-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Numeric and categorical columns</span></span>
<span id="cb217-105"><a href="#cb217-105" aria-hidden="true" tabindex="-1"></a>    numeric_features <span class="op">=</span> [</span>
<span id="cb217-106"><a href="#cb217-106" aria-hidden="true" tabindex="-1"></a>        <span class="st">'GROSS_WEIGHT_KG'</span>, </span>
<span id="cb217-107"><a href="#cb217-107" aria-hidden="true" tabindex="-1"></a>        <span class="st">'NET_WEIGHT_KG'</span>, </span>
<span id="cb217-108"><a href="#cb217-108" aria-hidden="true" tabindex="-1"></a>        <span class="st">'VOLUME_M3'</span>, </span>
<span id="cb217-109"><a href="#cb217-109" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DECLARED_DISTANCE_KM'</span>,</span>
<span id="cb217-110"><a href="#cb217-110" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DELIVERY_TIME_HH'</span>,</span>
<span id="cb217-111"><a href="#cb217-111" aria-hidden="true" tabindex="-1"></a>        <span class="st">'WDAY'</span></span>
<span id="cb217-112"><a href="#cb217-112" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb217-113"><a href="#cb217-113" aria-hidden="true" tabindex="-1"></a>    categorical_features <span class="op">=</span> [<span class="st">'DEPARTURE_COUNTRY'</span>, <span class="st">'ARRIVAL_COUNTRY'</span>]</span>
<span id="cb217-114"><a href="#cb217-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-115"><a href="#cb217-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing for numeric columns</span></span>
<span id="cb217-116"><a href="#cb217-116" aria-hidden="true" tabindex="-1"></a>    numeric_transformer <span class="op">=</span> Pipeline(steps<span class="op">=</span>[</span>
<span id="cb217-117"><a href="#cb217-117" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'imputer'</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">'median'</span>)),</span>
<span id="cb217-118"><a href="#cb217-118" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'scaler'</span>, StandardScaler())</span>
<span id="cb217-119"><a href="#cb217-119" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb217-120"><a href="#cb217-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-121"><a href="#cb217-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing for categorical columns</span></span>
<span id="cb217-122"><a href="#cb217-122" aria-hidden="true" tabindex="-1"></a>    preprocessing_steps <span class="op">=</span> [</span>
<span id="cb217-123"><a href="#cb217-123" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'imputer'</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">'most_frequent'</span>))</span>
<span id="cb217-124"><a href="#cb217-124" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb217-125"><a href="#cb217-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-126"><a href="#cb217-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add encoding if requested</span></span>
<span id="cb217-127"><a href="#cb217-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_categorical:</span>
<span id="cb217-128"><a href="#cb217-128" aria-hidden="true" tabindex="-1"></a>        preprocessing_steps.append((<span class="st">'encoder'</span>, MultiColumnLabelEncoder()))</span>
<span id="cb217-129"><a href="#cb217-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-130"><a href="#cb217-130" aria-hidden="true" tabindex="-1"></a>    categorical_transformer <span class="op">=</span> Pipeline(steps<span class="op">=</span>preprocessing_steps)</span>
<span id="cb217-131"><a href="#cb217-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-132"><a href="#cb217-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine preprocessors</span></span>
<span id="cb217-133"><a href="#cb217-133" aria-hidden="true" tabindex="-1"></a>    preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb217-134"><a href="#cb217-134" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>[</span>
<span id="cb217-135"><a href="#cb217-135" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'num'</span>, numeric_transformer, numeric_features),</span>
<span id="cb217-136"><a href="#cb217-136" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'cat'</span>, categorical_transformer, categorical_features)</span>
<span id="cb217-137"><a href="#cb217-137" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb217-138"><a href="#cb217-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-139"><a href="#cb217-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Complete pipeline with preprocessor and classifier</span></span>
<span id="cb217-140"><a href="#cb217-140" aria-hidden="true" tabindex="-1"></a>    pipeline <span class="op">=</span> Pipeline(steps<span class="op">=</span>[</span>
<span id="cb217-141"><a href="#cb217-141" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'preprocessor'</span>, preprocessor),</span>
<span id="cb217-142"><a href="#cb217-142" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'classifier'</span>, RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>))</span>
<span id="cb217-143"><a href="#cb217-143" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb217-144"><a href="#cb217-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-145"><a href="#cb217-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pipeline</span>
<span id="cb217-146"><a href="#cb217-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-147"><a href="#cb217-147" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> impute_with_ml(input_file):</span>
<span id="cb217-148"><a href="#cb217-148" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb217-149"><a href="#cb217-149" aria-hidden="true" tabindex="-1"></a><span class="co">    Impute missing values using Machine Learning</span></span>
<span id="cb217-150"><a href="#cb217-150" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb217-151"><a href="#cb217-151" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb217-152"><a href="#cb217-152" aria-hidden="true" tabindex="-1"></a><span class="co">    input_file (str): Path to the input CSV file</span></span>
<span id="cb217-153"><a href="#cb217-153" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb217-154"><a href="#cb217-154" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb217-155"><a href="#cb217-155" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame: DataFrame with imputed values</span></span>
<span id="cb217-156"><a href="#cb217-156" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb217-157"><a href="#cb217-157" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the dataset</span></span>
<span id="cb217-158"><a href="#cb217-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb217-159"><a href="#cb217-159" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.read_csv(input_file)</span>
<span id="cb217-160"><a href="#cb217-160" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb217-161"><a href="#cb217-161" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error: File </span><span class="sc">{</span>input_file<span class="sc">}</span><span class="ss"> not found."</span>)</span>
<span id="cb217-162"><a href="#cb217-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb217-163"><a href="#cb217-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb217-164"><a href="#cb217-164" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error loading file: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb217-165"><a href="#cb217-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb217-166"><a href="#cb217-166" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-167"><a href="#cb217-167" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a duplicate of the dataset</span></span>
<span id="cb217-168"><a href="#cb217-168" aria-hidden="true" tabindex="-1"></a>    df_imputed <span class="op">=</span> df.copy()</span>
<span id="cb217-169"><a href="#cb217-169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-170"><a href="#cb217-170" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb217-171"><a href="#cb217-171" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare the data for training</span></span>
<span id="cb217-172"><a href="#cb217-172" aria-hidden="true" tabindex="-1"></a>        X, y_service, y_vehicle <span class="op">=</span> prepare_data_for_ml(df)</span>
<span id="cb217-173"><a href="#cb217-173" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb217-174"><a href="#cb217-174" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Split the data into training and test sets</span></span>
<span id="cb217-175"><a href="#cb217-175" aria-hidden="true" tabindex="-1"></a>        X_train, X_test, y_service_train, y_service_test, y_vehicle_train, y_vehicle_test <span class="op">=</span> train_test_split(</span>
<span id="cb217-176"><a href="#cb217-176" aria-hidden="true" tabindex="-1"></a>            X, y_service, y_vehicle, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb217-177"><a href="#cb217-177" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb217-178"><a href="#cb217-178" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb217-179"><a href="#cb217-179" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create and train the models</span></span>
<span id="cb217-180"><a href="#cb217-180" aria-hidden="true" tabindex="-1"></a>        service_pipeline <span class="op">=</span> create_ml_pipeline(is_categorical<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb217-181"><a href="#cb217-181" aria-hidden="true" tabindex="-1"></a>        vehicle_pipeline <span class="op">=</span> create_ml_pipeline(is_categorical<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb217-182"><a href="#cb217-182" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb217-183"><a href="#cb217-183" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train both models</span></span>
<span id="cb217-184"><a href="#cb217-184" aria-hidden="true" tabindex="-1"></a>        service_pipeline.fit(X_train, y_service_train)</span>
<span id="cb217-185"><a href="#cb217-185" aria-hidden="true" tabindex="-1"></a>        vehicle_pipeline.fit(X_train, y_vehicle_train)</span>
<span id="cb217-186"><a href="#cb217-186" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb217-187"><a href="#cb217-187" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Evaluate the models</span></span>
<span id="cb217-188"><a href="#cb217-188" aria-hidden="true" tabindex="-1"></a>        service_pred <span class="op">=</span> service_pipeline.predict(X_test)</span>
<span id="cb217-189"><a href="#cb217-189" aria-hidden="true" tabindex="-1"></a>        vehicle_pred <span class="op">=</span> vehicle_pipeline.predict(X_test)</span>
<span id="cb217-190"><a href="#cb217-190" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb217-191"><a href="#cb217-191" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate accuracy</span></span>
<span id="cb217-192"><a href="#cb217-192" aria-hidden="true" tabindex="-1"></a>        service_accuracy <span class="op">=</span> accuracy_score(y_service_test, service_pred) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb217-193"><a href="#cb217-193" aria-hidden="true" tabindex="-1"></a>        vehicle_accuracy <span class="op">=</span> accuracy_score(y_vehicle_test, vehicle_pred) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb217-194"><a href="#cb217-194" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb217-195"><a href="#cb217-195" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">SERVICETYPE Accuracy: </span><span class="sc">{</span>service_accuracy<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb217-196"><a href="#cb217-196" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"VEHICLETYPE Accuracy: </span><span class="sc">{</span>vehicle_accuracy<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb217-197"><a href="#cb217-197" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb217-198"><a href="#cb217-198" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Identify rows with missing values</span></span>
<span id="cb217-199"><a href="#cb217-199" aria-hidden="true" tabindex="-1"></a>        missing_mask <span class="op">=</span> df_imputed[<span class="st">'SERVICETYPE'</span>].isna() <span class="op">|</span> df_imputed[<span class="st">'VEHICLETYPE'</span>].isna()</span>
<span id="cb217-200"><a href="#cb217-200" aria-hidden="true" tabindex="-1"></a>        missing_data <span class="op">=</span> df_imputed.loc[missing_mask, X.columns].copy()</span>
<span id="cb217-201"><a href="#cb217-201" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb217-202"><a href="#cb217-202" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Impute missing values</span></span>
<span id="cb217-203"><a href="#cb217-203" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> index <span class="kw">in</span> missing_mask[missing_mask].index:</span>
<span id="cb217-204"><a href="#cb217-204" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Impute SERVICETYPE</span></span>
<span id="cb217-205"><a href="#cb217-205" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.isna(df_imputed.at[index, <span class="st">'SERVICETYPE'</span>]):</span>
<span id="cb217-206"><a href="#cb217-206" aria-hidden="true" tabindex="-1"></a>                df_imputed.at[index, <span class="st">'SERVICETYPE'</span>] <span class="op">=</span> service_pipeline.predict(missing_data.loc[[index]])[<span class="dv">0</span>]</span>
<span id="cb217-207"><a href="#cb217-207" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb217-208"><a href="#cb217-208" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Impute VEHICLETYPE</span></span>
<span id="cb217-209"><a href="#cb217-209" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.isna(df_imputed.at[index, <span class="st">'VEHICLETYPE'</span>]):</span>
<span id="cb217-210"><a href="#cb217-210" aria-hidden="true" tabindex="-1"></a>                df_imputed.at[index, <span class="st">'VEHICLETYPE'</span>] <span class="op">=</span> vehicle_pipeline.predict(missing_data.loc[[index]])[<span class="dv">0</span>]</span>
<span id="cb217-211"><a href="#cb217-211" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb217-212"><a href="#cb217-212" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df_imputed</span>
<span id="cb217-213"><a href="#cb217-213" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-214"><a href="#cb217-214" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb217-215"><a href="#cb217-215" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error during imputation process: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb217-216"><a href="#cb217-216" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb217-217"><a href="#cb217-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-218"><a href="#cb217-218" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb217-219"><a href="#cb217-219" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb217-220"><a href="#cb217-220" aria-hidden="true" tabindex="-1"></a><span class="co">    Main function to execute the imputation process</span></span>
<span id="cb217-221"><a href="#cb217-221" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb217-222"><a href="#cb217-222" aria-hidden="true" tabindex="-1"></a>    input_file <span class="op">=</span> <span class="st">'delivery_data_clear.csv'</span></span>
<span id="cb217-223"><a href="#cb217-223" aria-hidden="true" tabindex="-1"></a>    output_file <span class="op">=</span> <span class="st">'final_delivery_data.csv'</span></span>
<span id="cb217-224"><a href="#cb217-224" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-225"><a href="#cb217-225" aria-hidden="true" tabindex="-1"></a>    df_with_imputed_data <span class="op">=</span> impute_with_ml(input_file)</span>
<span id="cb217-226"><a href="#cb217-226" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-227"><a href="#cb217-227" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df_with_imputed_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb217-228"><a href="#cb217-228" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb217-229"><a href="#cb217-229" aria-hidden="true" tabindex="-1"></a>            df_with_imputed_data.to_csv(output_file, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb217-230"><a href="#cb217-230" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">File '</span><span class="sc">{</span>output_file<span class="sc">}</span><span class="ss">' created successfully."</span>)</span>
<span id="cb217-231"><a href="#cb217-231" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb217-232"><a href="#cb217-232" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error saving the file: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb217-233"><a href="#cb217-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-234"><a href="#cb217-234" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb217-235"><a href="#cb217-235" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
SERVICETYPE Accuracy: 96.72%
VEHICLETYPE Accuracy: 90.55%

File 'final_delivery_data.csv' created successfully.</code></pre>
</div>
</div>
</section>
</section>
<section id="creation-of-4-correlation-matrices-for-each-csv-file" class="level2">
<h2 class="anchored" data-anchor-id="creation-of-4-correlation-matrices-for-each-csv-file">Creation of 4 correlation matrices for each csv file</h2>
<section id="dataset-gomma" class="level3">
<h3 class="anchored" data-anchor-id="dataset-gomma">Dataset Gomma</h3>
<div id="e245dc5c-307e-4651-8edc-750b323262d7" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the dataset</span></span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'gomma_data.csv'</span>)</span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Select only the numeric columns of interest</span></span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>columns_of_interest <span class="op">=</span> [</span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'GROSS_WEIGHT_KG'</span>,</span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'NET_WEIGHT_KG'</span>,</span>
<span id="cb219-8"><a href="#cb219-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VOLUME_M3'</span>,</span>
<span id="cb219-9"><a href="#cb219-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'DECLARED_DISTANCE_KM'</span>,</span>
<span id="cb219-10"><a href="#cb219-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'DELIVERY_TIME_HH'</span>,</span>
<span id="cb219-11"><a href="#cb219-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'WDAY'</span></span>
<span id="cb219-12"><a href="#cb219-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb219-13"><a href="#cb219-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-14"><a href="#cb219-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the correlation matrix</span></span>
<span id="cb219-15"><a href="#cb219-15" aria-hidden="true" tabindex="-1"></a>correlation_matrix <span class="op">=</span> df[columns_of_interest].corr()</span>
<span id="cb219-16"><a href="#cb219-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-17"><a href="#cb219-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a larger figure for better readability</span></span>
<span id="cb219-18"><a href="#cb219-18" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb219-19"><a href="#cb219-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-20"><a href="#cb219-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the correlogram using seaborn</span></span>
<span id="cb219-21"><a href="#cb219-21" aria-hidden="true" tabindex="-1"></a>sns.heatmap(correlation_matrix, </span>
<span id="cb219-22"><a href="#cb219-22" aria-hidden="true" tabindex="-1"></a>            annot<span class="op">=</span><span class="va">True</span>,  <span class="co"># Show numeric values</span></span>
<span id="cb219-23"><a href="#cb219-23" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span><span class="st">'RdBu'</span>,  <span class="co"># Use a blue-red colormap</span></span>
<span id="cb219-24"><a href="#cb219-24" aria-hidden="true" tabindex="-1"></a>            vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>,  <span class="co"># Set scale limits</span></span>
<span id="cb219-25"><a href="#cb219-25" aria-hidden="true" tabindex="-1"></a>            center<span class="op">=</span><span class="dv">0</span>,  <span class="co"># Center the colormap on zero</span></span>
<span id="cb219-26"><a href="#cb219-26" aria-hidden="true" tabindex="-1"></a>            fmt<span class="op">=</span><span class="st">'.2f'</span>)  <span class="co"># Show two decimals</span></span>
<span id="cb219-27"><a href="#cb219-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-28"><a href="#cb219-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Rotate labels for better readability</span></span>
<span id="cb219-29"><a href="#cb219-29" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb219-30"><a href="#cb219-30" aria-hidden="true" tabindex="-1"></a>plt.yticks(rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb219-31"><a href="#cb219-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-32"><a href="#cb219-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a title</span></span>
<span id="cb219-33"><a href="#cb219-33" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Correlogram of Transport Variables'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb219-34"><a href="#cb219-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-35"><a href="#cb219-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust the layout</span></span>
<span id="cb219-36"><a href="#cb219-36" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb219-37"><a href="#cb219-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-38"><a href="#cb219-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="dataset-ecommerce" class="level3">
<h3 class="anchored" data-anchor-id="dataset-ecommerce">Dataset Ecommerce</h3>
<div id="73ddf584-f2db-44ad-afdc-7c6624bbd9d3" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the dataset</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'ecommerce_data.csv'</span>)</span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Select only the numeric columns of interest</span></span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a>columns_of_interest <span class="op">=</span> [</span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'GROSS_WEIGHT_KG'</span>,</span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'NET_WEIGHT_KG'</span>,</span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VOLUME_M3'</span>,</span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'DECLARED_DISTANCE_KM'</span>,</span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'DELIVERY_TIME_HH'</span>,</span>
<span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'WDAY'</span></span>
<span id="cb220-12"><a href="#cb220-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb220-13"><a href="#cb220-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-14"><a href="#cb220-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the correlation matrix</span></span>
<span id="cb220-15"><a href="#cb220-15" aria-hidden="true" tabindex="-1"></a>correlation_matrix <span class="op">=</span> df[columns_of_interest].corr()</span>
<span id="cb220-16"><a href="#cb220-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-17"><a href="#cb220-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a larger figure for better readability</span></span>
<span id="cb220-18"><a href="#cb220-18" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb220-19"><a href="#cb220-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-20"><a href="#cb220-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the correlogram using seaborn</span></span>
<span id="cb220-21"><a href="#cb220-21" aria-hidden="true" tabindex="-1"></a>sns.heatmap(correlation_matrix, </span>
<span id="cb220-22"><a href="#cb220-22" aria-hidden="true" tabindex="-1"></a>            annot<span class="op">=</span><span class="va">True</span>,  <span class="co"># Show numeric values</span></span>
<span id="cb220-23"><a href="#cb220-23" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span><span class="st">'RdBu'</span>,  <span class="co"># Use a blue-red colormap</span></span>
<span id="cb220-24"><a href="#cb220-24" aria-hidden="true" tabindex="-1"></a>            vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>,  <span class="co"># Set scale limits</span></span>
<span id="cb220-25"><a href="#cb220-25" aria-hidden="true" tabindex="-1"></a>            center<span class="op">=</span><span class="dv">0</span>,  <span class="co"># Center the colormap on zero</span></span>
<span id="cb220-26"><a href="#cb220-26" aria-hidden="true" tabindex="-1"></a>            fmt<span class="op">=</span><span class="st">'.2f'</span>)  <span class="co"># Show two decimals</span></span>
<span id="cb220-27"><a href="#cb220-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-28"><a href="#cb220-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Rotate labels for better readability</span></span>
<span id="cb220-29"><a href="#cb220-29" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb220-30"><a href="#cb220-30" aria-hidden="true" tabindex="-1"></a>plt.yticks(rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb220-31"><a href="#cb220-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-32"><a href="#cb220-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a title</span></span>
<span id="cb220-33"><a href="#cb220-33" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Correlogram of Transport Variables'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb220-34"><a href="#cb220-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-35"><a href="#cb220-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust the layout</span></span>
<span id="cb220-36"><a href="#cb220-36" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb220-37"><a href="#cb220-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-38"><a href="#cb220-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="dataset-corrieri" class="level3">
<h3 class="anchored" data-anchor-id="dataset-corrieri">Dataset Corrieri</h3>
<div id="c83240e1-eb12-4b46-ba7c-a48b2893f4e3" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the dataset</span></span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'corrieri_data.csv'</span>)</span>
<span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-4"><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Select only the numeric columns of interest</span></span>
<span id="cb221-5"><a href="#cb221-5" aria-hidden="true" tabindex="-1"></a>columns_of_interest <span class="op">=</span> [</span>
<span id="cb221-6"><a href="#cb221-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'GROSS_WEIGHT_KG'</span>,</span>
<span id="cb221-7"><a href="#cb221-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'NET_WEIGHT_KG'</span>,</span>
<span id="cb221-8"><a href="#cb221-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VOLUME_M3'</span>,</span>
<span id="cb221-9"><a href="#cb221-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'DECLARED_DISTANCE_KM'</span>,</span>
<span id="cb221-10"><a href="#cb221-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'DELIVERY_TIME_HH'</span>,</span>
<span id="cb221-11"><a href="#cb221-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'WDAY'</span></span>
<span id="cb221-12"><a href="#cb221-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb221-13"><a href="#cb221-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-14"><a href="#cb221-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the correlation matrix</span></span>
<span id="cb221-15"><a href="#cb221-15" aria-hidden="true" tabindex="-1"></a>correlation_matrix <span class="op">=</span> df[columns_of_interest].corr()</span>
<span id="cb221-16"><a href="#cb221-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-17"><a href="#cb221-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a larger figure for better readability</span></span>
<span id="cb221-18"><a href="#cb221-18" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb221-19"><a href="#cb221-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-20"><a href="#cb221-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the correlogram using seaborn</span></span>
<span id="cb221-21"><a href="#cb221-21" aria-hidden="true" tabindex="-1"></a>sns.heatmap(correlation_matrix, </span>
<span id="cb221-22"><a href="#cb221-22" aria-hidden="true" tabindex="-1"></a>            annot<span class="op">=</span><span class="va">True</span>,  <span class="co"># Show numeric values</span></span>
<span id="cb221-23"><a href="#cb221-23" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span><span class="st">'RdBu'</span>,  <span class="co"># Use a blue-red colormap</span></span>
<span id="cb221-24"><a href="#cb221-24" aria-hidden="true" tabindex="-1"></a>            vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>,  <span class="co"># Set scale limits</span></span>
<span id="cb221-25"><a href="#cb221-25" aria-hidden="true" tabindex="-1"></a>            center<span class="op">=</span><span class="dv">0</span>,  <span class="co"># Center the colormap on zero</span></span>
<span id="cb221-26"><a href="#cb221-26" aria-hidden="true" tabindex="-1"></a>            fmt<span class="op">=</span><span class="st">'.2f'</span>)  <span class="co"># Show two decimals</span></span>
<span id="cb221-27"><a href="#cb221-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-28"><a href="#cb221-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Rotate labels for better readability</span></span>
<span id="cb221-29"><a href="#cb221-29" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb221-30"><a href="#cb221-30" aria-hidden="true" tabindex="-1"></a>plt.yticks(rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb221-31"><a href="#cb221-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-32"><a href="#cb221-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a title</span></span>
<span id="cb221-33"><a href="#cb221-33" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Correlogram of Transport Variables'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb221-34"><a href="#cb221-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-35"><a href="#cb221-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust the layout</span></span>
<span id="cb221-36"><a href="#cb221-36" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb221-37"><a href="#cb221-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-38"><a href="#cb221-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="final-dataset" class="level3">
<h3 class="anchored" data-anchor-id="final-dataset">Final dataset</h3>
<div id="240d69b6-112d-49a1-8dc9-06e1f17c664b" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the dataset</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'final_delivery_data.csv'</span>)</span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Select only the numeric columns of interest</span></span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a>columns_of_interest <span class="op">=</span> [</span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'GROSS_WEIGHT_KG'</span>,</span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'NET_WEIGHT_KG'</span>,</span>
<span id="cb222-8"><a href="#cb222-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VOLUME_M3'</span>,</span>
<span id="cb222-9"><a href="#cb222-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'DECLARED_DISTANCE_KM'</span>,</span>
<span id="cb222-10"><a href="#cb222-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'DELIVERY_TIME_HH'</span>,</span>
<span id="cb222-11"><a href="#cb222-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'WDAY'</span></span>
<span id="cb222-12"><a href="#cb222-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb222-13"><a href="#cb222-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-14"><a href="#cb222-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the correlation matrix</span></span>
<span id="cb222-15"><a href="#cb222-15" aria-hidden="true" tabindex="-1"></a>correlation_matrix <span class="op">=</span> df[columns_of_interest].corr()</span>
<span id="cb222-16"><a href="#cb222-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-17"><a href="#cb222-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a larger figure for better readability</span></span>
<span id="cb222-18"><a href="#cb222-18" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb222-19"><a href="#cb222-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-20"><a href="#cb222-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the correlogram using seaborn</span></span>
<span id="cb222-21"><a href="#cb222-21" aria-hidden="true" tabindex="-1"></a>sns.heatmap(correlation_matrix, </span>
<span id="cb222-22"><a href="#cb222-22" aria-hidden="true" tabindex="-1"></a>            annot<span class="op">=</span><span class="va">True</span>,  <span class="co"># Show numeric values</span></span>
<span id="cb222-23"><a href="#cb222-23" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span><span class="st">'RdBu'</span>,  <span class="co"># Use a blue-red colormap</span></span>
<span id="cb222-24"><a href="#cb222-24" aria-hidden="true" tabindex="-1"></a>            vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>,  <span class="co"># Set scale limits</span></span>
<span id="cb222-25"><a href="#cb222-25" aria-hidden="true" tabindex="-1"></a>            center<span class="op">=</span><span class="dv">0</span>,  <span class="co"># Center the colormap on zero</span></span>
<span id="cb222-26"><a href="#cb222-26" aria-hidden="true" tabindex="-1"></a>            fmt<span class="op">=</span><span class="st">'.2f'</span>)  <span class="co"># Show two decimals</span></span>
<span id="cb222-27"><a href="#cb222-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-28"><a href="#cb222-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Rotate labels for better readability</span></span>
<span id="cb222-29"><a href="#cb222-29" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb222-30"><a href="#cb222-30" aria-hidden="true" tabindex="-1"></a>plt.yticks(rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb222-31"><a href="#cb222-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-32"><a href="#cb222-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a title</span></span>
<span id="cb222-33"><a href="#cb222-33" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Correlogram of Transport Variables'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb222-34"><a href="#cb222-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-35"><a href="#cb222-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust the layout</span></span>
<span id="cb222-36"><a href="#cb222-36" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb222-37"><a href="#cb222-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-38"><a href="#cb222-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Based on these correlations matrices we can understand that the thing that varies the most the delivery time is the day they leave, the more you are towards the weekend, the longer the delivery time will be</p>
</section>
</section>
<section id="creation-of-average-time-histograms-based-on-the-day" class="level2">
<h2 class="anchored" data-anchor-id="creation-of-average-time-histograms-based-on-the-day">Creation of average time histograms based on the day</h2>
<p>We create 3 graphs for each type of transport system to see if there is any data that may interest us</p>
<section id="histogram-gomma" class="level3">
<h3 class="anchored" data-anchor-id="histogram-gomma">Histogram Gomma</h3>
<div id="b777ddbc-36ff-4122-8c8f-46cf4de9f3b1" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dataset</span></span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>df_gomma <span class="op">=</span> pd.read_csv(<span class="st">'gomma_data.csv'</span>)</span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average delivery time for each day of the week</span></span>
<span id="cb223-5"><a href="#cb223-5" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_gomma <span class="op">=</span> df_gomma.groupby(<span class="st">'WDAY'</span>)[<span class="st">'DELIVERY_TIME_HH'</span>].mean()</span>
<span id="cb223-6"><a href="#cb223-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-7"><a href="#cb223-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame with all days of the week</span></span>
<span id="cb223-8"><a href="#cb223-8" aria-hidden="true" tabindex="-1"></a>days_of_week <span class="op">=</span> pd.DataFrame({<span class="st">'WDAY'</span>: <span class="bu">range</span>(<span class="dv">7</span>)})</span>
<span id="cb223-9"><a href="#cb223-9" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_gomma <span class="op">=</span> mean_delivery_time_gomma.reset_index()</span>
<span id="cb223-10"><a href="#cb223-10" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_gomma <span class="op">=</span> days_of_week.merge(mean_delivery_time_gomma, on<span class="op">=</span><span class="st">'WDAY'</span>, how<span class="op">=</span><span class="st">'left'</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb223-11"><a href="#cb223-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-12"><a href="#cb223-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the histogram</span></span>
<span id="cb223-13"><a href="#cb223-13" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb223-14"><a href="#cb223-14" aria-hidden="true" tabindex="-1"></a>bars <span class="op">=</span> plt.bar(mean_delivery_time_gomma[<span class="st">'WDAY'</span>], mean_delivery_time_gomma[<span class="st">'DELIVERY_TIME_HH'</span>], color<span class="op">=</span><span class="st">'skyblue'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb223-15"><a href="#cb223-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Average Travel Time by Day of the Week (Gomma)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb223-16"><a href="#cb223-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Day of the Week (0 = Monday)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb223-17"><a href="#cb223-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Average Travel Time (Hours)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb223-18"><a href="#cb223-18" aria-hidden="true" tabindex="-1"></a>plt.xticks(<span class="bu">range</span>(<span class="dv">7</span>), [<span class="st">'Mon'</span>, <span class="st">'Tue'</span>, <span class="st">'Wed'</span>, <span class="st">'Thu'</span>, <span class="st">'Fri'</span>, <span class="st">'Sat'</span>, <span class="st">'Sun'</span>], fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb223-19"><a href="#cb223-19" aria-hidden="true" tabindex="-1"></a>plt.grid(axis<span class="op">=</span><span class="st">'y'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb223-20"><a href="#cb223-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-21"><a href="#cb223-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels above each bar</span></span>
<span id="cb223-22"><a href="#cb223-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bar <span class="kw">in</span> bars:</span>
<span id="cb223-23"><a href="#cb223-23" aria-hidden="true" tabindex="-1"></a>    yval <span class="op">=</span> bar.get_height()</span>
<span id="cb223-24"><a href="#cb223-24" aria-hidden="true" tabindex="-1"></a>    plt.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="dv">2</span>, yval, <span class="bu">round</span>(yval, <span class="dv">2</span>), ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb223-25"><a href="#cb223-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-26"><a href="#cb223-26" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb223-27"><a href="#cb223-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="histogram-corrieri" class="level3">
<h3 class="anchored" data-anchor-id="histogram-corrieri">Histogram Corrieri</h3>
<div id="ca238c2a-b634-4134-8e8c-a1596b41ba56" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dataset</span></span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>df_corrieri <span class="op">=</span> pd.read_csv(<span class="st">'corrieri_data.csv'</span>)</span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-4"><a href="#cb224-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average delivery time for each day of the week</span></span>
<span id="cb224-5"><a href="#cb224-5" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_corrieri <span class="op">=</span> df_corrieri.groupby(<span class="st">'WDAY'</span>)[<span class="st">'DELIVERY_TIME_HH'</span>].mean()</span>
<span id="cb224-6"><a href="#cb224-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-7"><a href="#cb224-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame with all days of the week</span></span>
<span id="cb224-8"><a href="#cb224-8" aria-hidden="true" tabindex="-1"></a>days_of_week <span class="op">=</span> pd.DataFrame({<span class="st">'WDAY'</span>: <span class="bu">range</span>(<span class="dv">7</span>)})</span>
<span id="cb224-9"><a href="#cb224-9" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_corrieri <span class="op">=</span> mean_delivery_time_corrieri.reset_index()</span>
<span id="cb224-10"><a href="#cb224-10" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_corrieri <span class="op">=</span> days_of_week.merge(mean_delivery_time_corrieri, on<span class="op">=</span><span class="st">'WDAY'</span>, how<span class="op">=</span><span class="st">'left'</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb224-11"><a href="#cb224-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-12"><a href="#cb224-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the histogram</span></span>
<span id="cb224-13"><a href="#cb224-13" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb224-14"><a href="#cb224-14" aria-hidden="true" tabindex="-1"></a>bars <span class="op">=</span> plt.bar(mean_delivery_time_corrieri[<span class="st">'WDAY'</span>], mean_delivery_time_corrieri[<span class="st">'DELIVERY_TIME_HH'</span>], color<span class="op">=</span><span class="st">'lightgreen'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb224-15"><a href="#cb224-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Average Travel Time by Day of the Week (Couriers)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb224-16"><a href="#cb224-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Day of the Week (0 = Monday)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb224-17"><a href="#cb224-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Average Travel Time (Hours)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb224-18"><a href="#cb224-18" aria-hidden="true" tabindex="-1"></a>plt.xticks(<span class="bu">range</span>(<span class="dv">7</span>), [<span class="st">'Mon'</span>, <span class="st">'Tue'</span>, <span class="st">'Wed'</span>, <span class="st">'Thu'</span>, <span class="st">'Fri'</span>, <span class="st">'Sat'</span>, <span class="st">'Sun'</span>], fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb224-19"><a href="#cb224-19" aria-hidden="true" tabindex="-1"></a>plt.grid(axis<span class="op">=</span><span class="st">'y'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb224-20"><a href="#cb224-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-21"><a href="#cb224-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels above each bar</span></span>
<span id="cb224-22"><a href="#cb224-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bar <span class="kw">in</span> bars:</span>
<span id="cb224-23"><a href="#cb224-23" aria-hidden="true" tabindex="-1"></a>    yval <span class="op">=</span> bar.get_height()</span>
<span id="cb224-24"><a href="#cb224-24" aria-hidden="true" tabindex="-1"></a>    plt.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="dv">2</span>, yval, <span class="bu">round</span>(yval, <span class="dv">2</span>), ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb224-25"><a href="#cb224-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-26"><a href="#cb224-26" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb224-27"><a href="#cb224-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="histogram-e-commerce" class="level3">
<h3 class="anchored" data-anchor-id="histogram-e-commerce">Histogram E-commerce</h3>
<div id="efe95b32-72f2-4a83-8763-9006ee29397a" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dataset</span></span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>df_ecommerce <span class="op">=</span> pd.read_csv(<span class="st">'ecommerce_data.csv'</span>)</span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average delivery time for each day of the week</span></span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_ecommerce <span class="op">=</span> df_ecommerce.groupby(<span class="st">'WDAY'</span>)[<span class="st">'DELIVERY_TIME_HH'</span>].mean()</span>
<span id="cb225-6"><a href="#cb225-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-7"><a href="#cb225-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame with all days of the week</span></span>
<span id="cb225-8"><a href="#cb225-8" aria-hidden="true" tabindex="-1"></a>days_of_week <span class="op">=</span> pd.DataFrame({<span class="st">'WDAY'</span>: <span class="bu">range</span>(<span class="dv">7</span>)})</span>
<span id="cb225-9"><a href="#cb225-9" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_ecommerce <span class="op">=</span> mean_delivery_time_ecommerce.reset_index()</span>
<span id="cb225-10"><a href="#cb225-10" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_ecommerce <span class="op">=</span> days_of_week.merge(mean_delivery_time_ecommerce, on<span class="op">=</span><span class="st">'WDAY'</span>, how<span class="op">=</span><span class="st">'left'</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb225-11"><a href="#cb225-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-12"><a href="#cb225-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the histogram</span></span>
<span id="cb225-13"><a href="#cb225-13" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb225-14"><a href="#cb225-14" aria-hidden="true" tabindex="-1"></a>bars <span class="op">=</span> plt.bar(mean_delivery_time_ecommerce[<span class="st">'WDAY'</span>], mean_delivery_time_ecommerce[<span class="st">'DELIVERY_TIME_HH'</span>], color<span class="op">=</span><span class="st">'salmon'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb225-15"><a href="#cb225-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Average Travel Time by Day of the Week (Ecommerce)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb225-16"><a href="#cb225-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Day of the Week (0 = Monday)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb225-17"><a href="#cb225-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Average Travel Time (Hours)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb225-18"><a href="#cb225-18" aria-hidden="true" tabindex="-1"></a>plt.xticks(<span class="bu">range</span>(<span class="dv">7</span>), [<span class="st">'Mon'</span>, <span class="st">'Tue'</span>, <span class="st">'Wed'</span>, <span class="st">'Thu'</span>, <span class="st">'Fri'</span>, <span class="st">'Sat'</span>, <span class="st">'Sun'</span>], fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb225-19"><a href="#cb225-19" aria-hidden="true" tabindex="-1"></a>plt.grid(axis<span class="op">=</span><span class="st">'y'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb225-20"><a href="#cb225-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-21"><a href="#cb225-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels above each bar</span></span>
<span id="cb225-22"><a href="#cb225-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bar <span class="kw">in</span> bars:</span>
<span id="cb225-23"><a href="#cb225-23" aria-hidden="true" tabindex="-1"></a>    yval <span class="op">=</span> bar.get_height()</span>
<span id="cb225-24"><a href="#cb225-24" aria-hidden="true" tabindex="-1"></a>    plt.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="dv">2</span>, yval, <span class="bu">round</span>(yval, <span class="dv">2</span>), ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb225-25"><a href="#cb225-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-26"><a href="#cb225-26" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb225-27"><a href="#cb225-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Analyzing these data we can understand that, in case the service is Via gomma or Corriere espresso, do not accept packages during the weekend. These data can be used to create the prediction algorithm.</p>
</section>
</section>
<section id="we-divide-the-final-file-into-3-according-to-where-the-orders-start-and-arrive" class="level2">
<h2 class="anchored" data-anchor-id="we-divide-the-final-file-into-3-according-to-where-the-orders-start-and-arrive">We divide the final file into 3 according to where the orders start and arrive</h2>
<div id="5c64ddc2-2feb-4aeb-998e-7b553d3c3b00" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> split_csv(input_file):</span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the CSV file</span></span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(input_file)</span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for IT-IT deliveries</span></span>
<span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a>    it_it <span class="op">=</span> df[(df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>)]</span>
<span id="cb226-7"><a href="#cb226-7" aria-hidden="true" tabindex="-1"></a>    it_it.to_csv(<span class="st">'final_delivery_data_it_it.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb226-8"><a href="#cb226-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb226-9"><a href="#cb226-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for US-US deliveries</span></span>
<span id="cb226-10"><a href="#cb226-10" aria-hidden="true" tabindex="-1"></a>    us_us <span class="op">=</span> df[(df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>)]</span>
<span id="cb226-11"><a href="#cb226-11" aria-hidden="true" tabindex="-1"></a>    us_us.to_csv(<span class="st">'final_delivery_data_us_us.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb226-12"><a href="#cb226-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb226-13"><a href="#cb226-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for mixed IT-US or US-IT deliveries</span></span>
<span id="cb226-14"><a href="#cb226-14" aria-hidden="true" tabindex="-1"></a>    mixed <span class="op">=</span> df[</span>
<span id="cb226-15"><a href="#cb226-15" aria-hidden="true" tabindex="-1"></a>        ((df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>)) <span class="op">|</span></span>
<span id="cb226-16"><a href="#cb226-16" aria-hidden="true" tabindex="-1"></a>        ((df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>))</span>
<span id="cb226-17"><a href="#cb226-17" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb226-18"><a href="#cb226-18" aria-hidden="true" tabindex="-1"></a>    mixed.to_csv(<span class="st">'final_delivery_data_mixed.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb226-19"><a href="#cb226-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb226-20"><a href="#cb226-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print summary</span></span>
<span id="cb226-21"><a href="#cb226-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"IT-IT deliveries: </span><span class="sc">{</span><span class="bu">len</span>(it_it)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb226-22"><a href="#cb226-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"US-US deliveries: </span><span class="sc">{</span><span class="bu">len</span>(us_us)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb226-23"><a href="#cb226-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mixed deliveries: </span><span class="sc">{</span><span class="bu">len</span>(mixed)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb226-24"><a href="#cb226-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-25"><a href="#cb226-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the splitting</span></span>
<span id="cb226-26"><a href="#cb226-26" aria-hidden="true" tabindex="-1"></a>split_csv(<span class="st">'final_delivery_data.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IT-IT deliveries: 11755
US-US deliveries: 2225
Mixed deliveries: 574</code></pre>
</div>
</div>
</section>
<section id="creation-of-the-travel-map" class="level2">
<h2 class="anchored" data-anchor-id="creation-of-the-travel-map">Creation of the travel map</h2>
<div id="22e05928-9c76-4586-a354-bc6263a42fbf" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_zipcode_coordinates(zipcode: <span class="bu">str</span>, country: <span class="bu">str</span>) <span class="op">-&gt;</span> Optional[Tuple[<span class="bu">float</span>, <span class="bu">float</span>]]:</span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>        geolocator <span class="op">=</span> Nominatim(user_agent<span class="op">=</span><span class="st">"delivery_route_mapper"</span>)</span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a>        location <span class="op">=</span> geolocator.geocode(<span class="ss">f"</span><span class="sc">{</span>zipcode<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>country<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> location:</span>
<span id="cb228-7"><a href="#cb228-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (location.latitude, location.longitude)</span>
<span id="cb228-8"><a href="#cb228-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb228-9"><a href="#cb228-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb228-10"><a href="#cb228-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error getting coordinates for </span><span class="sc">{</span>zipcode<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>country<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb228-11"><a href="#cb228-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb228-12"><a href="#cb228-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-13"><a href="#cb228-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> disegnaMappa(nomeFilecsv: <span class="bu">str</span>):</span>
<span id="cb228-14"><a href="#cb228-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb228-15"><a href="#cb228-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Read only first 50 rows</span></span>
<span id="cb228-16"><a href="#cb228-16" aria-hidden="true" tabindex="-1"></a>        dataSet <span class="op">=</span> pd.read_csv(nomeFilecsv, nrows<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb228-17"><a href="#cb228-17" aria-hidden="true" tabindex="-1"></a>        viaggi <span class="op">=</span> []</span>
<span id="cb228-18"><a href="#cb228-18" aria-hidden="true" tabindex="-1"></a>        citta <span class="op">=</span> {}</span>
<span id="cb228-19"><a href="#cb228-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb228-20"><a href="#cb228-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Progress bar for geocoding</span></span>
<span id="cb228-21"><a href="#cb228-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> tqdm(dataSet.iterrows(), total<span class="op">=</span>dataSet.shape[<span class="dv">0</span>], desc<span class="op">=</span><span class="ss">f"Processing </span><span class="sc">{</span>nomeFilecsv<span class="sc">}</span><span class="ss">"</span>):</span>
<span id="cb228-22"><a href="#cb228-22" aria-hidden="true" tabindex="-1"></a>            partenza <span class="op">=</span> get_zipcode_coordinates(<span class="bu">str</span>(row[<span class="st">"DEPARTURE_ZIPCODE"</span>]), row[<span class="st">"DEPARTURE_COUNTRY"</span>])</span>
<span id="cb228-23"><a href="#cb228-23" aria-hidden="true" tabindex="-1"></a>            arrivo <span class="op">=</span> get_zipcode_coordinates(<span class="bu">str</span>(row[<span class="st">"ARRIVAL_ZIPCODE"</span>]), row[<span class="st">"ARRIVAL_COUNTRY"</span>])</span>
<span id="cb228-24"><a href="#cb228-24" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb228-25"><a href="#cb228-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> arrivo <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> partenza <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb228-26"><a href="#cb228-26" aria-hidden="true" tabindex="-1"></a>                tratta <span class="op">=</span> [partenza, arrivo]</span>
<span id="cb228-27"><a href="#cb228-27" aria-hidden="true" tabindex="-1"></a>                viaggi.append(tratta)</span>
<span id="cb228-28"><a href="#cb228-28" aria-hidden="true" tabindex="-1"></a>                citta[<span class="bu">str</span>(row[<span class="st">"DEPARTURE_ZIPCODE"</span>])] <span class="op">=</span> partenza</span>
<span id="cb228-29"><a href="#cb228-29" aria-hidden="true" tabindex="-1"></a>                citta[<span class="bu">str</span>(row[<span class="st">"ARRIVAL_ZIPCODE"</span>])] <span class="op">=</span> arrivo</span>
<span id="cb228-30"><a href="#cb228-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb228-31"><a href="#cb228-31" aria-hidden="true" tabindex="-1"></a>            time.sleep(<span class="dv">1</span>)  <span class="co"># Prevent overwhelming the geocoding service</span></span>
<span id="cb228-32"><a href="#cb228-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb228-33"><a href="#cb228-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create map</span></span>
<span id="cb228-34"><a href="#cb228-34" aria-hidden="true" tabindex="-1"></a>        mappa <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="dv">45</span>, <span class="dv">10</span>], zoom_start<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb228-35"><a href="#cb228-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb228-36"><a href="#cb228-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add routes</span></span>
<span id="cb228-37"><a href="#cb228-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> viaggio <span class="kw">in</span> tqdm(viaggi, desc<span class="op">=</span><span class="st">"Adding Routes"</span>):</span>
<span id="cb228-38"><a href="#cb228-38" aria-hidden="true" tabindex="-1"></a>            folium.PolyLine(viaggio, color<span class="op">=</span><span class="st">"blue"</span>, weight<span class="op">=</span><span class="dv">2</span>, opacity<span class="op">=</span><span class="fl">0.7</span>).add_to(mappa)</span>
<span id="cb228-39"><a href="#cb228-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb228-40"><a href="#cb228-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add markers</span></span>
<span id="cb228-41"><a href="#cb228-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> nome, coord <span class="kw">in</span> tqdm(citta.items(), desc<span class="op">=</span><span class="st">"Adding Markers"</span>):</span>
<span id="cb228-42"><a href="#cb228-42" aria-hidden="true" tabindex="-1"></a>            folium.Marker(coord, popup<span class="op">=</span>nome, icon<span class="op">=</span>folium.Icon(color<span class="op">=</span><span class="st">"red"</span>)).add_to(mappa)</span>
<span id="cb228-43"><a href="#cb228-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb228-44"><a href="#cb228-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save map in current directory</span></span>
<span id="cb228-45"><a href="#cb228-45" aria-hidden="true" tabindex="-1"></a>        output_name <span class="op">=</span> os.path.splitext(nomeFilecsv)[<span class="dv">0</span>] <span class="op">+</span> <span class="st">'_sample.html'</span></span>
<span id="cb228-46"><a href="#cb228-46" aria-hidden="true" tabindex="-1"></a>        mappa.save(output_name)</span>
<span id="cb228-47"><a href="#cb228-47" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Sample map successfully created: </span><span class="sc">{</span>output_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb228-48"><a href="#cb228-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb228-49"><a href="#cb228-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb228-50"><a href="#cb228-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb228-51"><a href="#cb228-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error processing </span><span class="sc">{</span>nomeFilecsv<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb228-52"><a href="#cb228-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb228-53"><a href="#cb228-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-54"><a href="#cb228-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb228-55"><a href="#cb228-55" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> [</span>
<span id="cb228-56"><a href="#cb228-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">'final_delivery_data_it_it.csv'</span>,</span>
<span id="cb228-57"><a href="#cb228-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">'final_delivery_data_us_us.csv'</span>, </span>
<span id="cb228-58"><a href="#cb228-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">'final_delivery_data_mixed.csv'</span></span>
<span id="cb228-59"><a href="#cb228-59" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb228-60"><a href="#cb228-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-61"><a href="#cb228-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb228-62"><a href="#cb228-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.exists(<span class="bu">file</span>):</span>
<span id="cb228-63"><a href="#cb228-63" aria-hidden="true" tabindex="-1"></a>            disegnaMappa(<span class="bu">file</span>)</span>
<span id="cb228-64"><a href="#cb228-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb228-65"><a href="#cb228-65" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"File not found: </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb228-66"><a href="#cb228-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-67"><a href="#cb228-67" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb228-68"><a href="#cb228-68" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing final_delivery_data_it_it.csv: 100%|██████████| 50/50 [02:09&lt;00:00,  2.59s/it]
Adding Routes: 100%|██████████| 50/50 [00:00&lt;00:00, 46644.84it/s]
Adding Markers: 100%|██████████| 36/36 [00:00&lt;00:00, 18450.02it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample map successfully created: final_delivery_data_it_it_sample.html</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing final_delivery_data_us_us.csv: 100%|██████████| 50/50 [02:13&lt;00:00,  2.68s/it]
Adding Routes: 100%|██████████| 50/50 [00:00&lt;00:00, 53052.16it/s]
Adding Markers: 100%|██████████| 59/59 [00:00&lt;00:00, 8544.73it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample map successfully created: final_delivery_data_us_us_sample.html</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing final_delivery_data_mixed.csv: 100%|██████████| 50/50 [02:13&lt;00:00,  2.66s/it]
Adding Routes: 100%|██████████| 50/50 [00:00&lt;00:00, 47814.68it/s]
Adding Markers: 100%|██████████| 49/49 [00:00&lt;00:00, 25530.55it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample map successfully created: final_delivery_data_mixed_sample.html</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
</section>
<section id="finally-we-create-a-code-to-predict-the-distance-in-km-and-delivery-time" class="level2">
<h2 class="anchored" data-anchor-id="finally-we-create-a-code-to-predict-the-distance-in-km-and-delivery-time">Finally we create a code to predict the distance in km and delivery time</h2>
<div id="a009274d-8c90-463b-8701-6dbacad9b7be" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DeliveryPredictor:</span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.le_service <span class="op">=</span> LabelEncoder()</span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.le_vehicle <span class="op">=</span> LabelEncoder()</span>
<span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.le_dep_country <span class="op">=</span> LabelEncoder()</span>
<span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.le_arr_country <span class="op">=</span> LabelEncoder()</span>
<span id="cb236-7"><a href="#cb236-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.le_dep_zip <span class="op">=</span> LabelEncoder()</span>
<span id="cb236-8"><a href="#cb236-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.le_arr_zip <span class="op">=</span> LabelEncoder()</span>
<span id="cb236-9"><a href="#cb236-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scaler <span class="op">=</span> RobustScaler()</span>
<span id="cb236-10"><a href="#cb236-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.imputer <span class="op">=</span> SimpleImputer(strategy<span class="op">=</span><span class="st">'median'</span>)</span>
<span id="cb236-11"><a href="#cb236-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.distance_model <span class="op">=</span> GradientBoostingRegressor(</span>
<span id="cb236-12"><a href="#cb236-12" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb236-13"><a href="#cb236-13" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb236-14"><a href="#cb236-14" aria-hidden="true" tabindex="-1"></a>            max_depth<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb236-15"><a href="#cb236-15" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb236-16"><a href="#cb236-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb236-17"><a href="#cb236-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.time_model <span class="op">=</span> GradientBoostingRegressor(</span>
<span id="cb236-18"><a href="#cb236-18" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb236-19"><a href="#cb236-19" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb236-20"><a href="#cb236-20" aria-hidden="true" tabindex="-1"></a>            max_depth<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb236-21"><a href="#cb236-21" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb236-22"><a href="#cb236-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb236-23"><a href="#cb236-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.unique_values <span class="op">=</span> {}</span>
<span id="cb236-24"><a href="#cb236-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-25"><a href="#cb236-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> prepare_data(<span class="va">self</span>, df):</span>
<span id="cb236-26"><a href="#cb236-26" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.copy()</span>
<span id="cb236-27"><a href="#cb236-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-28"><a href="#cb236-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Clean zip codes</span></span>
<span id="cb236-29"><a href="#cb236-29" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'DEPARTURE_ZIPCODE'</span>] <span class="op">=</span> df[<span class="st">'DEPARTURE_ZIPCODE'</span>].fillna(<span class="st">'00000'</span>)</span>
<span id="cb236-30"><a href="#cb236-30" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ARRIVAL_ZIPCODE'</span>] <span class="op">=</span> df[<span class="st">'ARRIVAL_ZIPCODE'</span>].fillna(<span class="st">'00000'</span>)</span>
<span id="cb236-31"><a href="#cb236-31" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'DEPARTURE_ZIPCODE'</span>] <span class="op">=</span> df[<span class="st">'DEPARTURE_ZIPCODE'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.replace(<span class="st">'.0'</span>, <span class="st">''</span>).<span class="bu">str</span>.zfill(<span class="dv">5</span>)</span>
<span id="cb236-32"><a href="#cb236-32" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ARRIVAL_ZIPCODE'</span>] <span class="op">=</span> df[<span class="st">'ARRIVAL_ZIPCODE'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.replace(<span class="st">'.0'</span>, <span class="st">''</span>).<span class="bu">str</span>.zfill(<span class="dv">5</span>)</span>
<span id="cb236-33"><a href="#cb236-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-34"><a href="#cb236-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove rows with NaN in critical columns</span></span>
<span id="cb236-35"><a href="#cb236-35" aria-hidden="true" tabindex="-1"></a>        critical_columns <span class="op">=</span> [<span class="st">'DELIVERY_TIME_HH'</span>, <span class="st">'DECLARED_DISTANCE_KM'</span>, <span class="st">'SERVICETYPE'</span>, <span class="st">'VEHICLETYPE'</span>, </span>
<span id="cb236-36"><a href="#cb236-36" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'DEPARTURE_COUNTRY'</span>, <span class="st">'ARRIVAL_COUNTRY'</span>, <span class="st">'WDAY'</span>]</span>
<span id="cb236-37"><a href="#cb236-37" aria-hidden="true" tabindex="-1"></a>        df.dropna(subset<span class="op">=</span>critical_columns, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb236-38"><a href="#cb236-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-39"><a href="#cb236-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove outliers from delivery time</span></span>
<span id="cb236-40"><a href="#cb236-40" aria-hidden="true" tabindex="-1"></a>        q1 <span class="op">=</span> df[<span class="st">'DELIVERY_TIME_HH'</span>].quantile(<span class="fl">0.25</span>)</span>
<span id="cb236-41"><a href="#cb236-41" aria-hidden="true" tabindex="-1"></a>        q3 <span class="op">=</span> df[<span class="st">'DELIVERY_TIME_HH'</span>].quantile(<span class="fl">0.75</span>)</span>
<span id="cb236-42"><a href="#cb236-42" aria-hidden="true" tabindex="-1"></a>        iqr <span class="op">=</span> q3 <span class="op">-</span> q1</span>
<span id="cb236-43"><a href="#cb236-43" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[</span>
<span id="cb236-44"><a href="#cb236-44" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'DELIVERY_TIME_HH'</span>] <span class="op">&gt;=</span> q1 <span class="op">-</span> <span class="fl">1.5</span> <span class="op">*</span> iqr) <span class="op">&amp;</span> </span>
<span id="cb236-45"><a href="#cb236-45" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'DELIVERY_TIME_HH'</span>] <span class="op">&lt;=</span> q3 <span class="op">+</span> <span class="fl">1.5</span> <span class="op">*</span> iqr)</span>
<span id="cb236-46"><a href="#cb236-46" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb236-47"><a href="#cb236-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-48"><a href="#cb236-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add derived features</span></span>
<span id="cb236-49"><a href="#cb236-49" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'SAME_COUNTRY'</span>] <span class="op">=</span> (df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> df[<span class="st">'ARRIVAL_COUNTRY'</span>]).astype(<span class="bu">int</span>)</span>
<span id="cb236-50"><a href="#cb236-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-51"><a href="#cb236-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Encode categorical variables</span></span>
<span id="cb236-52"><a href="#cb236-52" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'SERVICETYPE_encoded'</span>] <span class="op">=</span> <span class="va">self</span>.le_service.fit_transform(df[<span class="st">'SERVICETYPE'</span>])</span>
<span id="cb236-53"><a href="#cb236-53" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'VEHICLETYPE_encoded'</span>] <span class="op">=</span> <span class="va">self</span>.le_vehicle.fit_transform(df[<span class="st">'VEHICLETYPE'</span>])</span>
<span id="cb236-54"><a href="#cb236-54" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'DEPARTURE_COUNTRY_encoded'</span>] <span class="op">=</span> <span class="va">self</span>.le_dep_country.fit_transform(df[<span class="st">'DEPARTURE_COUNTRY'</span>])</span>
<span id="cb236-55"><a href="#cb236-55" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ARRIVAL_COUNTRY_encoded'</span>] <span class="op">=</span> <span class="va">self</span>.le_arr_country.fit_transform(df[<span class="st">'ARRIVAL_COUNTRY'</span>])</span>
<span id="cb236-56"><a href="#cb236-56" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'DEPARTURE_ZIPCODE_encoded'</span>] <span class="op">=</span> <span class="va">self</span>.le_dep_zip.fit_transform(df[<span class="st">'DEPARTURE_ZIPCODE'</span>])</span>
<span id="cb236-57"><a href="#cb236-57" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ARRIVAL_ZIPCODE_encoded'</span>] <span class="op">=</span> <span class="va">self</span>.le_arr_zip.fit_transform(df[<span class="st">'ARRIVAL_ZIPCODE'</span>])</span>
<span id="cb236-58"><a href="#cb236-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-59"><a href="#cb236-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store unique values</span></span>
<span id="cb236-60"><a href="#cb236-60" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.unique_values <span class="op">=</span> {</span>
<span id="cb236-61"><a href="#cb236-61" aria-hidden="true" tabindex="-1"></a>            <span class="st">'service_types'</span>: df[<span class="st">'SERVICETYPE'</span>].unique(),</span>
<span id="cb236-62"><a href="#cb236-62" aria-hidden="true" tabindex="-1"></a>            <span class="st">'vehicle_types'</span>: df[<span class="st">'VEHICLETYPE'</span>].unique(),</span>
<span id="cb236-63"><a href="#cb236-63" aria-hidden="true" tabindex="-1"></a>            <span class="st">'departure_countries'</span>: df[<span class="st">'DEPARTURE_COUNTRY'</span>].unique(),</span>
<span id="cb236-64"><a href="#cb236-64" aria-hidden="true" tabindex="-1"></a>            <span class="st">'arrival_countries'</span>: df[<span class="st">'ARRIVAL_COUNTRY'</span>].unique(),</span>
<span id="cb236-65"><a href="#cb236-65" aria-hidden="true" tabindex="-1"></a>            <span class="st">'departure_zipcodes'</span>: df[<span class="st">'DEPARTURE_ZIPCODE'</span>].unique(),</span>
<span id="cb236-66"><a href="#cb236-66" aria-hidden="true" tabindex="-1"></a>            <span class="st">'arrival_zipcodes'</span>: df[<span class="st">'ARRIVAL_ZIPCODE'</span>].unique()</span>
<span id="cb236-67"><a href="#cb236-67" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb236-68"><a href="#cb236-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-69"><a href="#cb236-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare features</span></span>
<span id="cb236-70"><a href="#cb236-70" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> [</span>
<span id="cb236-71"><a href="#cb236-71" aria-hidden="true" tabindex="-1"></a>            <span class="st">'SERVICETYPE_encoded'</span>, <span class="st">'VEHICLETYPE_encoded'</span>, </span>
<span id="cb236-72"><a href="#cb236-72" aria-hidden="true" tabindex="-1"></a>            <span class="st">'DEPARTURE_COUNTRY_encoded'</span>, <span class="st">'ARRIVAL_COUNTRY_encoded'</span>,</span>
<span id="cb236-73"><a href="#cb236-73" aria-hidden="true" tabindex="-1"></a>            <span class="st">'DEPARTURE_ZIPCODE_encoded'</span>, <span class="st">'ARRIVAL_ZIPCODE_encoded'</span>, </span>
<span id="cb236-74"><a href="#cb236-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">'WDAY'</span>, <span class="st">'SAME_COUNTRY'</span></span>
<span id="cb236-75"><a href="#cb236-75" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb236-76"><a href="#cb236-76" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-77"><a href="#cb236-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add DISTANCE_ENCODED</span></span>
<span id="cb236-78"><a href="#cb236-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'DECLARED_DISTANCE_KM'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb236-79"><a href="#cb236-79" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'DISTANCE_ENCODED'</span>] <span class="op">=</span> <span class="va">self</span>.scaler.fit_transform(df[[<span class="st">'DECLARED_DISTANCE_KM'</span>]])</span>
<span id="cb236-80"><a href="#cb236-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb236-81"><a href="#cb236-81" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'DISTANCE_ENCODED'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb236-82"><a href="#cb236-82" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-83"><a href="#cb236-83" aria-hidden="true" tabindex="-1"></a>        features.append(<span class="st">'DISTANCE_ENCODED'</span>)</span>
<span id="cb236-84"><a href="#cb236-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-85"><a href="#cb236-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare X with imputation</span></span>
<span id="cb236-86"><a href="#cb236-86" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> df[features].values</span>
<span id="cb236-87"><a href="#cb236-87" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> <span class="va">self</span>.imputer.fit_transform(X)  <span class="co"># Impute missing values</span></span>
<span id="cb236-88"><a href="#cb236-88" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> <span class="va">self</span>.scaler.fit_transform(X)</span>
<span id="cb236-89"><a href="#cb236-89" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-90"><a href="#cb236-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> X, df</span>
<span id="cb236-91"><a href="#cb236-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-92"><a href="#cb236-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> train(<span class="va">self</span>, data_path):</span>
<span id="cb236-93"><a href="#cb236-93" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load data</span></span>
<span id="cb236-94"><a href="#cb236-94" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.read_csv(data_path)</span>
<span id="cb236-95"><a href="#cb236-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-96"><a href="#cb236-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare features and targets</span></span>
<span id="cb236-97"><a href="#cb236-97" aria-hidden="true" tabindex="-1"></a>        X, df_cleaned <span class="op">=</span> <span class="va">self</span>.prepare_data(df)</span>
<span id="cb236-98"><a href="#cb236-98" aria-hidden="true" tabindex="-1"></a>        y_distance <span class="op">=</span> df_cleaned[<span class="st">'DECLARED_DISTANCE_KM'</span>].values</span>
<span id="cb236-99"><a href="#cb236-99" aria-hidden="true" tabindex="-1"></a>        y_time <span class="op">=</span> df_cleaned[<span class="st">'DELIVERY_TIME_HH'</span>].values</span>
<span id="cb236-100"><a href="#cb236-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-101"><a href="#cb236-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize delivery time</span></span>
<span id="cb236-102"><a href="#cb236-102" aria-hidden="true" tabindex="-1"></a>        y_time <span class="op">=</span> np.minimum(y_time, <span class="dv">72</span>)</span>
<span id="cb236-103"><a href="#cb236-103" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-104"><a href="#cb236-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Split data</span></span>
<span id="cb236-105"><a href="#cb236-105" aria-hidden="true" tabindex="-1"></a>        X_train, X_test, y_dist_train, y_dist_test, y_time_train, y_time_test <span class="op">=</span> train_test_split(</span>
<span id="cb236-106"><a href="#cb236-106" aria-hidden="true" tabindex="-1"></a>            X, y_distance, y_time, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb236-107"><a href="#cb236-107" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb236-108"><a href="#cb236-108" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-109"><a href="#cb236-109" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train models</span></span>
<span id="cb236-110"><a href="#cb236-110" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.distance_model.fit(X_train, y_dist_train)</span>
<span id="cb236-111"><a href="#cb236-111" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.time_model.fit(X_train, y_time_train)</span>
<span id="cb236-112"><a href="#cb236-112" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-113"><a href="#cb236-113" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate accuracy</span></span>
<span id="cb236-114"><a href="#cb236-114" aria-hidden="true" tabindex="-1"></a>        dist_accuracy <span class="op">=</span> r2_score(y_dist_test, <span class="va">self</span>.distance_model.predict(X_test))</span>
<span id="cb236-115"><a href="#cb236-115" aria-hidden="true" tabindex="-1"></a>        time_accuracy <span class="op">=</span> r2_score(y_time_test, <span class="va">self</span>.time_model.predict(X_test))</span>
<span id="cb236-116"><a href="#cb236-116" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-117"><a href="#cb236-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dist_accuracy, time_accuracy</span>
<span id="cb236-118"><a href="#cb236-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-119"><a href="#cb236-119" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> custom_round(<span class="va">self</span>, number):</span>
<span id="cb236-120"><a href="#cb236-120" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Custom rounding function based on decimal part"""</span></span>
<span id="cb236-121"><a href="#cb236-121" aria-hidden="true" tabindex="-1"></a>        decimal_part <span class="op">=</span> number <span class="op">%</span> <span class="dv">1</span></span>
<span id="cb236-122"><a href="#cb236-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> decimal_part <span class="op">&gt;=</span> <span class="fl">0.5</span>:</span>
<span id="cb236-123"><a href="#cb236-123" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.ceil(number)</span>
<span id="cb236-124"><a href="#cb236-124" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.floor(number)</span>
<span id="cb236-125"><a href="#cb236-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb236-126"><a href="#cb236-126" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, service_type, vehicle_type, departure_country, arrival_country,</span>
<span id="cb236-127"><a href="#cb236-127" aria-hidden="true" tabindex="-1"></a>                departure_zipcode, arrival_zipcode, departure_date):</span>
<span id="cb236-128"><a href="#cb236-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert departure_date to weekday</span></span>
<span id="cb236-129"><a href="#cb236-129" aria-hidden="true" tabindex="-1"></a>        departure_dt <span class="op">=</span> datetime.strptime(departure_date, <span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb236-130"><a href="#cb236-130" aria-hidden="true" tabindex="-1"></a>        wday <span class="op">=</span> departure_dt.weekday()</span>
<span id="cb236-131"><a href="#cb236-131" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-132"><a href="#cb236-132" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert zip codes to strings with leading zeros</span></span>
<span id="cb236-133"><a href="#cb236-133" aria-hidden="true" tabindex="-1"></a>        departure_zipcode <span class="op">=</span> <span class="bu">str</span>(departure_zipcode).replace(<span class="st">'.0'</span>, <span class="st">''</span>).zfill(<span class="dv">5</span>)</span>
<span id="cb236-134"><a href="#cb236-134" aria-hidden="true" tabindex="-1"></a>        arrival_zipcode <span class="op">=</span> <span class="bu">str</span>(arrival_zipcode).replace(<span class="st">'.0'</span>, <span class="st">''</span>).zfill(<span class="dv">5</span>)</span>
<span id="cb236-135"><a href="#cb236-135" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-136"><a href="#cb236-136" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate same country feature</span></span>
<span id="cb236-137"><a href="#cb236-137" aria-hidden="true" tabindex="-1"></a>        same_country <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> departure_country <span class="op">==</span> arrival_country <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb236-138"><a href="#cb236-138" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-139"><a href="#cb236-139" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare input data</span></span>
<span id="cb236-140"><a href="#cb236-140" aria-hidden="true" tabindex="-1"></a>        input_data <span class="op">=</span> np.array([[</span>
<span id="cb236-141"><a href="#cb236-141" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.le_service.transform([service_type])[<span class="dv">0</span>],</span>
<span id="cb236-142"><a href="#cb236-142" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.le_vehicle.transform([vehicle_type])[<span class="dv">0</span>],</span>
<span id="cb236-143"><a href="#cb236-143" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.le_dep_country.transform([departure_country])[<span class="dv">0</span>],</span>
<span id="cb236-144"><a href="#cb236-144" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.le_arr_country.transform([arrival_country])[<span class="dv">0</span>],</span>
<span id="cb236-145"><a href="#cb236-145" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.le_dep_zip.transform([departure_zipcode])[<span class="dv">0</span>],</span>
<span id="cb236-146"><a href="#cb236-146" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.le_arr_zip.transform([arrival_zipcode])[<span class="dv">0</span>],</span>
<span id="cb236-147"><a href="#cb236-147" aria-hidden="true" tabindex="-1"></a>            wday,</span>
<span id="cb236-148"><a href="#cb236-148" aria-hidden="true" tabindex="-1"></a>            same_country,</span>
<span id="cb236-149"><a href="#cb236-149" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span>  <span class="co"># Default DISTANCE_ENCODED</span></span>
<span id="cb236-150"><a href="#cb236-150" aria-hidden="true" tabindex="-1"></a>        ]])</span>
<span id="cb236-151"><a href="#cb236-151" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-152"><a href="#cb236-152" aria-hidden="true" tabindex="-1"></a>        input_scaled <span class="op">=</span> <span class="va">self</span>.scaler.transform(input_data)</span>
<span id="cb236-153"><a href="#cb236-153" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-154"><a href="#cb236-154" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Make predictions</span></span>
<span id="cb236-155"><a href="#cb236-155" aria-hidden="true" tabindex="-1"></a>        predicted_distance <span class="op">=</span> <span class="va">self</span>.distance_model.predict(input_scaled)[<span class="dv">0</span>]</span>
<span id="cb236-156"><a href="#cb236-156" aria-hidden="true" tabindex="-1"></a>        model_predicted_hours <span class="op">=</span> <span class="va">self</span>.time_model.predict(input_scaled)[<span class="dv">0</span>]</span>
<span id="cb236-157"><a href="#cb236-157" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-158"><a href="#cb236-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limit predicted hours from model</span></span>
<span id="cb236-159"><a href="#cb236-159" aria-hidden="true" tabindex="-1"></a>        model_predicted_hours <span class="op">=</span> <span class="bu">min</span>(model_predicted_hours, <span class="dv">72</span>)</span>
<span id="cb236-160"><a href="#cb236-160" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply custom rounding to model_predicted_hours</span></span>
<span id="cb236-161"><a href="#cb236-161" aria-hidden="true" tabindex="-1"></a>        model_predicted_hours <span class="op">=</span> <span class="va">self</span>.custom_round(model_predicted_hours)</span>
<span id="cb236-162"><a href="#cb236-162" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-163"><a href="#cb236-163" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate workdays and arrival date based on model_predicted_hours</span></span>
<span id="cb236-164"><a href="#cb236-164" aria-hidden="true" tabindex="-1"></a>        work_hours_per_day <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb236-165"><a href="#cb236-165" aria-hidden="true" tabindex="-1"></a>        total_workdays <span class="op">=</span> <span class="bu">int</span>(np.ceil(model_predicted_hours <span class="op">/</span> work_hours_per_day))</span>
<span id="cb236-166"><a href="#cb236-166" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-167"><a href="#cb236-167" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate arrival date considering weekends</span></span>
<span id="cb236-168"><a href="#cb236-168" aria-hidden="true" tabindex="-1"></a>        arrival_date <span class="op">=</span> departure_dt</span>
<span id="cb236-169"><a href="#cb236-169" aria-hidden="true" tabindex="-1"></a>        actual_workdays <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb236-170"><a href="#cb236-170" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-171"><a href="#cb236-171" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> actual_workdays <span class="op">&lt;</span> total_workdays:</span>
<span id="cb236-172"><a href="#cb236-172" aria-hidden="true" tabindex="-1"></a>            arrival_date <span class="op">+=</span> timedelta(days<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb236-173"><a href="#cb236-173" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Only count weekdays</span></span>
<span id="cb236-174"><a href="#cb236-174" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> arrival_date.weekday() <span class="op">&lt;</span> <span class="dv">7</span>:  <span class="co"># Monday = 0, Friday = 4</span></span>
<span id="cb236-175"><a href="#cb236-175" aria-hidden="true" tabindex="-1"></a>                actual_workdays <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb236-176"><a href="#cb236-176" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-177"><a href="#cb236-177" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Adjust arrival date for weekend only for non-E-commerce services</span></span>
<span id="cb236-178"><a href="#cb236-178" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> service_type <span class="kw">not</span> <span class="kw">in</span> [<span class="st">"E-commerce"</span>, <span class="st">"E-commerce resi"</span>]:</span>
<span id="cb236-179"><a href="#cb236-179" aria-hidden="true" tabindex="-1"></a>            arrival_weekday <span class="op">=</span> arrival_date.weekday()</span>
<span id="cb236-180"><a href="#cb236-180" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> arrival_weekday <span class="op">==</span> <span class="dv">5</span>:  <span class="co"># Saturday</span></span>
<span id="cb236-181"><a href="#cb236-181" aria-hidden="true" tabindex="-1"></a>                arrival_date <span class="op">+=</span> timedelta(days<span class="op">=</span><span class="dv">2</span>)  <span class="co"># Move to Monday</span></span>
<span id="cb236-182"><a href="#cb236-182" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> arrival_weekday <span class="op">==</span> <span class="dv">6</span>:  <span class="co"># Sunday</span></span>
<span id="cb236-183"><a href="#cb236-183" aria-hidden="true" tabindex="-1"></a>                arrival_date <span class="op">+=</span> timedelta(days<span class="op">=</span><span class="dv">1</span>)  <span class="co"># Move to Monday</span></span>
<span id="cb236-184"><a href="#cb236-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-185"><a href="#cb236-185" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate actual hours between dates</span></span>
<span id="cb236-186"><a href="#cb236-186" aria-hidden="true" tabindex="-1"></a>        total_days <span class="op">=</span> (arrival_date <span class="op">-</span> departure_dt).days</span>
<span id="cb236-187"><a href="#cb236-187" aria-hidden="true" tabindex="-1"></a>        predicted_hours <span class="op">=</span> total_days <span class="op">*</span> <span class="dv">24</span>  <span class="co"># Convert days to hours</span></span>
<span id="cb236-188"><a href="#cb236-188" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-189"><a href="#cb236-189" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb236-190"><a href="#cb236-190" aria-hidden="true" tabindex="-1"></a>            <span class="st">'predicted_distance_km'</span>: <span class="bu">round</span>(predicted_distance, <span class="dv">2</span>),</span>
<span id="cb236-191"><a href="#cb236-191" aria-hidden="true" tabindex="-1"></a>            <span class="st">'predicted_hours'</span>: predicted_hours,</span>
<span id="cb236-192"><a href="#cb236-192" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_work_hours'</span>: model_predicted_hours,  <span class="co"># Using the rounded model prediction</span></span>
<span id="cb236-193"><a href="#cb236-193" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_work_days'</span>: total_workdays,</span>
<span id="cb236-194"><a href="#cb236-194" aria-hidden="true" tabindex="-1"></a>            <span class="st">'predicted_arrival_date'</span>: arrival_date.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>),</span>
<span id="cb236-195"><a href="#cb236-195" aria-hidden="true" tabindex="-1"></a>            <span class="st">'weekend_adjusted'</span>: arrival_date.weekday() <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> departure_dt.weekday() <span class="op">&lt;</span> <span class="dv">5</span></span>
<span id="cb236-196"><a href="#cb236-196" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb236-197"><a href="#cb236-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-198"><a href="#cb236-198" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb236-199"><a href="#cb236-199" aria-hidden="true" tabindex="-1"></a>    predictor <span class="op">=</span> DeliveryPredictor()</span>
<span id="cb236-200"><a href="#cb236-200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training</span></span>
<span id="cb236-201"><a href="#cb236-201" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb236-202"><a href="#cb236-202" aria-hidden="true" tabindex="-1"></a>        dist_acc, time_acc <span class="op">=</span> predictor.train(<span class="st">"final_delivery_data.csv"</span>)</span>
<span id="cb236-203"><a href="#cb236-203" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Distance model accuracy: </span><span class="sc">{</span>dist_acc<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb236-204"><a href="#cb236-204" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Time model accuracy: </span><span class="sc">{</span>time_acc<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb236-205"><a href="#cb236-205" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-206"><a href="#cb236-206" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Example prediction</span></span>
<span id="cb236-207"><a href="#cb236-207" aria-hidden="true" tabindex="-1"></a>        prediction <span class="op">=</span> predictor.predict(</span>
<span id="cb236-208"><a href="#cb236-208" aria-hidden="true" tabindex="-1"></a>            service_type<span class="op">=</span><span class="st">"Corriere espresso"</span>,</span>
<span id="cb236-209"><a href="#cb236-209" aria-hidden="true" tabindex="-1"></a>            vehicle_type<span class="op">=</span><span class="st">"Express"</span>,</span>
<span id="cb236-210"><a href="#cb236-210" aria-hidden="true" tabindex="-1"></a>            departure_country<span class="op">=</span><span class="st">"IT"</span>,</span>
<span id="cb236-211"><a href="#cb236-211" aria-hidden="true" tabindex="-1"></a>            arrival_country<span class="op">=</span><span class="st">"IT"</span>,</span>
<span id="cb236-212"><a href="#cb236-212" aria-hidden="true" tabindex="-1"></a>            departure_zipcode<span class="op">=</span><span class="st">"62010"</span>,</span>
<span id="cb236-213"><a href="#cb236-213" aria-hidden="true" tabindex="-1"></a>            arrival_zipcode<span class="op">=</span><span class="st">"22100"</span>,</span>
<span id="cb236-214"><a href="#cb236-214" aria-hidden="true" tabindex="-1"></a>            departure_date<span class="op">=</span><span class="st">"2023-01-10"</span></span>
<span id="cb236-215"><a href="#cb236-215" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb236-216"><a href="#cb236-216" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-217"><a href="#cb236-217" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Prediction:"</span>)</span>
<span id="cb236-218"><a href="#cb236-218" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> prediction.items():</span>
<span id="cb236-219"><a href="#cb236-219" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>key<span class="sc">.</span>replace(<span class="st">'_'</span>, <span class="st">' '</span>)<span class="sc">.</span>title()<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb236-220"><a href="#cb236-220" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb236-221"><a href="#cb236-221" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb236-222"><a href="#cb236-222" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Error: 'final_delivery_data.csv' not found. Please ensure the data file exists."</span>)</span>
<span id="cb236-223"><a href="#cb236-223" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb236-224"><a href="#cb236-224" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"An error occurred: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb236-225"><a href="#cb236-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-226"><a href="#cb236-226" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb236-227"><a href="#cb236-227" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Distance model accuracy: 100.00%
Time model accuracy: 55.95%

Prediction:
Predicted Distance Km: 427.3
Predicted Hours: 144
Total Work Hours: 31.0
Total Work Days: 4
Predicted Arrival Date: 2023-01-16
Weekend Adjusted: True</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>