<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Logistics Dataset Analysis - Tesisquare</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="Tesisquare_analysis_files/libs/clipboard/clipboard.min.js"></script>
<script src="Tesisquare_analysis_files/libs/quarto-html/quarto.js"></script>
<script src="Tesisquare_analysis_files/libs/quarto-html/popper.min.js"></script>
<script src="Tesisquare_analysis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Tesisquare_analysis_files/libs/quarto-html/anchor.min.js"></script>
<link href="Tesisquare_analysis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Tesisquare_analysis_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Tesisquare_analysis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Tesisquare_analysis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Tesisquare_analysis_files/libs/bootstrap/bootstrap-f758803aef84f450eeed3112be2e0b7f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Logistics Dataset Analysis - Tesisquare</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This document provides an overview of the analysis conducted on a dataset provided by the company <strong>Tesisquare</strong>.</p>
<p>The goal of our work was to understand trends and issues within logistics operations, performing a thorough analysis to identify patterns and areas for improvement.</p>
</section>
<section id="analysis-details" class="level2">
<h2 class="anchored" data-anchor-id="analysis-details">Analysis Details</h2>
<p>The dataset includes various variables, such as: - <strong>Delivery Times</strong>: analysis of the time taken for deliveries, considering both distance and work time.</p>
<p>We applied statistical analysis, machine learning techniques, and data visualization to uncover optimization opportunities.</p>
</section>
<section id="project-team" class="level2">
<h2 class="anchored" data-anchor-id="project-team">Project Team</h2>
<p>The project was carried out by a team of four members, each with specific expertise and responsibilities in the analysis process. The team consists of:</p>
<ul>
<li><strong>Solaro Federico</strong>:</li>
<li><strong>Fechino Alessia</strong></li>
<li><strong>Gondolo Filippo</strong></li>
<li><strong>Isoardo Jason</strong></li>
<li><strong>Fino Vittorio</strong></li>
</ul>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>The analysis of the dataset revealed several areas with patterns such as longer delivery times near weekends and great majority of orders were in e-commerce, thanks to the data provided the group created a LM to predict distance and time spent for delivery from 2 ZIP codes (departure-arrival).</p>
</section>
<section id="acknowledgments" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgments">Acknowledgments</h2>
<p>We would like to thank <strong>Tesisquare</strong> for providing the dataset and for giving us the opportunity to work on this project.</p>
</section>
<section id="project" class="level1">
<h1>PROJECT</h1>
<p>first of all we need to install all the libraries needed</p>
<div id="0ee3b7c4-934f-41c6-b21e-c5ad903be1bc" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">'''</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">Libraries versions</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">pandas: 2.2.3</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">numpy: 2.2.2</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">seaborn 0.13.2</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">matplotlib: 3.10.0</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">scikit-learn: 1.6.1</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">geopy: 2.4.1</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">tqdm: 4.67.1</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">requests: 2.32.3</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">folium: 0.19.4</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">'''</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder, StandardScaler</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score, classification_report</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, TransformerMixin</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> GradientBoostingRegressor</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> RobustScaler</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geopy.geocoders <span class="im">import</span> Nominatim</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional, Tuple</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mpu</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geopy.distance <span class="im">import</span> geodesic</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="reading-of-the-csv-file-and-dataset-information" class="level2">
<h2 class="anchored" data-anchor-id="reading-of-the-csv-file-and-dataset-information">Reading of the csv file and dataset information</h2>
<div id="b2d15bf1-f8b2-4d3d-be65-bc9c14a5e764" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Loading the dataset from a CSV file</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(<span class="st">"./delivery_data.csv"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Displaying dataset information (column types, non-null values, etc.)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>data.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 14554 entries, 0 to 14553
Data columns (total 15 columns):
 #   Column                Non-Null Count  Dtype  
---  ------                --------------  -----  
 0   Unnamed: 0            14554 non-null  int64  
 1   SERVICETYPE           14340 non-null  object 
 2   VEHICLETYPE           14331 non-null  object 
 3   DEPARTURE_COUNTRY     14554 non-null  object 
 4   DEPARTURE_ZIPCODE     14548 non-null  float64
 5   ARRIVAL_COUNTRY       14554 non-null  object 
 6   ARRIVAL_ZIPCODE       14554 non-null  int64  
 7   SHIPPING_DATE         14554 non-null  object 
 8   GROSS_WEIGHT_KG       14554 non-null  float64
 9   NET_WEIGHT_KG         14554 non-null  float64
 10  VOLUME_M3             14554 non-null  float64
 11  DECLARED_DISTANCE_KM  11577 non-null  float64
 12  ACTUAL_DELIVERY_DATE  14554 non-null  object 
 13  DELIVERY_TIME_HH      14554 non-null  int64  
 14  WDAY                  14554 non-null  int64  
dtypes: float64(5), int64(4), object(6)
memory usage: 1.7+ MB</code></pre>
</div>
</div>
<p>First let’s see how many rows and columns our dataset is made up of. Next we look at what kind of features are and check in which columns the data is missing</p>
<div id="25c43dac-b978-4a5c-9cd1-d27f98caedf7" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Displaying summary statistics of the dataset</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>data.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Unnamed: 0</th>
<th data-quarto-table-cell-role="th">DEPARTURE_ZIPCODE</th>
<th data-quarto-table-cell-role="th">ARRIVAL_ZIPCODE</th>
<th data-quarto-table-cell-role="th">GROSS_WEIGHT_KG</th>
<th data-quarto-table-cell-role="th">NET_WEIGHT_KG</th>
<th data-quarto-table-cell-role="th">VOLUME_M3</th>
<th data-quarto-table-cell-role="th">DECLARED_DISTANCE_KM</th>
<th data-quarto-table-cell-role="th">DELIVERY_TIME_HH</th>
<th data-quarto-table-cell-role="th">WDAY</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>14554.000000</td>
<td>14548.000000</td>
<td>14554.000000</td>
<td>14554.000000</td>
<td>14554.000000</td>
<td>14554.000000</td>
<td>11577.000000</td>
<td>14554.000000</td>
<td>14554.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>7277.500000</td>
<td>53013.321694</td>
<td>41699.581352</td>
<td>9.744264</td>
<td>8.002172</td>
<td>0.188305</td>
<td>352.646287</td>
<td>75.783633</td>
<td>1.730177</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>4201.522244</td>
<td>22512.124864</td>
<td>30222.758997</td>
<td>34.946037</td>
<td>31.718243</td>
<td>0.983377</td>
<td>166.566613</td>
<td>79.110044</td>
<td>1.507748</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>12.000000</td>
<td>10.000000</td>
<td>0.020000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.640000</td>
<td>-1344.000000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>3639.250000</td>
<td>56122.750000</td>
<td>17031.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.010000</td>
<td>223.850000</td>
<td>37.000000</td>
<td>0.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>7277.500000</td>
<td>63076.000000</td>
<td>35042.000000</td>
<td>1.370000</td>
<td>0.000000</td>
<td>0.010000</td>
<td>353.190000</td>
<td>71.000000</td>
<td>1.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>10915.750000</td>
<td>63076.000000</td>
<td>66020.000000</td>
<td>3.160000</td>
<td>2.280000</td>
<td>0.110000</td>
<td>468.690000</td>
<td>108.000000</td>
<td>3.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>14554.000000</td>
<td>99208.000000</td>
<td>99518.000000</td>
<td>1039.820000</td>
<td>948.840000</td>
<td>105.000000</td>
<td>1090.610000</td>
<td>1920.000000</td>
<td>6.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>let’s control the data and find values such as standard variation, mean, max, … for every feature</p>
</section>
<section id="lets-divide-the-dataset-in-three-based-on-servicetype" class="level2">
<h2 class="anchored" data-anchor-id="lets-divide-the-dataset-in-three-based-on-servicetype">Let’s divide the dataset in three based on SERVICETYPE</h2>
<p>Looking at the datasent information we decided to split the csv file in 3 parts concerning the different types of services e-commerce, courier and road transport</p>
<div id="439ff878-1f19-43c5-87ac-7c5937a7c86a" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the original CSV file</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'delivery_data.csv'</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Count rows with NaN in SERVICETYPE before removing them</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>nan_count <span class="op">=</span> df[<span class="st">'SERVICETYPE'</span>].isna().<span class="bu">sum</span>()</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove rows with NaN in SERVICETYPE</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">'SERVICETYPE'</span>])</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Count IT-US shipments before removing them</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>it_us_count <span class="op">=</span> (</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    ((df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>)) <span class="op">|</span> </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    ((df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>))</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>).<span class="bu">sum</span>()</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove shipments between IT and US in both directions</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>mask_it_us <span class="op">=</span> <span class="op">~</span>(</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    ((df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>)) <span class="op">|</span> </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    ((df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>))</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[mask_it_us]</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create three separate DataFrames based on SERVICETYPE</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Express Couriers</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>couriers_df <span class="op">=</span> df[df[<span class="st">'SERVICETYPE'</span>].isin([<span class="st">'Corriere espresso'</span>, <span class="st">'Corriere espresso resi'</span>])]</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Road Transport</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>road_df <span class="op">=</span> df[df[<span class="st">'SERVICETYPE'</span>] <span class="op">==</span> <span class="st">'Via gomma'</span>]</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. E-commerce</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>ecommerce_df <span class="op">=</span> df[df[<span class="st">'SERVICETYPE'</span>].isin([<span class="st">'E-commerce'</span>, <span class="st">'E-commerce Resi'</span>])]</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the DataFrames to separate CSV files</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>couriers_df.to_csv(<span class="st">'corrieri_data.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>road_df.to_csv(<span class="st">'gomma_data.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>ecommerce_df.to_csv(<span class="st">'ecommerce_data.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Print detailed statistics</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Statistics of the generated files:"</span>)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Rows in corrieri file: </span><span class="sc">{</span><span class="bu">len</span>(couriers_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rows in gomma transport file: </span><span class="sc">{</span><span class="bu">len</span>(road_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rows in e-commerce file: </span><span class="sc">{</span><span class="bu">len</span>(ecommerce_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Print removed rows count</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Rows removed due to NaN in SERVICETYPE: </span><span class="sc">{</span>nan_count<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rows removed due to IT-US shipments: </span><span class="sc">{</span>it_us_count<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Statistics of the generated files:

Rows in corrieri file: 2875
Rows in gomma transport file: 1863
Rows in e-commerce file: 9028

Rows removed due to NaN in SERVICETYPE: 214
Rows removed due to IT-US shipments: 574</code></pre>
</div>
</div>
</section>
<section id="calculation-for-the-missing-declared_distance_km-in-the-dataset" class="level2">
<h2 class="anchored" data-anchor-id="calculation-for-the-missing-declared_distance_km-in-the-dataset">Calculation for the missing DECLARED_DISTANCE_KM in the dataset</h2>
<div id="13625981-9585-48d1-9dc2-4569b0b2b619" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_osrm_distance(coord1, coord2):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Retrieves the driving distance (in km) and duration (in seconds) </span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">    between two coordinates using the OSRM API.</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> <span class="ss">f"http://router.project-osrm.org/route/v1/driving/</span><span class="sc">{</span>coord1[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>coord1[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">;</span><span class="sc">{</span>coord2[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>coord2[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(url)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> response.json()</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'routes'</span> <span class="kw">in</span> data <span class="kw">and</span> <span class="bu">len</span>(data[<span class="st">'routes'</span>]) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        distance_km <span class="op">=</span> data[<span class="st">'routes'</span>][<span class="dv">0</span>][<span class="st">'distance'</span>] <span class="op">/</span> <span class="dv">1000</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        duration_seconds <span class="op">=</span> data[<span class="st">'routes'</span>][<span class="dv">0</span>][<span class="st">'duration'</span>]</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">round</span>(distance_km, <span class="dv">2</span>), duration_seconds</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c8749380-8362-4085-ae1f-add7cf51e8b1" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_zipcode_coordinates(zipcode: <span class="bu">str</span>, country) <span class="op">-&gt;</span> Optional[Tuple[<span class="bu">float</span>, <span class="bu">float</span>]]:</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns the latitude and longitude of a given ZIP code and country using the Nominatim geocoding API.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        geolocator <span class="op">=</span> Nominatim(user_agent<span class="op">=</span><span class="st">"my_distance_calculator"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        location <span class="op">=</span> geolocator.geocode(<span class="ss">f"</span><span class="sc">{</span>zipcode<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>country<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> location:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (location.latitude, location.longitude)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2207bedc-fea0-4714-8277-241123976b2b" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_statistics(file_name, processed_rows, successful_lookups, failed_lookups):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Prints statistics on the processed dataset.</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> successful_lookups <span class="op">+</span> failed_lookups</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    success_rate <span class="op">=</span> (successful_lookups <span class="op">/</span> total <span class="op">*</span> <span class="dv">100</span>) <span class="cf">if</span> total <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    failure_rate <span class="op">=</span> (failed_lookups <span class="op">/</span> total <span class="op">*</span> <span class="dv">100</span>) <span class="cf">if</span> total <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Statistics for </span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss"> after </span><span class="sc">{</span>processed_rows<span class="sc">}</span><span class="ss"> processed rows ---"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Successful lookups: </span><span class="sc">{</span>successful_lookups<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>success_rate<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Failed lookups: </span><span class="sc">{</span>failed_lookups<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>failure_rate<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"------------------------------------------------</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fc054764-2978-48ad-964e-8362e1531938" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_dataset(filename: <span class="bu">str</span>):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Processes the dataset, calculates missing distances, and updates the CSV file.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Processing </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the dataset</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> pd.read_csv(filename)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter the DataFrame for rows where distance needs to be calculated</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    filtered_data <span class="op">=</span> data[</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        (data[<span class="st">'DECLARED_DISTANCE_KM'</span>].isna() <span class="op">|</span> (data[<span class="st">'DECLARED_DISTANCE_KM'</span>] <span class="op">==</span> <span class="dv">0</span>))</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Counters for statistics</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    processed_rows <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    successful_lookups <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    failed_lookups <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterate through the filtered dataset</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index, row <span class="kw">in</span> tqdm(filtered_data.iterrows(), total<span class="op">=</span>filtered_data.shape[<span class="dv">0</span>], </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>                          desc<span class="op">=</span><span class="ss">f"Processing </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span>):</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        processed_rows <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        departure_country <span class="op">=</span> row[<span class="st">'DEPARTURE_COUNTRY'</span>]</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        departure_zipcode <span class="op">=</span> row[<span class="st">'DEPARTURE_ZIPCODE'</span>]</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        arrival_zipcode <span class="op">=</span> row[<span class="st">'ARRIVAL_ZIPCODE'</span>]</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> departure_country <span class="kw">in</span> [<span class="st">"IT"</span>, <span class="st">"US"</span>]:</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>            departure_coords <span class="op">=</span> get_zipcode_coordinates(departure_zipcode, departure_country)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>            arrival_coords <span class="op">=</span> get_zipcode_coordinates(arrival_zipcode, departure_country)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>            failed_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> departure_coords <span class="kw">and</span> arrival_coords:</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>            distance <span class="op">=</span> <span class="va">None</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>            error_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> error_count <span class="op">&lt;</span> <span class="dv">5</span>:</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>                distance, _ <span class="op">=</span> get_osrm_distance(departure_coords, arrival_coords)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> distance <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Update the DataFrame and immediately save it to the same file</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>                    data.at[index, <span class="st">'DECLARED_DISTANCE_KM'</span>] <span class="op">=</span> distance</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>                    data.to_csv(filename, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>                    successful_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>                error_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>                time.sleep(<span class="dv">1</span>)  <span class="co"># Add a delay to avoid too many requests</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> error_count <span class="op">==</span> <span class="dv">5</span>:</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"Unable to find distance for row </span><span class="sc">{</span>index<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>                    failed_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>            failed_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print statistics every 100 rows</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> processed_rows <span class="op">%</span> <span class="dv">100</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>            print_statistics(filename, processed_rows, successful_lookups, failed_lookups)</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print final statistics</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>    print_statistics(filename, processed_rows, successful_lookups, failed_lookups)</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> processed_rows, successful_lookups, failed_lookups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fee524dc-e104-4167-a552-662ab21b75c5" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Main function to process multiple dataset files and calculate distances.</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of files to process</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> [</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"gomma_data.csv"</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"corrieri_data.csv"</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ecommerce_data.csv"</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    total_stats <span class="op">=</span> {</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"processed"</span>: <span class="dv">0</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"successful"</span>: <span class="dv">0</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"failed"</span>: <span class="dv">0</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each file</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> filename <span class="kw">in</span> files:</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>            processed, successful, failed <span class="op">=</span> process_dataset(filename)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>            total_stats[<span class="st">"processed"</span>] <span class="op">+=</span> processed</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>            total_stats[<span class="st">"successful"</span>] <span class="op">+=</span> successful</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>            total_stats[<span class="st">"failed"</span>] <span class="op">+=</span> failed</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Processing completed for </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"File not found: </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error processing </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print total statistics</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Total Statistics ==="</span>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total processed rows: </span><span class="sc">{</span>total_stats[<span class="st">'processed'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total successful lookups: </span><span class="sc">{</span>total_stats[<span class="st">'successful'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total failed lookups: </span><span class="sc">{</span>total_stats[<span class="st">'failed'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"========================="</span>)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="merging-the-3-files" class="level2">
<h2 class="anchored" data-anchor-id="merging-the-3-files">Merging the 3 files</h2>
<p>In addition to merging we added the missing rows from the original dataset</p>
<div id="63167876-a0c2-4041-bcff-b4638216e808" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_delivery_data(main_file, additional_files):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Data cleaning and integration procedure for delivery data</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">    main_file (str): Path to the main CSV file</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">    additional_files (list): List of paths to additional CSV files</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame: DataFrame with integrated kilometers and corrected times</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Load the main dataset</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    delivery_df <span class="op">=</span> pd.read_csv(main_file)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Create a copy of the dataset</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    integrated_km_df <span class="op">=</span> delivery_df.copy()</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Try to fill in missing kilometers from other datasets</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> additional_file <span class="kw">in</span> additional_files:</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        additional_df <span class="op">=</span> pd.read_csv(additional_file)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find rows with missing kilometers</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        missing_km_mask <span class="op">=</span> integrated_km_df[<span class="st">'DECLARED_DISTANCE_KM'</span>].isna()</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try to integrate kilometers from the other dataset</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> index, row <span class="kw">in</span> integrated_km_df[missing_km_mask].iterrows():</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>            match <span class="op">=</span> additional_df[</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>                (additional_df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> row[<span class="st">'DEPARTURE_COUNTRY'</span>]) <span class="op">&amp;</span> </span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>                (additional_df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> row[<span class="st">'ARRIVAL_COUNTRY'</span>])</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> match.empty:</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>                mode_value <span class="op">=</span> match[<span class="st">'DECLARED_DISTANCE_KM'</span>].mode()</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> mode_value.empty:</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>                    integrated_km_df.at[index, <span class="st">'DECLARED_DISTANCE_KM'</span>] <span class="op">=</span> mode_value.iloc[<span class="dv">0</span>]</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Handle negative travel times</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    negative_travel_time_mask <span class="op">=</span> integrated_km_df[<span class="st">'DELIVERY_TIME_HH'</span>] <span class="op">&lt;</span> <span class="dv">0</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert negative times to positive and swap the dates</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    integrated_km_df.loc[negative_travel_time_mask, <span class="st">'DELIVERY_TIME_HH'</span>] <span class="op">=</span> <span class="bu">abs</span>(integrated_km_df.loc[negative_travel_time_mask, <span class="st">'DELIVERY_TIME_HH'</span>])</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    integrated_km_df.loc[negative_travel_time_mask, [<span class="st">'SHIPPING_DATE'</span>, <span class="st">'ACTUAL_DELIVERY_DATE'</span>]] <span class="op">=</span> <span class="op">\</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        integrated_km_df.loc[negative_travel_time_mask, [<span class="st">'ACTUAL_DELIVERY_DATE'</span>, <span class="st">'SHIPPING_DATE'</span>]].values</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> integrated_km_df</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>main_file <span class="op">=</span> <span class="st">'delivery_data.csv'</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>additional_files <span class="op">=</span> [<span class="st">'gomma_data.csv'</span>, <span class="st">'ecommerce_data.csv'</span>, <span class="st">'corrieri_data.csv'</span>]</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute the data cleaning</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>cleaned_data <span class="op">=</span> clean_delivery_data(main_file, additional_files)</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the cleaned dataset</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>cleaned_data.to_csv(<span class="st">'delivery_data_clear.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Data cleaning completed."</span>)</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cleaned dataset saved as 'delivery_data_clear.csv'"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data cleaning completed.
Cleaned dataset saved as 'delivery_data_clear.csv'</code></pre>
</div>
</div>
</section>
<section id="we-finalized-the-cleaning-in-these-2-final-steps" class="level2">
<h2 class="anchored" data-anchor-id="we-finalized-the-cleaning-in-these-2-final-steps">We finalized the cleaning in these 2 final steps</h2>
<section id="added-missing-declared_distance_km-from-the-original-dataset" class="level3">
<h3 class="anchored" data-anchor-id="added-missing-declared_distance_km-from-the-original-dataset">1) Added missing DECLARED_DISTANCE_KM from the original dataset</h3>
<div id="c2582378-e8bd-42fe-839a-087ee26d2c5a" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_osrm_distance(coord1, coord2):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Retrieves the driving distance (in km) and duration (in seconds) </span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">    between two coordinates using the OSRM API.</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> <span class="ss">f"http://router.project-osrm.org/route/v1/driving/</span><span class="sc">{</span>coord1[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>coord1[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">;</span><span class="sc">{</span>coord2[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>coord2[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(url)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> response.json()</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'routes'</span> <span class="kw">in</span> data <span class="kw">and</span> <span class="bu">len</span>(data[<span class="st">'routes'</span>]) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        distance_km <span class="op">=</span> data[<span class="st">'routes'</span>][<span class="dv">0</span>][<span class="st">'distance'</span>] <span class="op">/</span> <span class="dv">1000</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        duration_seconds <span class="op">=</span> data[<span class="st">'routes'</span>][<span class="dv">0</span>][<span class="st">'duration'</span>]</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">round</span>(distance_km, <span class="dv">2</span>), duration_seconds</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6e67e8e1-9345-439f-875c-ce5047844f1f" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_zipcode_coordinates(zipcode: <span class="bu">str</span>, country) <span class="op">-&gt;</span> Optional[Tuple[<span class="bu">float</span>, <span class="bu">float</span>]]:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns the latitude and longitude of a given ZIP code and country using the Nominatim geocoding API.</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        geolocator <span class="op">=</span> Nominatim(user_agent<span class="op">=</span><span class="st">"my_distance_calculator"</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        location <span class="op">=</span> geolocator.geocode(<span class="ss">f"</span><span class="sc">{</span>zipcode<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>country<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> location:</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (location.latitude, location.longitude)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b887ecce-c73f-4bd6-8870-72252090c6c0" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_statistics(processed_rows, successful_lookups, failed_lookups):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Prints statistics on the processed dataset.</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> successful_lookups <span class="op">+</span> failed_lookups</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    success_rate <span class="op">=</span> (successful_lookups <span class="op">/</span> total <span class="op">*</span> <span class="dv">100</span>) <span class="cf">if</span> total <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    failure_rate <span class="op">=</span> (failed_lookups <span class="op">/</span> total <span class="op">*</span> <span class="dv">100</span>) <span class="cf">if</span> total <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Processing Statistics ---"</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processed rows: </span><span class="sc">{</span>processed_rows<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Successful lookups: </span><span class="sc">{</span>successful_lookups<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>success_rate<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Failed lookups: </span><span class="sc">{</span>failed_lookups<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>failure_rate<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"------------------------------------------------</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="23d9b735-4d99-4794-821a-74c42876592c" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_dataset():</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Processes the dataset, calculates missing distances, and updates the CSV file.</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> <span class="st">"delivery_data_clear.csv"</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Processing </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the dataset</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> pd.read_csv(filename)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter the DataFrame for rows where distance needs to be calculated</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    filtered_data <span class="op">=</span> data[</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        (data[<span class="st">'DECLARED_DISTANCE_KM'</span>].isna() <span class="op">|</span> (data[<span class="st">'DECLARED_DISTANCE_KM'</span>] <span class="op">==</span> <span class="dv">0</span>))</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Counters for statistics</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    processed_rows <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    successful_lookups <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    failed_lookups <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterate through the filtered dataset</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index, row <span class="kw">in</span> tqdm(filtered_data.iterrows(), total<span class="op">=</span>filtered_data.shape[<span class="dv">0</span>], </span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>                          desc<span class="op">=</span><span class="ss">f"Processing distances"</span>):</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        processed_rows <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        departure_country <span class="op">=</span> row[<span class="st">'DEPARTURE_COUNTRY'</span>]</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        departure_zipcode <span class="op">=</span> row[<span class="st">'DEPARTURE_ZIPCODE'</span>]</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        arrival_zipcode <span class="op">=</span> row[<span class="st">'ARRIVAL_ZIPCODE'</span>]</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> departure_country <span class="kw">in</span> [<span class="st">"IT"</span>, <span class="st">"US"</span>]:</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>            departure_coords <span class="op">=</span> get_zipcode_coordinates(departure_zipcode, departure_country)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>            arrival_coords <span class="op">=</span> get_zipcode_coordinates(arrival_zipcode, departure_country)</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>            failed_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> departure_coords <span class="kw">and</span> arrival_coords:</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>            distance <span class="op">=</span> <span class="va">None</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>            error_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> error_count <span class="op">&lt;</span> <span class="dv">5</span>:</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>                distance, _ <span class="op">=</span> get_osrm_distance(departure_coords, arrival_coords)</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> distance <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Update the DataFrame and immediately save it to the same file</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>                    data.at[index, <span class="st">'DECLARED_DISTANCE_KM'</span>] <span class="op">=</span> distance</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>                    data.to_csv(filename, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>                    successful_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>                error_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>                time.sleep(<span class="dv">1</span>)  <span class="co"># Add a delay to avoid too many requests</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> error_count <span class="op">==</span> <span class="dv">5</span>:</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"Unable to find distance for row </span><span class="sc">{</span>index<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>                    failed_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>            failed_lookups <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print statistics every 100 rows</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> processed_rows <span class="op">%</span> <span class="dv">100</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>            print_statistics(processed_rows, successful_lookups, failed_lookups)</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print final statistics</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>    print_statistics(processed_rows, successful_lookups, failed_lookups)</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> processed_rows, successful_lookups, failed_lookups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="417cd8f7-9763-4d65-8c16-7d8b6f662391" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Main function to process the dataset and calculate distances.</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        processed, successful, failed <span class="op">=</span> process_dataset()</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Processing completed."</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Total processed rows: </span><span class="sc">{</span>processed<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Successful lookups: </span><span class="sc">{</span>successful<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Failed lookups: </span><span class="sc">{</span>failed<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"File delivery_data_clear.csv not found."</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error processing the file: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Processing delivery_data_clear.csv...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing distances: 0it [00:00, ?it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Processing Statistics ---
Processed rows: 0
Successful lookups: 0 (0.00%)
Failed lookups: 0 (0.00%)
------------------------------------------------


Processing completed.
Total processed rows: 0
Successful lookups: 0
Failed lookups: 0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
</section>
<section id="added-missing-values-for-servicetype-and-vehicletype" class="level3">
<h3 class="anchored" data-anchor-id="added-missing-values-for-servicetype-and-vehicletype">2) Added missing values for SERVICETYPE and VEHICLETYPE</h3>
<div id="800cc067-9605-4d52-b625-f4649ba16405" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppress specific warnings</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>, category<span class="op">=</span><span class="pp">UserWarning</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="27f6e8f0-bafc-4471-b805-a050e3c26c7d" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's check the missing columns</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultiColumnLabelEncoder(BaseEstimator, TransformerMixin):</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, columns<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.columns <span class="op">=</span> columns</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.encoders <span class="op">=</span> {}</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure X is a DataFrame</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> pd.DataFrame(X)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If no columns specified, use all columns</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.columns <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.columns <span class="op">=</span> X.columns</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit label encoders for specified columns</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> <span class="va">self</span>.columns:</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>            le <span class="op">=</span> LabelEncoder()</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Handle mixed type columns by converting to string</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>                le.fit(X[col].astype(<span class="bu">str</span>).fillna(<span class="st">'Unknown'</span>))</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">TypeError</span>:</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>                le.fit(X[col].fillna(<span class="st">'Unknown'</span>).astype(<span class="bu">str</span>))</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.encoders[col] <span class="op">=</span> le</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, X):</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure X is a DataFrame</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> pd.DataFrame(X)</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>        X_copy <span class="op">=</span> X.copy()</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> <span class="va">self</span>.columns:</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if column exists and has an encoder</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> col <span class="kw">in</span> X_copy.columns <span class="kw">and</span> col <span class="kw">in</span> <span class="va">self</span>.encoders:</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>                le <span class="op">=</span> <span class="va">self</span>.encoders[col]</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Transform column, handling unseen and NaN values</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>                X_copy[col] <span class="op">=</span> X_copy[col].fillna(<span class="st">'Unknown'</span>)</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>                X_copy[col] <span class="op">=</span> X_copy[col].<span class="bu">map</span>(</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">lambda</span> s: le.transform([<span class="bu">str</span>(s)])[<span class="dv">0</span>] </span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">str</span>(s) <span class="kw">in</span> le.classes_ </span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> X_copy</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit_transform(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.fit(X).transform(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="990ac567-1297-49d8-9e01-a0d4bf7314cb" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_data_for_ml(df):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Prepare the data for training the Machine Learning model</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">    df (pd.DataFrame): Original dataset</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">    tuple: Features, target for SERVICETYPE and VEHICLETYPE</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Select features for prediction</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    features_columns <span class="op">=</span> [</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DEPARTURE_COUNTRY'</span>, </span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ARRIVAL_COUNTRY'</span>, </span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">'GROSS_WEIGHT_KG'</span>, </span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'NET_WEIGHT_KG'</span>, </span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'VOLUME_M3'</span>, </span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DECLARED_DISTANCE_KM'</span>,</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DELIVERY_TIME_HH'</span>,</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'WDAY'</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a copy of the dataset</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    df_prepared <span class="op">=</span> df.copy()</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove rows with null target values</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    df_known <span class="op">=</span> df_prepared.dropna(subset<span class="op">=</span>[<span class="st">'SERVICETYPE'</span>, <span class="st">'VEHICLETYPE'</span>])</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate that we have enough data for training</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(df_known) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No rows available for training after removing null targets"</span>)</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare the features</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df_known[features_columns].copy()</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare the targets</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    y_service <span class="op">=</span> df_known[<span class="st">'SERVICETYPE'</span>]</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>    y_vehicle <span class="op">=</span> df_known[<span class="st">'VEHICLETYPE'</span>]</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X, y_service, y_vehicle</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ea4993c9-3c8d-48d0-820d-97d0c2bc2057" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_ml_pipeline(is_categorical<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a preprocessing and classification pipeline</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co">    is_categorical (bool): If True, use encoding for categorical columns</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Pipeline: Preprocessing and classification pipeline</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Numeric and categorical columns</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    numeric_features <span class="op">=</span> [</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'GROSS_WEIGHT_KG'</span>, </span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'NET_WEIGHT_KG'</span>, </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">'VOLUME_M3'</span>, </span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DECLARED_DISTANCE_KM'</span>,</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DELIVERY_TIME_HH'</span>,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'WDAY'</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    categorical_features <span class="op">=</span> [<span class="st">'DEPARTURE_COUNTRY'</span>, <span class="st">'ARRIVAL_COUNTRY'</span>]</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing for numeric columns</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    numeric_transformer <span class="op">=</span> Pipeline(steps<span class="op">=</span>[</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'imputer'</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">'median'</span>)),</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'scaler'</span>, StandardScaler())</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing for categorical columns</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    preprocessing_steps <span class="op">=</span> [</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'imputer'</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">'most_frequent'</span>))</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add encoding if requested</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_categorical:</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>        preprocessing_steps.append((<span class="st">'encoder'</span>, MultiColumnLabelEncoder()))</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    categorical_transformer <span class="op">=</span> Pipeline(steps<span class="op">=</span>preprocessing_steps)</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine preprocessors</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>    preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>[</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'num'</span>, numeric_transformer, numeric_features),</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'cat'</span>, categorical_transformer, categorical_features)</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Complete pipeline with preprocessor and classifier</span></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    pipeline <span class="op">=</span> Pipeline(steps<span class="op">=</span>[</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'preprocessor'</span>, preprocessor),</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'classifier'</span>, RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>))</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pipeline</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3e8d71bf-c756-4132-838e-742e0fd7b8d2" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> impute_with_ml(input_file):</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Impute missing values using Machine Learning</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co">    input_file (str): Path to the input CSV file</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame: DataFrame with imputed values</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the dataset</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.read_csv(input_file)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error: File </span><span class="sc">{</span>input_file<span class="sc">}</span><span class="ss"> not found."</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error loading file: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a duplicate of the dataset</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    df_imputed <span class="op">=</span> df.copy()</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare the data for training</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>        X, y_service, y_vehicle <span class="op">=</span> prepare_data_for_ml(df)</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Split the data into training and test sets</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>        X_train, X_test, y_service_train, y_service_test, y_vehicle_train, y_vehicle_test <span class="op">=</span> train_test_split(</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>            X, y_service, y_vehicle, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create and train the models</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>        service_pipeline <span class="op">=</span> create_ml_pipeline(is_categorical<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>        vehicle_pipeline <span class="op">=</span> create_ml_pipeline(is_categorical<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train both models</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>        service_pipeline.fit(X_train, y_service_train)</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>        vehicle_pipeline.fit(X_train, y_vehicle_train)</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Evaluate the models</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>        service_pred <span class="op">=</span> service_pipeline.predict(X_test)</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>        vehicle_pred <span class="op">=</span> vehicle_pipeline.predict(X_test)</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate accuracy</span></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>        service_accuracy <span class="op">=</span> accuracy_score(y_service_test, service_pred) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>        vehicle_accuracy <span class="op">=</span> accuracy_score(y_vehicle_test, vehicle_pred) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">SERVICETYPE Accuracy: </span><span class="sc">{</span>service_accuracy<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"VEHICLETYPE Accuracy: </span><span class="sc">{</span>vehicle_accuracy<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Identify rows with missing values</span></span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>        missing_mask <span class="op">=</span> df_imputed[<span class="st">'SERVICETYPE'</span>].isna() <span class="op">|</span> df_imputed[<span class="st">'VEHICLETYPE'</span>].isna()</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>        missing_data <span class="op">=</span> df_imputed.loc[missing_mask, X.columns].copy()</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Impute missing values</span></span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> index <span class="kw">in</span> missing_mask[missing_mask].index:</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Impute SERVICETYPE</span></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.isna(df_imputed.at[index, <span class="st">'SERVICETYPE'</span>]):</span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>                df_imputed.at[index, <span class="st">'SERVICETYPE'</span>] <span class="op">=</span> service_pipeline.predict(missing_data.loc[[index]])[<span class="dv">0</span>]</span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Impute VEHICLETYPE</span></span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.isna(df_imputed.at[index, <span class="st">'VEHICLETYPE'</span>]):</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>                df_imputed.at[index, <span class="st">'VEHICLETYPE'</span>] <span class="op">=</span> vehicle_pipeline.predict(missing_data.loc[[index]])[<span class="dv">0</span>]</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df_imputed</span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error during imputation process: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="20d1949d-79e0-4fc0-9bf9-1bd5373f6f46" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Main function to execute the imputation process</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    input_file <span class="op">=</span> <span class="st">'delivery_data_clear.csv'</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    output_file <span class="op">=</span> <span class="st">'final_delivery_data.csv'</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    df_with_imputed_data <span class="op">=</span> impute_with_ml(input_file)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df_with_imputed_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>            df_with_imputed_data.to_csv(output_file, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">File '</span><span class="sc">{</span>output_file<span class="sc">}</span><span class="ss">' created successfully."</span>)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error saving the file: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
SERVICETYPE Accuracy: 96.72%
VEHICLETYPE Accuracy: 90.55%

File 'final_delivery_data.csv' created successfully.</code></pre>
</div>
</div>
</section>
</section>
<section id="creation-of-the-correlation-matrices" class="level2">
<h2 class="anchored" data-anchor-id="creation-of-the-correlation-matrices">Creation of the correlation matrices</h2>
<div id="f509091a-6f40-4e57-9d8f-536873d0e7dc" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> correlation_matrix_from_csv(input_file):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create correlation matrix</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">    input_file (str): path to input CSV file</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the dataset</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(input_file)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Select only the numeric columns of interest</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    columns_of_interest <span class="op">=</span> [</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'GROSS_WEIGHT_KG'</span>,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">'NET_WEIGHT_KG'</span>,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'VOLUME_M3'</span>,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DECLARED_DISTANCE_KM'</span>,</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DELIVERY_TIME_HH'</span>,</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'WDAY'</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the correlation matrix</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    correlation_matrix <span class="op">=</span> df[columns_of_interest].corr()</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a larger figure for better readability</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the correlogram using seaborn</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(correlation_matrix, </span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>                annot<span class="op">=</span><span class="va">True</span>,  <span class="co"># Show numeric values</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>                cmap<span class="op">=</span><span class="st">'RdBu'</span>,  <span class="co"># Use a blue-red colormap</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>                vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>,  <span class="co"># Set scale limits</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>                center<span class="op">=</span><span class="dv">0</span>,  <span class="co"># Center the colormap on zero</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>                fmt<span class="op">=</span><span class="st">'.2f'</span>)  <span class="co"># Show two decimals</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rotate labels for better readability</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>    plt.yticks(rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add a title</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Correlation matrix of Transport Variables'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust the layout</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="matrix-for-road-transport" class="level3">
<h3 class="anchored" data-anchor-id="matrix-for-road-transport">Matrix for road transport</h3>
<div id="e245dc5c-307e-4651-8edc-750b323262d7" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>correlation_matrix_from_csv(<span class="st">'gomma_data.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="matrix-for-e-commerce" class="level3">
<h3 class="anchored" data-anchor-id="matrix-for-e-commerce">Matrix for E-commerce</h3>
<div id="73ddf584-f2db-44ad-afdc-7c6624bbd9d3" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>correlation_matrix_from_csv(<span class="st">'ecommerce_data.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-25-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="matrix-for-couriers" class="level3">
<h3 class="anchored" data-anchor-id="matrix-for-couriers">Matrix for couriers</h3>
<div id="c83240e1-eb12-4b46-ba7c-a48b2893f4e3" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>correlation_matrix_from_csv(<span class="st">'corrieri_data.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="matrix-for-the-complete-dataset" class="level3">
<h3 class="anchored" data-anchor-id="matrix-for-the-complete-dataset">Matrix for the complete dataset</h3>
<div id="240d69b6-112d-49a1-8dc9-06e1f17c664b" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>correlation_matrix_from_csv(<span class="st">'final_delivery_data.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Based on these correlations matrices we can understand that what varies delivery time the most is the WDAY (day of departure), the more you are towards the weekend, the longer the delivery time will be</p>
</section>
</section>
<section id="creation-of-histograms-for-all-3-types-of-service-types" class="level2">
<h2 class="anchored" data-anchor-id="creation-of-histograms-for-all-3-types-of-service-types">Creation of Histograms for all 3 types of service types</h2>
<p>We do this in order to see if there is any data that may interest us</p>
<div id="fa775cea-4cc1-4e8d-a02f-73451c76b50d" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> histogram_average_time_x_day_from_csv(input_file, graph_color):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create Histogram average time by day of the week</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">    input_file (str): path to input CSV file</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">    graph_color (str): color for the graph</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the dataset</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    df_gomma <span class="op">=</span> pd.read_csv(input_file)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the average delivery time for each day of the week</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    mean_delivery_time_gomma <span class="op">=</span> df_gomma.groupby(<span class="st">'WDAY'</span>)[<span class="st">'DELIVERY_TIME_HH'</span>].mean()</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a DataFrame with all days of the week</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    days_of_week <span class="op">=</span> pd.DataFrame({<span class="st">'WDAY'</span>: <span class="bu">range</span>(<span class="dv">7</span>)})</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    mean_delivery_time_gomma <span class="op">=</span> mean_delivery_time_gomma.reset_index()</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    mean_delivery_time_gomma <span class="op">=</span> days_of_week.merge(mean_delivery_time_gomma, on<span class="op">=</span><span class="st">'WDAY'</span>, how<span class="op">=</span><span class="st">'left'</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the histogram</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> plt.bar(mean_delivery_time_gomma[<span class="st">'WDAY'</span>], mean_delivery_time_gomma[<span class="st">'DELIVERY_TIME_HH'</span>], color<span class="op">=</span>graph_color, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Day of the Week'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Average Travel Time (Hours)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    plt.xticks(<span class="bu">range</span>(<span class="dv">7</span>), [<span class="st">'Mon'</span>, <span class="st">'Tue'</span>, <span class="st">'Wed'</span>, <span class="st">'Thu'</span>, <span class="st">'Fri'</span>, <span class="st">'Sat'</span>, <span class="st">'Sun'</span>], fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    plt.grid(axis<span class="op">=</span><span class="st">'y'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value labels above each bar</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bar <span class="kw">in</span> bars:</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>        yval <span class="op">=</span> bar.get_height()</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>        plt.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="dv">2</span>, yval, <span class="bu">round</span>(yval, <span class="dv">2</span>), ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="histogram-for-road-transport" class="level3">
<h3 class="anchored" data-anchor-id="histogram-for-road-transport">Histogram for Road Transport</h3>
<div id="b777ddbc-36ff-4122-8c8f-46cf4de9f3b1" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>histogram_average_time_x_day_from_csv(<span class="st">'gomma_data.csv'</span>, <span class="st">'skyblue'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="histogram-for-couriers" class="level3">
<h3 class="anchored" data-anchor-id="histogram-for-couriers">Histogram for couriers</h3>
<div id="ca238c2a-b634-4134-8e8c-a1596b41ba56" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>histogram_average_time_x_day_from_csv(<span class="st">'corrieri_data.csv'</span>, <span class="st">'lightgreen'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-30-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="histogram-for-e-commerce" class="level3">
<h3 class="anchored" data-anchor-id="histogram-for-e-commerce">Histogram for E-commerce</h3>
<div id="efe95b32-72f2-4a83-8763-9006ee29397a" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>histogram_average_time_x_day_from_csv(<span class="st">'ecommerce_data.csv'</span>, <span class="st">'salmon'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="histogram-with-every-servicetype" class="level2">
<h2 class="anchored" data-anchor-id="histogram-with-every-servicetype">Histogram with every SERVICETYPE</h2>
<div id="7a878954-c9a0-4aac-969f-304e4dffc8f3" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the datasets</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>df_gomma <span class="op">=</span> pd.read_csv(<span class="st">'gomma_data.csv'</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>df_corrieri <span class="op">=</span> pd.read_csv(<span class="st">'corrieri_data.csv'</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>df_ecommerce <span class="op">=</span> pd.read_csv(<span class="st">'ecommerce_data.csv'</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average delivery time for each day of the week</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_gomma <span class="op">=</span> df_gomma.groupby(<span class="st">'WDAY'</span>)[<span class="st">'DELIVERY_TIME_HH'</span>].mean().reset_index()</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_corrieri <span class="op">=</span> df_corrieri.groupby(<span class="st">'WDAY'</span>)[<span class="st">'DELIVERY_TIME_HH'</span>].mean().reset_index()</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_ecommerce <span class="op">=</span> df_ecommerce.groupby(<span class="st">'WDAY'</span>)[<span class="st">'DELIVERY_TIME_HH'</span>].mean().reset_index()</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame with all days of the week</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>days_of_week <span class="op">=</span> pd.DataFrame({<span class="st">'WDAY'</span>: <span class="bu">range</span>(<span class="dv">7</span>)})</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_gomma <span class="op">=</span> days_of_week.merge(mean_delivery_time_gomma, on<span class="op">=</span><span class="st">'WDAY'</span>, how<span class="op">=</span><span class="st">'left'</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_corrieri <span class="op">=</span> days_of_week.merge(mean_delivery_time_corrieri, on<span class="op">=</span><span class="st">'WDAY'</span>, how<span class="op">=</span><span class="st">'left'</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>mean_delivery_time_ecommerce <span class="op">=</span> days_of_week.merge(mean_delivery_time_ecommerce, on<span class="op">=</span><span class="st">'WDAY'</span>, how<span class="op">=</span><span class="st">'left'</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the data into a single DataFrame</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>combined_data <span class="op">=</span> pd.DataFrame({</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'WDAY'</span>: mean_delivery_time_gomma[<span class="st">'WDAY'</span>],</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Gomma'</span>: mean_delivery_time_gomma[<span class="st">'DELIVERY_TIME_HH'</span>],</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Couriers'</span>: mean_delivery_time_corrieri[<span class="st">'DELIVERY_TIME_HH'</span>],</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Ecommerce'</span>: mean_delivery_time_ecommerce[<span class="st">'DELIVERY_TIME_HH'</span>]</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the bar width</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>bar_width <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(combined_data[<span class="st">'WDAY'</span>]))</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the bar chart</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>bars1 <span class="op">=</span> plt.bar(x <span class="op">-</span> bar_width, combined_data[<span class="st">'Gomma'</span>], width<span class="op">=</span>bar_width, color<span class="op">=</span><span class="st">'skyblue'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Gomma'</span>)</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>bars2 <span class="op">=</span> plt.bar(x, combined_data[<span class="st">'Couriers'</span>], width<span class="op">=</span>bar_width, color<span class="op">=</span><span class="st">'lightgreen'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Couriers'</span>)</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>bars3 <span class="op">=</span> plt.bar(x <span class="op">+</span> bar_width, combined_data[<span class="st">'Ecommerce'</span>], width<span class="op">=</span>bar_width, color<span class="op">=</span><span class="st">'salmon'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Ecommerce'</span>)</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Add titles and labels</span></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Average Delivery Time by Day of the Week'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Day of the Week'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Average Delivery Time (Hours)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>plt.xticks(x, [<span class="st">'Mon'</span>, <span class="st">'Tue'</span>, <span class="st">'Wed'</span>, <span class="st">'Thu'</span>, <span class="st">'Fri'</span>, <span class="st">'Sat'</span>, <span class="st">'Sun'</span>], fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>plt.grid(axis<span class="op">=</span><span class="st">'y'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels above each bar</span></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bars <span class="kw">in</span> [bars1, bars2, bars3]:</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bar <span class="kw">in</span> bars:</span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>        yval <span class="op">=</span> bar.get_height()</span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>        plt.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="dv">2</span>, yval, <span class="bu">round</span>(yval, <span class="dv">2</span>), ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-32-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Analyzing these data we can understand that, in case the service is Road transport or courier, packages aren’t delivered during the weekend. This information can be used to create the prediction algorithm.</p>
</section>
<section id="lets-split-the-csv-file-based-on-departure_country-and-arrival_country" class="level2">
<h2 class="anchored" data-anchor-id="lets-split-the-csv-file-based-on-departure_country-and-arrival_country">let’s split the CSV file based on DEPARTURE_COUNTRY and ARRIVAL_COUNTRY</h2>
<div id="5c64ddc2-2feb-4aeb-998e-7b553d3c3b00" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> split_csv(input_file):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the CSV file</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(input_file)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for IT-IT deliveries</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    it_it <span class="op">=</span> df[(df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>)]</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    it_it.to_csv(<span class="st">'final_delivery_data_it_it.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for US-US deliveries</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    us_us <span class="op">=</span> df[(df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>)]</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    us_us.to_csv(<span class="st">'final_delivery_data_us_us.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for mixed IT-US or US-IT deliveries</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    mixed <span class="op">=</span> df[</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>        ((df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>)) <span class="op">|</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>        ((df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> <span class="st">'US'</span>) <span class="op">&amp;</span> (df[<span class="st">'ARRIVAL_COUNTRY'</span>] <span class="op">==</span> <span class="st">'IT'</span>))</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    mixed.to_csv(<span class="st">'final_delivery_data_mixed.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print summary</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"IT-IT deliveries: </span><span class="sc">{</span><span class="bu">len</span>(it_it)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"US-US deliveries: </span><span class="sc">{</span><span class="bu">len</span>(us_us)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mixed deliveries: </span><span class="sc">{</span><span class="bu">len</span>(mixed)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the splitting</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>split_csv(<span class="st">'final_delivery_data.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IT-IT deliveries: 11755
US-US deliveries: 2225
Mixed deliveries: 574</code></pre>
</div>
</div>
</section>
<section id="distribution-of-lines-in-csv-files" class="level2">
<h2 class="anchored" data-anchor-id="distribution-of-lines-in-csv-files">Distribution of Lines in CSV Files</h2>
<div id="44bfff49-4cde-402d-abe7-c41a83ce6392" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the graphic style</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define pastel colors</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'#FF9999'</span>, <span class="st">'#66B2FF'</span>, <span class="st">'#99FF99'</span>]</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Files to analyze</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> [</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'final_delivery_data_mixed.csv'</span>,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'final_delivery_data_it_it.csv'</span>,</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'final_delivery_data_us_us.csv'</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Dictionary for line counting</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>line_counts <span class="op">=</span> {}</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.read_csv(<span class="bu">file</span>)</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>        line_counts[<span class="bu">file</span>] <span class="op">=</span> <span class="bu">len</span>(df)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"File not found: </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate total lines</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>total_lines <span class="op">=</span> <span class="bu">sum</span>(line_counts.values())</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Create readable labels</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="bu">file</span>.replace(<span class="st">'final_delivery_data_'</span>, <span class="st">''</span>).replace(<span class="st">'.csv'</span>, <span class="st">''</span>).upper() <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files]</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Set font</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'font.family'</span>] <span class="op">=</span> <span class="st">'sans-serif'</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the chart</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>), facecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>wedges, texts, autotexts <span class="op">=</span> ax.pie(</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>    line_counts.values(), </span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>labels,</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>    autopct<span class="op">=</span><span class="kw">lambda</span> pct: <span class="ss">f'</span><span class="sc">{</span>pct<span class="sc">:.1f}</span><span class="ss">%'</span>,</span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>    startangle<span class="op">=</span><span class="dv">90</span>,</span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>colors,</span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>    explode<span class="op">=</span>[<span class="fl">0.05</span>] <span class="op">*</span> <span class="bu">len</span>(files),</span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>    wedgeprops<span class="op">=</span>{<span class="st">'edgecolor'</span>: <span class="st">'white'</span>, <span class="st">'linewidth'</span>: <span class="dv">2</span>}</span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Customize text</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>plt.setp(autotexts, size<span class="op">=</span><span class="dv">9</span>, weight<span class="op">=</span><span class="st">"bold"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>plt.setp(texts, size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Add title</span></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Distribution of Lines in CSV Files'</span>, </span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>          pad<span class="op">=</span><span class="dv">20</span>, </span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>          fontsize<span class="op">=</span><span class="dv">16</span>, </span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>          fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Add legend</span></span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>ax.legend([<span class="ss">f'</span><span class="sc">{</span>label<span class="sc">}</span><span class="ch">\n</span><span class="ss">(</span><span class="sc">{</span>count<span class="sc">:,}</span><span class="ss"> lines, </span><span class="sc">{</span>(count<span class="op">/</span>total_lines<span class="op">*</span><span class="dv">100</span>)<span class="sc">:.1f}</span><span class="ss">%)'</span> </span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>           <span class="cf">for</span> label, count <span class="kw">in</span> <span class="bu">zip</span>(labels, line_counts.values())],</span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>          title<span class="op">=</span><span class="st">"Details"</span>,</span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>          loc<span class="op">=</span><span class="st">"center left"</span>,</span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>          bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>))</span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">'equal'</span>)</span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Tesisquare_analysis_files/figure-html/cell-34-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="creation-for-the-road-map" class="level2">
<h2 class="anchored" data-anchor-id="creation-for-the-road-map">Creation for the road map</h2>
<div id="2c72a8ff-78d1-4e98-9cbc-3ec591fb6a60" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_zipcode_coordinates(zipcode: <span class="bu">str</span>, country: <span class="bu">str</span>) <span class="op">-&gt;</span> Optional[Tuple[<span class="bu">float</span>, <span class="bu">float</span>]]:</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>        geolocator <span class="op">=</span> Nominatim(user_agent<span class="op">=</span><span class="st">"delivery_route_mapper"</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>        location <span class="op">=</span> geolocator.geocode(<span class="ss">f"</span><span class="sc">{</span>zipcode<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>country<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> location:</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (location.latitude, location.longitude)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error getting coordinates for </span><span class="sc">{</span>zipcode<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>country<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9180f01a-c783-4759-9f83-8485fede1752" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> draw_map(csv_filename: <span class="bu">str</span>):</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates a map visualization from delivery data, skipping specific ZIP codes</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">    that were incorrectly mapped to non-US locations despite being US addresses.</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ZIP codes 02476, 02482, and 02116 are Massachusetts ZIP codes that were</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co">    incorrectly geocoded to other countries, so we skip them to maintain data accuracy.</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ZIP codes to skip due to incorrect geocoding outside the USA</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    skip_zipcodes <span class="op">=</span> {<span class="st">'2476'</span>, <span class="st">'2482.0'</span>, <span class="st">'2116.0'</span>}</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Read only first 40 rows as a sample</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>        dataset <span class="op">=</span> pd.read_csv(csv_filename, nrows<span class="op">=</span><span class="dv">40</span>)</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>        routes <span class="op">=</span> []</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>        cities <span class="op">=</span> {}</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Progress bar for geocoding</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> tqdm(dataset.iterrows(), total<span class="op">=</span>dataset.shape[<span class="dv">0</span>], desc<span class="op">=</span><span class="ss">f"Processing </span><span class="sc">{</span>csv_filename<span class="sc">}</span><span class="ss">"</span>):</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Skip problematic ZIP codes that get mapped to wrong countries</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="bu">str</span>(row[<span class="st">"DEPARTURE_ZIPCODE"</span>]) <span class="kw">in</span> skip_zipcodes <span class="kw">or</span> </span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>                <span class="bu">str</span>(row[<span class="st">"ARRIVAL_ZIPCODE"</span>]) <span class="kw">in</span> skip_zipcodes):</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>            departure <span class="op">=</span> get_zipcode_coordinates(<span class="bu">str</span>(row[<span class="st">"DEPARTURE_ZIPCODE"</span>]), row[<span class="st">"DEPARTURE_COUNTRY"</span>])</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>            arrival <span class="op">=</span> get_zipcode_coordinates(<span class="bu">str</span>(row[<span class="st">"ARRIVAL_ZIPCODE"</span>]), row[<span class="st">"ARRIVAL_COUNTRY"</span>])</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> arrival <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> departure <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>                route <span class="op">=</span> [departure, arrival]</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>                routes.append(route)</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>                cities[<span class="bu">str</span>(row[<span class="st">"DEPARTURE_ZIPCODE"</span>])] <span class="op">=</span> departure</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>                cities[<span class="bu">str</span>(row[<span class="st">"ARRIVAL_ZIPCODE"</span>])] <span class="op">=</span> arrival</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>            time.sleep(<span class="dv">1</span>) <span class="co"># Prevent overwhelming the geocoding service</span></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create map centered on a middle point</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>        map_vis <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="dv">45</span>, <span class="dv">10</span>], zoom_start<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add delivery routes</span></span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> route <span class="kw">in</span> tqdm(routes, desc<span class="op">=</span><span class="st">"Adding Routes"</span>):</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>            folium.PolyLine(route, color<span class="op">=</span><span class="st">"blue"</span>, weight<span class="op">=</span><span class="dv">2</span>, opacity<span class="op">=</span><span class="fl">0.7</span>).add_to(map_vis)</span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add city markers</span></span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name, coord <span class="kw">in</span> tqdm(cities.items(), desc<span class="op">=</span><span class="st">"Adding Markers"</span>):</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>            folium.Marker(coord, popup<span class="op">=</span>name, icon<span class="op">=</span>folium.Icon(color<span class="op">=</span><span class="st">"red"</span>)).add_to(map_vis)</span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save map to HTML file</span></span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>        output_name <span class="op">=</span> os.path.splitext(csv_filename)[<span class="dv">0</span>] <span class="op">+</span> <span class="st">'_sample.html'</span></span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>        map_vis.save(output_name)</span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Sample map successfully created: </span><span class="sc">{</span>output_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error processing </span><span class="sc">{</span>csv_filename<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="22e05928-9c76-4586-a354-bc6263a42fbf" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> [</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">'final_delivery_data_it_it.csv'</span>,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'final_delivery_data_us_us.csv'</span>,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'final_delivery_data_mixed.csv'</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.exists(<span class="bu">file</span>):</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>            draw_map(<span class="bu">file</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"File not found: </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing final_delivery_data_it_it.csv: 100%|██████████████████████████████████| 40/40 [01:59&lt;00:00,  3.00s/it]
Adding Routes: 100%|██████████████████████████████████████████████████████████| 40/40 [00:00&lt;00:00, 47339.77it/s]
Adding Markers: 100%|██████████████████████████████████████████████████████████| 27/27 [00:00&lt;00:00, 8640.13it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample map successfully created: final_delivery_data_it_it_sample.html</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing final_delivery_data_us_us.csv: 100%|██████████████████████████████████| 40/40 [01:51&lt;00:00,  2.79s/it]
Adding Routes: 100%|███████████████████████████████████████████████████████████| 38/38 [00:00&lt;00:00, 9791.35it/s]
Adding Markers: 100%|█████████████████████████████████████████████████████████| 49/49 [00:00&lt;00:00, 14592.51it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample map successfully created: final_delivery_data_us_us_sample.html</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing final_delivery_data_mixed.csv: 100%|██████████████████████████████████| 40/40 [01:51&lt;00:00,  2.78s/it]
Adding Routes: 100%|██████████████████████████████████████████████████████████| 39/39 [00:00&lt;00:00, 44632.43it/s]
Adding Markers: 100%|██████████████████████████████████████████████████████████| 39/39 [00:00&lt;00:00, 8988.29it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample map successfully created: final_delivery_data_mixed_sample.html</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
</section>
<section id="finally-we-can-create-a-lm-to-predict-delivery-time-and-distance" class="level2">
<h2 class="anchored" data-anchor-id="finally-we-can-create-a-lm-to-predict-delivery-time-and-distance">Finally we can create a LM to predict delivery time and distance</h2>
<div id="a009274d-8c90-463b-8701-6dbacad9b7be" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DeliveryPredictor:</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co">    A class for predicting delivery times and distances using machine learning models.</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Initializes the DeliveryPredictor with necessary encoders and ML models.</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.le_service <span class="op">=</span> LabelEncoder()</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.le_vehicle <span class="op">=</span> LabelEncoder()</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.le_dep_country <span class="op">=</span> LabelEncoder()</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.le_arr_country <span class="op">=</span> LabelEncoder()</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.le_dep_zip <span class="op">=</span> LabelEncoder()</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.le_arr_zip <span class="op">=</span> LabelEncoder()</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scaler <span class="op">=</span> RobustScaler()</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.imputer <span class="op">=</span> SimpleImputer(strategy<span class="op">=</span><span class="st">'median'</span>)</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.distance_model <span class="op">=</span> GradientBoostingRegressor(</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>            max_depth<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.time_model <span class="op">=</span> GradientBoostingRegressor(</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>            max_depth<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.unique_values <span class="op">=</span> {}</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> prepare_data(<span class="va">self</span>, df):</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a><span class="co">        Prepares and transforms input data for model training or prediction.</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a><span class="co">        args: </span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a><span class="co">        df (pandas.DataFrame): Input DataFrame containing delivery data</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a><span class="co">        returns: </span></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a><span class="co">        tuple: (X, df_cleaned) where X is the prepared feature matrix and df_cleaned is the processed DataFrame</span></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.copy()</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Clean zip codes</span></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'DEPARTURE_ZIPCODE'</span>] <span class="op">=</span> df[<span class="st">'DEPARTURE_ZIPCODE'</span>].fillna(<span class="st">'00000'</span>)</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ARRIVAL_ZIPCODE'</span>] <span class="op">=</span> df[<span class="st">'ARRIVAL_ZIPCODE'</span>].fillna(<span class="st">'00000'</span>)</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'DEPARTURE_ZIPCODE'</span>] <span class="op">=</span> df[<span class="st">'DEPARTURE_ZIPCODE'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.replace(<span class="st">'.0'</span>, <span class="st">''</span>).<span class="bu">str</span>.zfill(<span class="dv">5</span>)</span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ARRIVAL_ZIPCODE'</span>] <span class="op">=</span> df[<span class="st">'ARRIVAL_ZIPCODE'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.replace(<span class="st">'.0'</span>, <span class="st">''</span>).<span class="bu">str</span>.zfill(<span class="dv">5</span>)</span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove rows with NaN in critical columns</span></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>        critical_columns <span class="op">=</span> [<span class="st">'DELIVERY_TIME_HH'</span>, <span class="st">'DECLARED_DISTANCE_KM'</span>, <span class="st">'SERVICETYPE'</span>, <span class="st">'VEHICLETYPE'</span>, </span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'DEPARTURE_COUNTRY'</span>, <span class="st">'ARRIVAL_COUNTRY'</span>, <span class="st">'WDAY'</span>]</span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>        df.dropna(subset<span class="op">=</span>critical_columns, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove outliers from delivery time</span></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>        q1 <span class="op">=</span> df[<span class="st">'DELIVERY_TIME_HH'</span>].quantile(<span class="fl">0.25</span>)</span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>        q3 <span class="op">=</span> df[<span class="st">'DELIVERY_TIME_HH'</span>].quantile(<span class="fl">0.75</span>)</span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>        iqr <span class="op">=</span> q3 <span class="op">-</span> q1</span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[</span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'DELIVERY_TIME_HH'</span>] <span class="op">&gt;=</span> q1 <span class="op">-</span> <span class="fl">1.5</span> <span class="op">*</span> iqr) <span class="op">&amp;</span> </span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'DELIVERY_TIME_HH'</span>] <span class="op">&lt;=</span> q3 <span class="op">+</span> <span class="fl">1.5</span> <span class="op">*</span> iqr)</span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add derived features</span></span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'SAME_COUNTRY'</span>] <span class="op">=</span> (df[<span class="st">'DEPARTURE_COUNTRY'</span>] <span class="op">==</span> df[<span class="st">'ARRIVAL_COUNTRY'</span>]).astype(<span class="bu">int</span>)</span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Encode categorical variables</span></span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'SERVICETYPE_encoded'</span>] <span class="op">=</span> <span class="va">self</span>.le_service.fit_transform(df[<span class="st">'SERVICETYPE'</span>])</span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'VEHICLETYPE_encoded'</span>] <span class="op">=</span> <span class="va">self</span>.le_vehicle.fit_transform(df[<span class="st">'VEHICLETYPE'</span>])</span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'DEPARTURE_COUNTRY_encoded'</span>] <span class="op">=</span> <span class="va">self</span>.le_dep_country.fit_transform(df[<span class="st">'DEPARTURE_COUNTRY'</span>])</span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ARRIVAL_COUNTRY_encoded'</span>] <span class="op">=</span> <span class="va">self</span>.le_arr_country.fit_transform(df[<span class="st">'ARRIVAL_COUNTRY'</span>])</span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'DEPARTURE_ZIPCODE_encoded'</span>] <span class="op">=</span> <span class="va">self</span>.le_dep_zip.fit_transform(df[<span class="st">'DEPARTURE_ZIPCODE'</span>])</span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ARRIVAL_ZIPCODE_encoded'</span>] <span class="op">=</span> <span class="va">self</span>.le_arr_zip.fit_transform(df[<span class="st">'ARRIVAL_ZIPCODE'</span>])</span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store unique values</span></span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.unique_values <span class="op">=</span> {</span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a>            <span class="st">'service_types'</span>: df[<span class="st">'SERVICETYPE'</span>].unique(),</span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a>            <span class="st">'vehicle_types'</span>: df[<span class="st">'VEHICLETYPE'</span>].unique(),</span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a>            <span class="st">'departure_countries'</span>: df[<span class="st">'DEPARTURE_COUNTRY'</span>].unique(),</span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a>            <span class="st">'arrival_countries'</span>: df[<span class="st">'ARRIVAL_COUNTRY'</span>].unique(),</span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a>            <span class="st">'departure_zipcodes'</span>: df[<span class="st">'DEPARTURE_ZIPCODE'</span>].unique(),</span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a>            <span class="st">'arrival_zipcodes'</span>: df[<span class="st">'ARRIVAL_ZIPCODE'</span>].unique()</span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare features</span></span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> [</span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a>            <span class="st">'SERVICETYPE_encoded'</span>, <span class="st">'VEHICLETYPE_encoded'</span>, </span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a>            <span class="st">'DEPARTURE_COUNTRY_encoded'</span>, <span class="st">'ARRIVAL_COUNTRY_encoded'</span>,</span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a>            <span class="st">'DEPARTURE_ZIPCODE_encoded'</span>, <span class="st">'ARRIVAL_ZIPCODE_encoded'</span>, </span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a>            <span class="st">'WDAY'</span>, <span class="st">'SAME_COUNTRY'</span></span>
<span id="cb53-91"><a href="#cb53-91" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb53-92"><a href="#cb53-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-93"><a href="#cb53-93" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add DISTANCE_ENCODED</span></span>
<span id="cb53-94"><a href="#cb53-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'DECLARED_DISTANCE_KM'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb53-95"><a href="#cb53-95" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'DISTANCE_ENCODED'</span>] <span class="op">=</span> <span class="va">self</span>.scaler.fit_transform(df[[<span class="st">'DECLARED_DISTANCE_KM'</span>]])</span>
<span id="cb53-96"><a href="#cb53-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb53-97"><a href="#cb53-97" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'DISTANCE_ENCODED'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb53-98"><a href="#cb53-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-99"><a href="#cb53-99" aria-hidden="true" tabindex="-1"></a>        features.append(<span class="st">'DISTANCE_ENCODED'</span>)</span>
<span id="cb53-100"><a href="#cb53-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-101"><a href="#cb53-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare X with imputation</span></span>
<span id="cb53-102"><a href="#cb53-102" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> df[features].values</span>
<span id="cb53-103"><a href="#cb53-103" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> <span class="va">self</span>.imputer.fit_transform(X)  <span class="co"># Impute missing values</span></span>
<span id="cb53-104"><a href="#cb53-104" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> <span class="va">self</span>.scaler.fit_transform(X)</span>
<span id="cb53-105"><a href="#cb53-105" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-106"><a href="#cb53-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> X, df</span>
<span id="cb53-107"><a href="#cb53-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-108"><a href="#cb53-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> train(<span class="va">self</span>, data_path):</span>
<span id="cb53-109"><a href="#cb53-109" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb53-110"><a href="#cb53-110" aria-hidden="true" tabindex="-1"></a><span class="co">        Trains the distance and time prediction models using historical delivery data.</span></span>
<span id="cb53-111"><a href="#cb53-111" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb53-112"><a href="#cb53-112" aria-hidden="true" tabindex="-1"></a><span class="co">        args:</span></span>
<span id="cb53-113"><a href="#cb53-113" aria-hidden="true" tabindex="-1"></a><span class="co">        data_path (str): Path to the CSV file containing training data</span></span>
<span id="cb53-114"><a href="#cb53-114" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb53-115"><a href="#cb53-115" aria-hidden="true" tabindex="-1"></a><span class="co">        returns:</span></span>
<span id="cb53-116"><a href="#cb53-116" aria-hidden="true" tabindex="-1"></a><span class="co">        tuple: (dist_accuracy, time_accuracy) R-squared scores for distance and time models</span></span>
<span id="cb53-117"><a href="#cb53-117" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb53-118"><a href="#cb53-118" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load data</span></span>
<span id="cb53-119"><a href="#cb53-119" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.read_csv(data_path)</span>
<span id="cb53-120"><a href="#cb53-120" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-121"><a href="#cb53-121" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare features and targets</span></span>
<span id="cb53-122"><a href="#cb53-122" aria-hidden="true" tabindex="-1"></a>        X, df_cleaned <span class="op">=</span> <span class="va">self</span>.prepare_data(df)</span>
<span id="cb53-123"><a href="#cb53-123" aria-hidden="true" tabindex="-1"></a>        y_distance <span class="op">=</span> df_cleaned[<span class="st">'DECLARED_DISTANCE_KM'</span>].values</span>
<span id="cb53-124"><a href="#cb53-124" aria-hidden="true" tabindex="-1"></a>        y_time <span class="op">=</span> df_cleaned[<span class="st">'DELIVERY_TIME_HH'</span>].values</span>
<span id="cb53-125"><a href="#cb53-125" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-126"><a href="#cb53-126" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize delivery time</span></span>
<span id="cb53-127"><a href="#cb53-127" aria-hidden="true" tabindex="-1"></a>        y_time <span class="op">=</span> np.minimum(y_time, <span class="dv">72</span>)</span>
<span id="cb53-128"><a href="#cb53-128" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-129"><a href="#cb53-129" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Split data</span></span>
<span id="cb53-130"><a href="#cb53-130" aria-hidden="true" tabindex="-1"></a>        X_train, X_test, y_dist_train, y_dist_test, y_time_train, y_time_test <span class="op">=</span> train_test_split(</span>
<span id="cb53-131"><a href="#cb53-131" aria-hidden="true" tabindex="-1"></a>            X, y_distance, y_time, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb53-132"><a href="#cb53-132" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb53-133"><a href="#cb53-133" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-134"><a href="#cb53-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train models</span></span>
<span id="cb53-135"><a href="#cb53-135" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.distance_model.fit(X_train, y_dist_train)</span>
<span id="cb53-136"><a href="#cb53-136" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.time_model.fit(X_train, y_time_train)</span>
<span id="cb53-137"><a href="#cb53-137" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-138"><a href="#cb53-138" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate accuracy</span></span>
<span id="cb53-139"><a href="#cb53-139" aria-hidden="true" tabindex="-1"></a>        dist_accuracy <span class="op">=</span> r2_score(y_dist_test, <span class="va">self</span>.distance_model.predict(X_test))</span>
<span id="cb53-140"><a href="#cb53-140" aria-hidden="true" tabindex="-1"></a>        time_accuracy <span class="op">=</span> r2_score(y_time_test, <span class="va">self</span>.time_model.predict(X_test))</span>
<span id="cb53-141"><a href="#cb53-141" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-142"><a href="#cb53-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dist_accuracy, time_accuracy</span>
<span id="cb53-143"><a href="#cb53-143" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-144"><a href="#cb53-144" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> custom_round(<span class="va">self</span>, number):</span>
<span id="cb53-145"><a href="#cb53-145" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb53-146"><a href="#cb53-146" aria-hidden="true" tabindex="-1"></a><span class="co">        Rounds a number based on its decimal part (&gt;= 0.5 rounds up, &lt; 0.5 rounds down).</span></span>
<span id="cb53-147"><a href="#cb53-147" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb53-148"><a href="#cb53-148" aria-hidden="true" tabindex="-1"></a><span class="co">        args:</span></span>
<span id="cb53-149"><a href="#cb53-149" aria-hidden="true" tabindex="-1"></a><span class="co">        number (float): Number to be rounded</span></span>
<span id="cb53-150"><a href="#cb53-150" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb53-151"><a href="#cb53-151" aria-hidden="true" tabindex="-1"></a><span class="co">        returns:</span></span>
<span id="cb53-152"><a href="#cb53-152" aria-hidden="true" tabindex="-1"></a><span class="co">        float: Rounded number</span></span>
<span id="cb53-153"><a href="#cb53-153" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb53-154"><a href="#cb53-154" aria-hidden="true" tabindex="-1"></a>        decimal_part <span class="op">=</span> number <span class="op">%</span> <span class="dv">1</span></span>
<span id="cb53-155"><a href="#cb53-155" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> decimal_part <span class="op">&gt;=</span> <span class="fl">0.5</span>:</span>
<span id="cb53-156"><a href="#cb53-156" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.ceil(number)</span>
<span id="cb53-157"><a href="#cb53-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.floor(number)</span>
<span id="cb53-158"><a href="#cb53-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-159"><a href="#cb53-159" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, service_type, vehicle_type, departure_country, arrival_country,</span>
<span id="cb53-160"><a href="#cb53-160" aria-hidden="true" tabindex="-1"></a>                departure_zipcode, arrival_zipcode, departure_date):</span>
<span id="cb53-161"><a href="#cb53-161" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb53-162"><a href="#cb53-162" aria-hidden="true" tabindex="-1"></a><span class="co">        Predicts delivery distance, time, and arrival date for a given shipment.</span></span>
<span id="cb53-163"><a href="#cb53-163" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb53-164"><a href="#cb53-164" aria-hidden="true" tabindex="-1"></a><span class="co">        args:</span></span>
<span id="cb53-165"><a href="#cb53-165" aria-hidden="true" tabindex="-1"></a><span class="co">            service_type (str): Type of delivery service</span></span>
<span id="cb53-166"><a href="#cb53-166" aria-hidden="true" tabindex="-1"></a><span class="co">            vehicle_type (str): Type of vehicle used</span></span>
<span id="cb53-167"><a href="#cb53-167" aria-hidden="true" tabindex="-1"></a><span class="co">            departure_country (str): Country code of departure location</span></span>
<span id="cb53-168"><a href="#cb53-168" aria-hidden="true" tabindex="-1"></a><span class="co">            arrival_country (str): Country code of arrival location</span></span>
<span id="cb53-169"><a href="#cb53-169" aria-hidden="true" tabindex="-1"></a><span class="co">            departure_zipcode (str): ZIP code of departure location</span></span>
<span id="cb53-170"><a href="#cb53-170" aria-hidden="true" tabindex="-1"></a><span class="co">            arrival_zipcode (str): ZIP code of arrival location</span></span>
<span id="cb53-171"><a href="#cb53-171" aria-hidden="true" tabindex="-1"></a><span class="co">            departure_date (str): Departure date in 'YYYY-MM-DD' format</span></span>
<span id="cb53-172"><a href="#cb53-172" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb53-173"><a href="#cb53-173" aria-hidden="true" tabindex="-1"></a><span class="co">        returns:</span></span>
<span id="cb53-174"><a href="#cb53-174" aria-hidden="true" tabindex="-1"></a><span class="co">            dict: Prediction results including:</span></span>
<span id="cb53-175"><a href="#cb53-175" aria-hidden="true" tabindex="-1"></a><span class="co">                - predicted_distance_km (float)</span></span>
<span id="cb53-176"><a href="#cb53-176" aria-hidden="true" tabindex="-1"></a><span class="co">                - predicted_hours (int)</span></span>
<span id="cb53-177"><a href="#cb53-177" aria-hidden="true" tabindex="-1"></a><span class="co">                - total_work_hours (float)</span></span>
<span id="cb53-178"><a href="#cb53-178" aria-hidden="true" tabindex="-1"></a><span class="co">                - total_work_days (int)</span></span>
<span id="cb53-179"><a href="#cb53-179" aria-hidden="true" tabindex="-1"></a><span class="co">                - predicted_arrival_date (str)</span></span>
<span id="cb53-180"><a href="#cb53-180" aria-hidden="true" tabindex="-1"></a><span class="co">                - weekend_adjusted (bool)</span></span>
<span id="cb53-181"><a href="#cb53-181" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb53-182"><a href="#cb53-182" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert departure_date to weekday</span></span>
<span id="cb53-183"><a href="#cb53-183" aria-hidden="true" tabindex="-1"></a>        departure_dt <span class="op">=</span> datetime.strptime(departure_date, <span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb53-184"><a href="#cb53-184" aria-hidden="true" tabindex="-1"></a>        wday <span class="op">=</span> departure_dt.weekday()</span>
<span id="cb53-185"><a href="#cb53-185" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-186"><a href="#cb53-186" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert zip codes to strings with leading zeros</span></span>
<span id="cb53-187"><a href="#cb53-187" aria-hidden="true" tabindex="-1"></a>        departure_zipcode <span class="op">=</span> <span class="bu">str</span>(departure_zipcode).replace(<span class="st">'.0'</span>, <span class="st">''</span>).zfill(<span class="dv">5</span>)</span>
<span id="cb53-188"><a href="#cb53-188" aria-hidden="true" tabindex="-1"></a>        arrival_zipcode <span class="op">=</span> <span class="bu">str</span>(arrival_zipcode).replace(<span class="st">'.0'</span>, <span class="st">''</span>).zfill(<span class="dv">5</span>)</span>
<span id="cb53-189"><a href="#cb53-189" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-190"><a href="#cb53-190" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate same country feature</span></span>
<span id="cb53-191"><a href="#cb53-191" aria-hidden="true" tabindex="-1"></a>        same_country <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> departure_country <span class="op">==</span> arrival_country <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb53-192"><a href="#cb53-192" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-193"><a href="#cb53-193" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare input data</span></span>
<span id="cb53-194"><a href="#cb53-194" aria-hidden="true" tabindex="-1"></a>        input_data <span class="op">=</span> np.array([[</span>
<span id="cb53-195"><a href="#cb53-195" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.le_service.transform([service_type])[<span class="dv">0</span>],</span>
<span id="cb53-196"><a href="#cb53-196" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.le_vehicle.transform([vehicle_type])[<span class="dv">0</span>],</span>
<span id="cb53-197"><a href="#cb53-197" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.le_dep_country.transform([departure_country])[<span class="dv">0</span>],</span>
<span id="cb53-198"><a href="#cb53-198" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.le_arr_country.transform([arrival_country])[<span class="dv">0</span>],</span>
<span id="cb53-199"><a href="#cb53-199" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.le_dep_zip.transform([departure_zipcode])[<span class="dv">0</span>],</span>
<span id="cb53-200"><a href="#cb53-200" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.le_arr_zip.transform([arrival_zipcode])[<span class="dv">0</span>],</span>
<span id="cb53-201"><a href="#cb53-201" aria-hidden="true" tabindex="-1"></a>            wday,</span>
<span id="cb53-202"><a href="#cb53-202" aria-hidden="true" tabindex="-1"></a>            same_country,</span>
<span id="cb53-203"><a href="#cb53-203" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span>  <span class="co"># Default DISTANCE_ENCODED</span></span>
<span id="cb53-204"><a href="#cb53-204" aria-hidden="true" tabindex="-1"></a>        ]])</span>
<span id="cb53-205"><a href="#cb53-205" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-206"><a href="#cb53-206" aria-hidden="true" tabindex="-1"></a>        input_scaled <span class="op">=</span> <span class="va">self</span>.scaler.transform(input_data)</span>
<span id="cb53-207"><a href="#cb53-207" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-208"><a href="#cb53-208" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Make predictions</span></span>
<span id="cb53-209"><a href="#cb53-209" aria-hidden="true" tabindex="-1"></a>        predicted_distance <span class="op">=</span> <span class="va">self</span>.distance_model.predict(input_scaled)[<span class="dv">0</span>]</span>
<span id="cb53-210"><a href="#cb53-210" aria-hidden="true" tabindex="-1"></a>        model_predicted_hours <span class="op">=</span> <span class="va">self</span>.time_model.predict(input_scaled)[<span class="dv">0</span>]</span>
<span id="cb53-211"><a href="#cb53-211" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-212"><a href="#cb53-212" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limit predicted hours from model</span></span>
<span id="cb53-213"><a href="#cb53-213" aria-hidden="true" tabindex="-1"></a>        model_predicted_hours <span class="op">=</span> <span class="bu">min</span>(model_predicted_hours, <span class="dv">72</span>)</span>
<span id="cb53-214"><a href="#cb53-214" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply custom rounding to model_predicted_hours</span></span>
<span id="cb53-215"><a href="#cb53-215" aria-hidden="true" tabindex="-1"></a>        model_predicted_hours <span class="op">=</span> <span class="va">self</span>.custom_round(model_predicted_hours)</span>
<span id="cb53-216"><a href="#cb53-216" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-217"><a href="#cb53-217" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate workdays and arrival date based on model_predicted_hours</span></span>
<span id="cb53-218"><a href="#cb53-218" aria-hidden="true" tabindex="-1"></a>        work_hours_per_day <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb53-219"><a href="#cb53-219" aria-hidden="true" tabindex="-1"></a>        total_workdays <span class="op">=</span> <span class="bu">int</span>(np.ceil(model_predicted_hours <span class="op">/</span> work_hours_per_day))</span>
<span id="cb53-220"><a href="#cb53-220" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-221"><a href="#cb53-221" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate arrival date considering weekends</span></span>
<span id="cb53-222"><a href="#cb53-222" aria-hidden="true" tabindex="-1"></a>        arrival_date <span class="op">=</span> departure_dt</span>
<span id="cb53-223"><a href="#cb53-223" aria-hidden="true" tabindex="-1"></a>        actual_workdays <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb53-224"><a href="#cb53-224" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-225"><a href="#cb53-225" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> actual_workdays <span class="op">&lt;</span> total_workdays:</span>
<span id="cb53-226"><a href="#cb53-226" aria-hidden="true" tabindex="-1"></a>            arrival_date <span class="op">+=</span> timedelta(days<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb53-227"><a href="#cb53-227" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Only count weekdays</span></span>
<span id="cb53-228"><a href="#cb53-228" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> arrival_date.weekday() <span class="op">&lt;</span> <span class="dv">7</span>:  <span class="co"># Monday = 0, Friday = 4</span></span>
<span id="cb53-229"><a href="#cb53-229" aria-hidden="true" tabindex="-1"></a>                actual_workdays <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb53-230"><a href="#cb53-230" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-231"><a href="#cb53-231" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Adjust arrival date for weekend only for non-E-commerce services</span></span>
<span id="cb53-232"><a href="#cb53-232" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> service_type <span class="kw">not</span> <span class="kw">in</span> [<span class="st">"E-commerce"</span>, <span class="st">"E-commerce resi"</span>]:</span>
<span id="cb53-233"><a href="#cb53-233" aria-hidden="true" tabindex="-1"></a>            arrival_weekday <span class="op">=</span> arrival_date.weekday()</span>
<span id="cb53-234"><a href="#cb53-234" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> arrival_weekday <span class="op">==</span> <span class="dv">5</span>:  <span class="co"># Saturday</span></span>
<span id="cb53-235"><a href="#cb53-235" aria-hidden="true" tabindex="-1"></a>                arrival_date <span class="op">+=</span> timedelta(days<span class="op">=</span><span class="dv">2</span>)  <span class="co"># Move to Monday</span></span>
<span id="cb53-236"><a href="#cb53-236" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> arrival_weekday <span class="op">==</span> <span class="dv">6</span>:  <span class="co"># Sunday</span></span>
<span id="cb53-237"><a href="#cb53-237" aria-hidden="true" tabindex="-1"></a>                arrival_date <span class="op">+=</span> timedelta(days<span class="op">=</span><span class="dv">1</span>)  <span class="co"># Move to Monday</span></span>
<span id="cb53-238"><a href="#cb53-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-239"><a href="#cb53-239" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate actual hours between dates</span></span>
<span id="cb53-240"><a href="#cb53-240" aria-hidden="true" tabindex="-1"></a>        total_days <span class="op">=</span> (arrival_date <span class="op">-</span> departure_dt).days</span>
<span id="cb53-241"><a href="#cb53-241" aria-hidden="true" tabindex="-1"></a>        predicted_hours <span class="op">=</span> total_days <span class="op">*</span> <span class="dv">24</span>  <span class="co"># Convert days to hours</span></span>
<span id="cb53-242"><a href="#cb53-242" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-243"><a href="#cb53-243" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb53-244"><a href="#cb53-244" aria-hidden="true" tabindex="-1"></a>            <span class="st">'predicted_distance_km'</span>: <span class="bu">round</span>(predicted_distance, <span class="dv">2</span>),</span>
<span id="cb53-245"><a href="#cb53-245" aria-hidden="true" tabindex="-1"></a>            <span class="st">'predicted_hours'</span>: predicted_hours,</span>
<span id="cb53-246"><a href="#cb53-246" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_work_hours'</span>: model_predicted_hours,  <span class="co"># Using the rounded model prediction</span></span>
<span id="cb53-247"><a href="#cb53-247" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_work_days'</span>: total_workdays,</span>
<span id="cb53-248"><a href="#cb53-248" aria-hidden="true" tabindex="-1"></a>            <span class="st">'predicted_arrival_date'</span>: arrival_date.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>),</span>
<span id="cb53-249"><a href="#cb53-249" aria-hidden="true" tabindex="-1"></a>            <span class="st">'weekend_adjusted'</span>: arrival_date.weekday() <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> departure_dt.weekday() <span class="op">&lt;</span> <span class="dv">5</span></span>
<span id="cb53-250"><a href="#cb53-250" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb53-251"><a href="#cb53-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-252"><a href="#cb53-252" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb53-253"><a href="#cb53-253" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb53-254"><a href="#cb53-254" aria-hidden="true" tabindex="-1"></a><span class="co">    Main function to demonstrate the usage of DeliveryPredictor class.</span></span>
<span id="cb53-255"><a href="#cb53-255" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb53-256"><a href="#cb53-256" aria-hidden="true" tabindex="-1"></a>    predictor <span class="op">=</span> DeliveryPredictor()</span>
<span id="cb53-257"><a href="#cb53-257" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training</span></span>
<span id="cb53-258"><a href="#cb53-258" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb53-259"><a href="#cb53-259" aria-hidden="true" tabindex="-1"></a>        dist_acc, time_acc <span class="op">=</span> predictor.train(<span class="st">"final_delivery_data.csv"</span>)</span>
<span id="cb53-260"><a href="#cb53-260" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Distance model accuracy: </span><span class="sc">{</span>dist_acc<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb53-261"><a href="#cb53-261" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Time model accuracy: </span><span class="sc">{</span>time_acc<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb53-262"><a href="#cb53-262" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-263"><a href="#cb53-263" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Example prediction</span></span>
<span id="cb53-264"><a href="#cb53-264" aria-hidden="true" tabindex="-1"></a>        prediction <span class="op">=</span> predictor.predict(</span>
<span id="cb53-265"><a href="#cb53-265" aria-hidden="true" tabindex="-1"></a>            service_type<span class="op">=</span><span class="st">"Corriere espresso"</span>,</span>
<span id="cb53-266"><a href="#cb53-266" aria-hidden="true" tabindex="-1"></a>            vehicle_type<span class="op">=</span><span class="st">"Express"</span>,</span>
<span id="cb53-267"><a href="#cb53-267" aria-hidden="true" tabindex="-1"></a>            departure_country<span class="op">=</span><span class="st">"IT"</span>,</span>
<span id="cb53-268"><a href="#cb53-268" aria-hidden="true" tabindex="-1"></a>            arrival_country<span class="op">=</span><span class="st">"IT"</span>,</span>
<span id="cb53-269"><a href="#cb53-269" aria-hidden="true" tabindex="-1"></a>            departure_zipcode<span class="op">=</span><span class="st">"62010"</span>,</span>
<span id="cb53-270"><a href="#cb53-270" aria-hidden="true" tabindex="-1"></a>            arrival_zipcode<span class="op">=</span><span class="st">"22100"</span>,</span>
<span id="cb53-271"><a href="#cb53-271" aria-hidden="true" tabindex="-1"></a>            departure_date<span class="op">=</span><span class="st">"2023-01-10"</span></span>
<span id="cb53-272"><a href="#cb53-272" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb53-273"><a href="#cb53-273" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-274"><a href="#cb53-274" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Prediction:"</span>)</span>
<span id="cb53-275"><a href="#cb53-275" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> prediction.items():</span>
<span id="cb53-276"><a href="#cb53-276" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>key<span class="sc">.</span>replace(<span class="st">'_'</span>, <span class="st">' '</span>)<span class="sc">.</span>title()<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-277"><a href="#cb53-277" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-278"><a href="#cb53-278" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb53-279"><a href="#cb53-279" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Error: 'final_delivery_data.csv' not found. Please ensure the data file exists."</span>)</span>
<span id="cb53-280"><a href="#cb53-280" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb53-281"><a href="#cb53-281" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"An error occurred: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-282"><a href="#cb53-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-283"><a href="#cb53-283" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb53-284"><a href="#cb53-284" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Distance model accuracy: 100.00%
Time model accuracy: 55.95%

Prediction:
Predicted Distance Km: 427.3
Predicted Hours: 144
Total Work Hours: 31.0
Total Work Days: 4
Predicted Arrival Date: 2023-01-16
Weekend Adjusted: True</code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>